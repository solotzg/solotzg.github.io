<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"solotzg.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"manual","top_n_per_article":5,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="What good can using exceptions do for me? The basic answer is: Using exceptions for error handling makes your code simpler, cleaner, and less likely to miss errors. But what’s wrong with “good old er">
<meta property="og:type" content="article">
<meta property="og:title" content="浅析 C++ 异常机制">
<meta property="og:url" content="https://solotzg.github.io/2023/09/04/system/cpp-exception/index.html">
<meta property="og:site_name" content="SOLOTZG">
<meta property="og:description" content="What good can using exceptions do for me? The basic answer is: Using exceptions for error handling makes your code simpler, cleaner, and less likely to miss errors. But what’s wrong with “good old er">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://solotzg.github.io/images/call-stack-layout.svg">
<meta property="article:published_time" content="2023-09-04T05:00:00.000Z">
<meta property="article:modified_time" content="2023-10-16T14:54:33.958Z">
<meta property="article:author" content="TONG, Zhigao">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Exception">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://solotzg.github.io/images/call-stack-layout.svg">


<link rel="canonical" href="https://solotzg.github.io/2023/09/04/system/cpp-exception/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://solotzg.github.io/2023/09/04/system/cpp-exception/","path":"2023/09/04/system/cpp-exception/","title":"浅析 C++ 异常机制"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>浅析 C++ 异常机制 | SOLOTZG</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">SOLOTZG</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Stack-Unwinding"><span class="nav-number">1.</span> <span class="nav-text">Stack Unwinding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frame-Pointer-%E6%A0%88%E5%9B%9E%E6%BA%AF"><span class="nav-number">2.</span> <span class="nav-text">Frame Pointer 栈回溯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#test1"><span class="nav-number">2.1.</span> <span class="nav-text">test1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#test1-%E5%88%86%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">test1 分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frame-Pointer-%E6%A0%88%E5%9B%9E%E6%BA%AF%E7%BC%BA%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-number">2.3.</span> <span class="nav-text">Frame Pointer 栈回溯缺点总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DWARF%EF%BC%88Debugging-With-Arbitrary-Record-Formats%EF%BC%89"><span class="nav-number">3.</span> <span class="nav-text">DWARF（Debugging With Arbitrary Record Formats）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exception-Handling-Frame"><span class="nav-number">4.</span> <span class="nav-text">Exception Handling Frame</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CFI-Directive-%E6%8C%87%E4%BB%A4"><span class="nav-number">4.1.</span> <span class="nav-text">CFI Directive 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#eh-frame-%E6%AE%B5"><span class="nav-number">4.2.</span> <span class="nav-text">.eh_frame 段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#test1-%E8%B0%83%E7%94%A8%E5%B8%A7%E5%88%86%E6%9E%90"><span class="nav-number">4.3.</span> <span class="nav-text">test1 调用帧分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libunwind-Stack-Unwinding"><span class="nav-number">5.</span> <span class="nav-text">libunwind Stack Unwinding</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#test2"><span class="nav-number">5.1.</span> <span class="nav-text">test2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-Exception-Handling"><span class="nav-number">6.</span> <span class="nav-text">C++ Exception Handling</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#test4"><span class="nav-number">6.1.</span> <span class="nav-text">test4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#test4-%E5%88%86%E6%9E%90"><span class="nav-number">6.2.</span> <span class="nav-text">test4 分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%BC%82%E5%B8%B8%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-number">7.</span> <span class="nav-text">C++ 异常的影响</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E8%AF%AD%E8%A8%80%E5%BC%82%E5%B8%B8"><span class="nav-number">8.</span> <span class="nav-text">C 语言异常</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%BC%82%E5%B8%B8%E6%80%BB%E7%BB%93"><span class="nav-number">9.</span> <span class="nav-text">C++ 异常总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">10.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80"><span class="nav-number">10.1.</span> <span class="nav-text">汇编基础</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#x86-64-calling-conventions"><span class="nav-number">10.2.</span> <span class="nav-text">x86_64 calling conventions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-number">10.3.</span> <span class="nav-text">Reference</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="TONG, Zhigao"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">TONG, Zhigao</p>
  <div class="site-description" itemprop="description">Blogs</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/solotzg" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;solotzg" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:solotzg@gmail.com" title="E-Mail → mailto:solotzg@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://solotzg.github.io/2023/09/04/system/cpp-exception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="TONG, Zhigao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SOLOTZG">
      <meta itemprop="description" content="Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="浅析 C++ 异常机制 | SOLOTZG">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          浅析 C++ 异常机制
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-04 13:00:00" itemprop="dateCreated datePublished" datetime="2023-09-04T13:00:00+08:00">2023-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-16 22:54:33" itemprop="dateModified" datetime="2023-10-16T22:54:33+08:00">2023-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/System/" itemprop="url" rel="index"><span itemprop="name">System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>What good can using exceptions do for me? The basic answer is: Using exceptions for error handling makes your code simpler, cleaner, and less likely to miss errors. But what’s wrong with “good old errno and if-statements”? The basic answer is: Using those, your error handling and your normal code are closely intertwined. That way, your code gets messy and it becomes hard to ensure that you have dealt with all errors.</p>
</blockquote>
<p>由于 C++ 异常机制复杂的特性，编写异常安全的代码不是件轻松的事情。异常增强了语言的表达能力，但也带来了不可避免的开销。本文简单分析了 C++ 异常机制的实现原理，并总结相关注意事项。</p>
<span id="more"></span>

<h2 id="Stack-Unwinding"><a href="#Stack-Unwinding" class="headerlink" title="Stack Unwinding"></a>Stack Unwinding</h2><p><img src="/images/call-stack-layout.svg" alt="call-stack-layout"></p>
<p>计算机程序的 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Call_stack">Call Stack</a>（调用栈） 由多层 <code>Stack Frame</code>（栈帧）组成。每个栈帧对应一个正在进行的子程序（函数）调用过程，子程序返回时，则弹出栈帧。图中简单展示了一个调用栈的布局：栈的方向为自底向上；程序 DrawSquare 调用子程序 DrawLine；</p>
<p>在 <code>x86_64</code> 体系下，栈的方向为自顶向下，<code>Stack Pointer</code> 保存在 RSP 寄存器中，如果 C&#x2F;C++ 程序编译时保留函数的 <code>Frame Pointer</code>，则该数据保存在 RBP 寄存器中。参考<a href="#%E9%99%84%E5%BD%95">附录</a>，每当通过 <code>call</code> 指令进入被调函数时，RSP 中对应就是保存在栈上的 <code>Return Address</code>（返回地址，对应代码段），如果可以通过代码相关地址解析出栈帧布局，就可以逐层回溯整个调用栈。总体上而言，<code>Stack Unwinding</code> 泛指这种解析｜展开｜修改调用栈的行为。stack-unwinding 主要有以下作用：</p>
<ul>
<li>栈回溯（用于 debug，监控，perf，crash 报告 等场景）</li>
<li>异常机制</li>
</ul>
<h2 id="Frame-Pointer-栈回溯"><a href="#Frame-Pointer-栈回溯" class="headerlink" title="Frame Pointer 栈回溯"></a>Frame Pointer 栈回溯</h2><p>基于 frame-pointer 进行栈回溯是最简单通用的做法。需要占用一个寄存器专门存储 frame-pointer，并在栈帧上相对固定的位置存储相关数据，近似于把栈帧以链表的形式串联。<code>x86_64</code> 下，可以通过 frame-pointer 进行栈回溯的函数，其代码指令形如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">push %rbp</span><br><span class="line">mov %rsp, %rbp</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pop %rbp</span><br><span class="line">retq</span><br></pre></td></tr></table></figure>

<h3 id="test1"><a href="#test1" class="headerlink" title="test1"></a>test1</h3><p><code>backtrace()</code> 和 <code>backtrace_symbols()</code> 是 C++ 自带的栈回溯功能，其内部实现不完全依赖 frame-pointer。<code>__builtin_return_address(n)</code> 表示从当前函数回溯 n 层获取返回地址，实现上依赖 frame-pointer。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test1.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;execinfo.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NO_INLINE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NO_INLINE __attribute__((__noinline__))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> ULL = <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NO_INLINE <span class="type">void</span> <span class="title">dump_traceback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> size = <span class="number">200</span>;</span><br><span class="line">  <span class="type">void</span> *buffer[size];</span><br><span class="line">  <span class="type">int</span> nptrs = <span class="built_in">backtrace</span>(buffer, size);</span><br><span class="line">  <span class="type">char</span> **strings = <span class="built_in">backtrace_symbols</span>(buffer, nptrs);</span><br><span class="line">  <span class="keyword">if</span> (strings) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nptrs; ++i) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%d] %s\n&quot;</span>, i, strings[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(strings);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> level&gt; <span class="function">NO_INLINE <span class="type">void</span> *<span class="title">f3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">dump_traceback</span>();</span><br><span class="line">  <span class="keyword">return</span> __builtin_return_address(level);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> level&gt; <span class="function">NO_INLINE <span class="type">void</span> *<span class="title">f2</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">f3</span>&lt;level&gt;(); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> level&gt; <span class="function">NO_INLINE <span class="type">void</span> *<span class="title">f1</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">f2</span>&lt;level&gt;(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">f1</span>&lt;<span class="number">2</span>&gt;();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">f1</span>&lt;<span class="number">0</span>&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开启 <code>-O3</code> 级别编译优化项默认消除 frame-pointer，即 <code>-fomit-frame-pointer</code>（加上编译参数 <code>fno-omit-frame-pointer</code> 表示保留 frame-pointer）；关联符号名称 <code>-rdynamic</code>;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang test1.cpp -O3 -rdynamic &amp;&amp; ./a.out</span><br><span class="line"></span><br><span class="line">[0] ./a.out(_Z14dump_tracebackv+0x1e) [0x55ccb5c1218e]</span><br><span class="line">[1] ./a.out(_Z2f3ILi0EEPvv+0x6) [0x55ccb5c12276]</span><br><span class="line">[2] ./a.out(main+0x14) [0x55ccb5c12204]</span><br><span class="line">[3] /usr/lib64/libc.so.6(+0x3feb0) [0x7f29f083feb0]</span><br><span class="line">[4] /usr/lib64/libc.so.6(__libc_start_main+0x80) [0x7f29f083ff60]</span><br><span class="line">[5] ./a.out(_start+0x25) [0x55ccb5c120a5]</span><br></pre></td></tr></table></figure>

<p>消除 frame-pointer 后，仍然可以用 backtrace 获取当前线程的调用堆栈信息，但是却无法通过内置函数 <code>__builtin_return_address(2)</code> 获取第 2 层调用栈（理论上应是 main 函数代码相关部分）信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang test1.cpp -O3 -rdynamic &amp;&amp; ./a.out l2</span><br><span class="line"></span><br><span class="line">[0] ./a.out(_Z14dump_tracebackv+0x1e) [0x56397028f18e]</span><br><span class="line">[1] ./a.out(_Z2f3ILi2EEPvv+0x9) [0x56397028f249]</span><br><span class="line">[2] ./a.out(main+0xb) [0x56397028f1fb]</span><br><span class="line">[3] /usr/lib64/libc.so.6(+0x3feb0) [0x7f552de3feb0]</span><br><span class="line">[4] /usr/lib64/libc.so.6(__libc_start_main+0x80) [0x7f552de3ff60]</span><br><span class="line">[5] ./a.out(_start+0x25) [0x56397028f0a5]</span><br><span class="line">[1]    2757999 segmentation fault (core dumped)  ./a.out l2</span><br></pre></td></tr></table></figure>

<h3 id="test1-分析"><a href="#test1-分析" class="headerlink" title="test1 分析"></a>test1 分析</h3><p>导出反汇编结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang test1.cpp -O3 -rdynamic &amp;&amp; objdump -C -r -d a.out</span><br><span class="line"></span><br><span class="line">0000000000001080 &lt;_start&gt;:</span><br><span class="line">    1080:       f3 0f 1e fa             endbr64 </span><br><span class="line">    1084:       31 ed                   xor    %ebp,%ebp</span><br><span class="line">    1086:       49 89 d1                mov    %rdx,%r9</span><br><span class="line">    1089:       5e                      pop    %rsi</span><br><span class="line">    108a:       48 89 e2                mov    %rsp,%rdx</span><br><span class="line">    108d:       48 83 e4 f0             and    <span class="variable">$0xfffffffffffffff0</span>,%rsp</span><br><span class="line">    1091:       50                      push   %rax</span><br><span class="line">    1092:       54                      push   %rsp</span><br><span class="line">    1093:       45 31 c0                xor    %r8d,%r8d</span><br><span class="line">    1096:       31 c9                   xor    %ecx,%ecx</span><br><span class="line">    1098:       48 8d 3d 51 01 00 00    lea    0x151(%rip),%rdi        <span class="comment"># 11f0 &lt;main&gt;</span></span><br><span class="line">    109f:       ff 15 33 2f 00 00       callq  *0x2f33(%rip)        <span class="comment"># 3fd8 &lt;__libc_start_main@GLIBC_2.34&gt;</span></span><br><span class="line">    10a5:       f4                      hlt    </span><br><span class="line"></span><br><span class="line">0000000000001170 &lt;dump_traceback()&gt;:</span><br><span class="line">    1170: 41 57                 push   %r15</span><br><span class="line">    1172: 41 56                 push   %r14</span><br><span class="line">    1174: 41 54                 push   %r12</span><br><span class="line">    1176: 53                    push   %rbx</span><br><span class="line">    1177: 48 81 ec 48 06 00 00  sub    <span class="variable">$0x648</span>,%rsp</span><br><span class="line">    117e: 49 89 e6              mov    %rsp,%r14</span><br><span class="line">    1181: 4c 89 f7              mov    %r14,%rdi</span><br><span class="line">    1184: be c8 00 00 00        mov    <span class="variable">$0xc8</span>,%esi</span><br><span class="line">    1189: e8 c2 fe ff ff        callq  1050 &lt;backtrace@plt&gt;</span><br><span class="line">    118e: 89 c3                 mov    %eax,%ebx</span><br><span class="line">    1190: 4c 89 f7              mov    %r14,%rdi</span><br><span class="line">    1193: 89 c6                 mov    %eax,%esi</span><br><span class="line">    1195: e8 a6 fe ff ff        callq  1040 &lt;backtrace_symbols@plt&gt;</span><br><span class="line">    119a: 48 85 c0              <span class="built_in">test</span>   %rax,%rax</span><br><span class="line">    119d: 74 41                 je     11e0 &lt;dump_traceback()+0x70&gt;</span><br><span class="line">    119f: 49 89 c7              mov    %rax,%r15</span><br><span class="line">    11a2: 85 db                 <span class="built_in">test</span>   %ebx,%ebx</span><br><span class="line">    11a4: 7e 32                 jle    11d8 &lt;dump_traceback()+0x68&gt;</span><br><span class="line">    11a6: 41 89 dc              mov    %ebx,%r12d</span><br><span class="line">    11a9: 4c 8d 35 54 0e 00 00  lea    0xe54(%rip),%r14        <span class="comment"># 2004 &lt;_IO_stdin_used+0x4&gt;</span></span><br><span class="line">    11b0: 31 db                 xor    %ebx,%ebx</span><br><span class="line">    11b2: 66 66 66 66 66 2e 0f  data16 data16 data16 data16 nopw %cs:0x0(%rax,%rax,1)</span><br><span class="line">    11b9: 1f 84 00 00 00 00 00 </span><br><span class="line">    11c0: 49 8b 14 <span class="built_in">df</span>           mov    (%r15,%rbx,8),%rdx</span><br><span class="line">    11c4: 4c 89 f7              mov    %r14,%rdi</span><br><span class="line">    11c7: 89 de                 mov    %ebx,%esi</span><br><span class="line">    11c9: 31 c0                 xor    %eax,%eax</span><br><span class="line">    11cb: e8 90 fe ff ff        callq  1060 &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">    11d0: 48 ff c3              inc    %rbx</span><br><span class="line">    11d3: 49 39 dc              cmp    %rbx,%r12</span><br><span class="line">    11d6: 75 e8                 jne    11c0 &lt;dump_traceback()+0x50&gt;</span><br><span class="line">    11d8: 4c 89 ff              mov    %r15,%rdi</span><br><span class="line">    11db: e8 50 fe ff ff        callq  1030 &lt;free@plt&gt;</span><br><span class="line">    11e0: 48 81 c4 48 06 00 00  add    <span class="variable">$0x648</span>,%rsp</span><br><span class="line">    11e7: 5b                    pop    %rbx</span><br><span class="line">    11e8: 41 5c                 pop    %r12</span><br><span class="line">    11ea: 41 5e                 pop    %r14</span><br><span class="line">    11ec: 41 5f                 pop    %r15</span><br><span class="line">    11ee: c3                    retq   </span><br><span class="line">    11ef: 90                    nop</span><br><span class="line"></span><br><span class="line">00000000000011f0 &lt;main&gt;:</span><br><span class="line">    11f0:       50                      push   %rax</span><br><span class="line">    11f1:       83 ff 02                cmp    <span class="variable">$0x2</span>,%edi</span><br><span class="line">    11f4:       7c 09                   jl     11ff &lt;main+0xf&gt;</span><br><span class="line">    11f6:       e8 15 00 00 00          callq  1210 &lt;void* f1&lt;2&gt;()&gt;</span><br><span class="line">    11fb:       31 c0                   xor    %eax,%eax</span><br><span class="line">    11fd:       59                      pop    %rcx</span><br><span class="line">    11fe:       c3                      retq   </span><br><span class="line">    11ff:       e8 1c 00 00 00          callq  1220 &lt;void* f1&lt;0&gt;()&gt;</span><br><span class="line">    1204:       31 c0                   xor    %eax,%eax</span><br><span class="line">    1206:       59                      pop    %rcx</span><br><span class="line">    1207:       c3                      retq   </span><br><span class="line">    1208:       0f 1f 84 00 00 00 00    nopl   0x0(%rax,%rax,1)</span><br><span class="line">    120f:       00 </span><br><span class="line"></span><br><span class="line">0000000000001210 &lt;void* f1&lt;2&gt;()&gt;:</span><br><span class="line">    1210: e9 1b 00 00 00        jmpq   1230 &lt;void* f2&lt;2&gt;()&gt;</span><br><span class="line">    1215: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">    121c: 00 00 00 </span><br><span class="line">    121f: 90                    nop</span><br><span class="line"></span><br><span class="line">0000000000001220 &lt;void* f1&lt;0&gt;()&gt;:</span><br><span class="line">    1220: e9 3b 00 00 00        jmpq   1260 &lt;void* f2&lt;0&gt;()&gt;</span><br><span class="line">    1225: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">    122c: 00 00 00 </span><br><span class="line">    122f: 90                    nop</span><br><span class="line"></span><br><span class="line">0000000000001230 &lt;void* f2&lt;2&gt;()&gt;:</span><br><span class="line">    1230: e9 0b 00 00 00        jmpq   1240 &lt;void* f3&lt;2&gt;()&gt;</span><br><span class="line">    1235: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">    123c: 00 00 00 </span><br><span class="line">    123f: 90                    nop</span><br><span class="line"></span><br><span class="line">0000000000001240 &lt;void* f3&lt;2&gt;()&gt;:</span><br><span class="line">    1240: 55                    push   %rbp</span><br><span class="line">    1241: 48 89 e5              mov    %rsp,%rbp</span><br><span class="line">    1244: e8 27 ff ff ff        callq  1170 &lt;dump_traceback()&gt;</span><br><span class="line">    1249: 48 8b 45 00           mov    0x0(%rbp),%rax</span><br><span class="line">    124d: 48 8b 00              mov    (%rax),%rax</span><br><span class="line">    1250: 48 8b 40 08           mov    0x8(%rax),%rax</span><br><span class="line">    1254: 5d                    pop    %rbp</span><br><span class="line">    1255: c3                    retq   </span><br><span class="line">    1256: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">    125d: 00 00 00 </span><br><span class="line"></span><br><span class="line">0000000000001260 &lt;void* f2&lt;0&gt;()&gt;:</span><br><span class="line">    1260: e9 0b 00 00 00        jmpq   1270 &lt;void* f3&lt;0&gt;()&gt;</span><br><span class="line">    1265: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">    126c: 00 00 00 </span><br><span class="line">    126f: 90                    nop</span><br><span class="line"></span><br><span class="line">0000000000001270 &lt;void* f3&lt;0&gt;()&gt;:</span><br><span class="line">    1270: 50                    push   %rax</span><br><span class="line">    1271: e8 fa fe ff ff        callq  1170 &lt;dump_traceback()&gt;</span><br><span class="line">    1276: 48 8b 44 24 08        mov    0x8(%rsp),%rax</span><br><span class="line">    127b: 59                    pop    %rcx</span><br><span class="line">    127c: c3                    retq     </span><br></pre></td></tr></table></figure>

<p>参考 <a href="#%E9%99%84%E5%BD%95">附录</a> 解析以上代码</p>
<p><code>0000000000001270 &lt;void* f3&lt;0&gt;()&gt;:</code></p>
<ul>
<li><code>0x0(%rsp)</code> 是返回地址</li>
<li><code>push %rax</code> 后，返回地址为 <code>0x8(%rsp)</code></li>
<li><code>mov  0x8(%rsp),%rax</code> 获取返回地址</li>
</ul>
<p><code>0000000000001240 &lt;void* f3&lt;2&gt;()&gt;:</code></p>
<ul>
<li>执行完 <code>push %rbp</code> 和 <code>mov %rsp,%rbp</code> 后<ul>
<li><code>%rsp</code> 是当前栈顶地址</li>
<li><code>%rbp</code> 是当前栈基地址</li>
<li><code>0x0(%rbp)</code> 是上个栈基地址，即栈基地址+0x0</li>
<li><code>0x8(%rbp)</code> 是返回地址，即栈基地址+0x8</li>
</ul>
</li>
<li><code>mov  0x0(%rbp),%rax</code> 获取上个栈基地址</li>
<li><code>mov  (%rax),%rax</code> 获取上上个栈基地址<ul>
<li>根据层数，逐步解析出栈基地址</li>
</ul>
</li>
<li><code>mov  0x8(%rax),%rax</code> 获取最终返回地址</li>
</ul>
<p><code>__builtin_return_address(0)</code> 不依赖 rbp，可以正常工作</p>
<p><code>__builtin_return_address(?)</code> 函数调用存在几个明显缺点：</p>
<ul>
<li>当解析层数大于 0 时依赖 rbp 中数据，会忽略消除 frame-pointer 或尾递归优化后的函数调用，导致无法获取准确的返回地址</li>
<li>栈回溯时，除了 rsp 无法恢复其他寄存器</li>
<li>无法关联源代码</li>
</ul>
<h3 id="Frame-Pointer-栈回溯缺点总结"><a href="#Frame-Pointer-栈回溯缺点总结" class="headerlink" title="Frame Pointer 栈回溯缺点总结"></a>Frame Pointer 栈回溯缺点总结</h3><ul>
<li>强依赖于 frame-pointer，如果调用栈中有栈帧没有保存 frame-pointer，则会导致解析失败</li>
<li>独占一个寄存器存储 frame-pointer，可能导致性能下降</li>
</ul>
<h2 id="DWARF（Debugging-With-Arbitrary-Record-Formats）"><a href="#DWARF（Debugging-With-Arbitrary-Record-Formats）" class="headerlink" title="DWARF（Debugging With Arbitrary Record Formats）"></a>DWARF（Debugging With Arbitrary Record Formats）</h2><p>ref: <a target="_blank" rel="noopener" href="https://dwarfstd.org/">DWARF Debugging Standard</a></p>
<blockquote>
<p>DWARF is a debugging information file format used by many compilers and debuggers to support source level debugging. It addresses the requirements of a number of procedural languages, such as C, C++, and Fortran, and is designed to be extensible to other languages. DWARF is architecture independent and applicable to any processor or operating system. It is widely used on Unix, Linux and other operating systems, as well as in stand-alone environments.</p>
</blockquote>
<p><code>DWARF</code> 使用了独立的 <code>.debug_*</code> 段来解决依赖 frame-pointer 的问题，以 <code>CFI（Call Frame Information）</code> 描述调用栈帧信息（Linux 系统标准中的相关部分也衍生于此，详见下文）。这种方式的优点：</p>
<ul>
<li>栈回溯不依赖 rbp，可恢复其他寄存器数据</li>
<li>在 ELF 文件中附加段，无运行时性能开销<ul>
<li><code>.debug_frame</code> 段记录栈帧相关信息，其他部分细化拆分成诸如 <code>.debug_info</code>，<code>.debug_abbrev</code>，<code>.debug_line</code>，<code>.debug_str</code> 等段</li>
</ul>
</li>
</ul>
<h2 id="Exception-Handling-Frame"><a href="#Exception-Handling-Frame" class="headerlink" title="Exception Handling Frame"></a>Exception Handling Frame</h2><p>现代 Linux 系统标准 <a target="_blank" rel="noopener" href="https://refspecs.linuxfoundation.org/LSB_5.0.0/LSB-Core-generic/LSB-Core-generic/ehframechpt.html">LSB（Linux Standard Base）</a> 中指明：支持异常的语言（例如 C++），必须向运行时环境提供附加信息，以描述在异常处理期间必须展开的调用帧；该信息包含在特殊段 <code>.eh_frame</code> 和 <code>.eh_framehdr</code> 中；</p>
<p><code>.eh_frame</code> 基于 DWARF v2 版本的 <code>.debug_frame</code>，主要由 <code>CIE（Common Information Entry）</code> 和 <code>FDE（Frame Description Entry）</code> 组成。对于函数定义，编译器在汇编中嵌入 <a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/CFI-directives.html">CFI Directive</a> 相关指令，由汇编器解析生成 <code>.eh_frame</code> 或 <code>.debug_frame</code>。生成行为受编译参数影响如下：</p>
<table>
<thead>
<tr>
<th>编译参数</th>
<th>生成段</th>
</tr>
</thead>
<tbody><tr>
<td>-fasynchronous-unwind-tables -fexceptions</td>
<td>.eh_frame</td>
</tr>
<tr>
<td>-fno-asynchronous-unwind-tables -fexceptions</td>
<td>.eh_frame</td>
</tr>
<tr>
<td>-fasynchronous-unwind-tables -fno-exceptions</td>
<td>.eh_frame</td>
</tr>
<tr>
<td>-fno-asynchronous-unwind-tables -fno-exceptions [-g0 | none]</td>
<td>none</td>
</tr>
<tr>
<td>-fno-asynchronous-unwind-tables -fno-exceptions -g&lt;? gt 0&gt;</td>
<td>.debug_frame</td>
</tr>
</tbody></table>
<h3 id="CFI-Directive-指令"><a href="#CFI-Directive-指令" class="headerlink" title="CFI Directive 指令"></a>CFI Directive 指令</h3><p>基本介绍</p>
<ul>
<li>指令命名为 <code>.cfi_* ()</code></li>
<li><code>.cfi_startproc</code> 和 <code>.cfi_endproc</code> 标识 FDE 区域</li>
<li><code>.cfi_def_cfa_offset</code> 表示调用栈返回地址</li>
<li><code>.cfi_offset</code> 定义寄存器数据保存位置</li>
<li><code>.cfi_def_cfa_*</code> 定义 CFA 的计算规则</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">echo</span> <span class="string">&#x27;void test() &#123;__builtin_unwind_init();&#125;&#x27;</span> &gt; test3.cpp &amp;&amp; clang test3.cpp -S &amp;&amp; <span class="built_in">cat</span> test3.s</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line">        .file   <span class="string">&quot;test3.cpp&quot;</span></span><br><span class="line">        .globl  _Z4testv                        <span class="comment"># -- Begin function _Z4testv</span></span><br><span class="line">        .p2align        4, 0x90</span><br><span class="line">        .<span class="built_in">type</span>   _Z4testv,@<span class="keyword">function</span></span><br><span class="line">_Z4testv:                               <span class="comment"># @_Z4testv</span></span><br><span class="line">        .cfi_startproc</span><br><span class="line"><span class="comment"># %bb.0:</span></span><br><span class="line">        pushq   %rbp</span><br><span class="line">        .cfi_def_cfa_offset 16</span><br><span class="line">        .cfi_offset %rbp, -16</span><br><span class="line">        movq    %rsp, %rbp</span><br><span class="line">        .cfi_def_cfa_register %rbp</span><br><span class="line">        pushq   %r15</span><br><span class="line">        pushq   %r14</span><br><span class="line">        pushq   %r13</span><br><span class="line">        pushq   %r12</span><br><span class="line">        pushq   %rbx</span><br><span class="line">        .cfi_offset %rbx, -56</span><br><span class="line">        .cfi_offset %r12, -48</span><br><span class="line">        .cfi_offset %r13, -40</span><br><span class="line">        .cfi_offset %r14, -32</span><br><span class="line">        .cfi_offset %r15, -24</span><br><span class="line">        popq    %rbx</span><br><span class="line">        popq    %r12</span><br><span class="line">        popq    %r13</span><br><span class="line">        popq    %r14</span><br><span class="line">        popq    %r15</span><br><span class="line">        popq    %rbp</span><br><span class="line">        .cfi_def_cfa %rsp, 8</span><br><span class="line">        retq</span><br><span class="line">.Lfunc_end0:</span><br><span class="line">        .size   _Z4testv, .Lfunc_end0-_Z4testv</span><br><span class="line">        .cfi_endproc</span><br><span class="line">                                        <span class="comment"># -- End function</span></span><br><span class="line">        .ident  <span class="string">&quot;Debian clang version 15.0.7&quot;</span></span><br><span class="line">        .section        <span class="string">&quot;.note.GNU-stack&quot;</span>,<span class="string">&quot;&quot;</span>,@progbits</span><br><span class="line">        .addrsig</span><br></pre></td></tr></table></figure>

<h3 id="eh-frame-段"><a href="#eh-frame-段" class="headerlink" title=".eh_frame 段"></a><code>.eh_frame</code> 段</h3><p><code>.eh_frame</code> 在 x86 平台下的内容示例如下：</p>
<ul>
<li>每个 FDE 均有关联的 CIE</li>
<li>FDE 每个条目记载特定 PC 位置的 CFA，被调用者 <a href="#x86-64-calling-conventions">nonvolatile</a> 寄存器的保存位置和返回地址（ra）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Contents <span class="keyword">of</span> the .eh_frame section:</span><br><span class="line"></span><br><span class="line">（FDE 偏移量） （FDE 长度）       （FDE 所属的 CIE）          （FDE 对应函数的起始 PC 和结束 PC）</span><br><span class="line"><span class="number">00000030</span>      <span class="number">0000000000000024</span> <span class="number">00000034</span> FDE cie<span class="operator">=</span><span class="number">00000000</span> pc<span class="operator">=</span><span class="number">0000000000001020.</span><span class="number">.0000000000001080</span></span><br><span class="line"></span><br><span class="line">  （PC 位置）    （上一级  （被调用者非易失性       （返回地址的位置）</span><br><span class="line">                调用者的   寄存器保存的位置）</span><br><span class="line">                栈顶地址）</span><br><span class="line">   LOC           CFA      rbx   r12   r14   r15   ra    </span><br><span class="line"><span class="number">0000000000001170</span> rsp<span class="operator">+</span><span class="number">8</span>    u     u     u     u     c<span class="number">-8</span>   </span><br><span class="line"><span class="number">000000000000117</span>e rsp<span class="operator">+</span><span class="number">1648</span> c<span class="number">-40</span>  c<span class="number">-32</span>  c<span class="number">-24</span>  c<span class="number">-16</span>  c<span class="number">-8</span>   </span><br><span class="line"><span class="number">00000000000011</span>ee rsp<span class="operator">+</span><span class="number">8</span>    c<span class="number">-40</span>  c<span class="number">-32</span>  c<span class="number">-24</span>  c<span class="number">-16</span>  c<span class="number">-8</span>   </span><br></pre></td></tr></table></figure>

<h3 id="test1-调用帧分析"><a href="#test1-调用帧分析" class="headerlink" title="test1 调用帧分析"></a><a href="#test1">test1</a> 调用帧分析</h3><p>导出并解析调用帧定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang test1.cpp -O3 -rdynamic &amp;&amp; readelf -wF ./a.out</span><br><span class="line"></span><br><span class="line">Contents of the .eh_frame section:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00000000 0000000000000014 00000000 CIE <span class="string">&quot;zR&quot;</span> cf=1 <span class="built_in">df</span>=-8 ra=16</span><br><span class="line">   LOC           CFA      ra    </span><br><span class="line">0000000000000000 rsp+8    u     </span><br><span class="line"></span><br><span class="line">00000018 0000000000000014 0000001c FDE cie=00000000 pc=0000000000001080..00000000000010ab</span><br><span class="line"></span><br><span class="line">00000030 0000000000000014 00000000 CIE <span class="string">&quot;zR&quot;</span> cf=1 <span class="built_in">df</span>=-8 ra=16</span><br><span class="line">   LOC           CFA      ra    </span><br><span class="line">0000000000000000 rsp+8    c-8   </span><br><span class="line"></span><br><span class="line">00000048 0000000000000024 0000001c FDE cie=00000030 pc=0000000000001020..0000000000001070</span><br><span class="line">   LOC           CFA      ra    </span><br><span class="line">0000000000001020 rsp+16   c-8   </span><br><span class="line">0000000000001026 rsp+24   c-8   </span><br><span class="line">0000000000001030 exp      c-8   </span><br><span class="line"></span><br><span class="line">00000070 0000000000000014 00000044 FDE cie=00000030 pc=0000000000001070..0000000000001078</span><br><span class="line"></span><br><span class="line">00000088 0000000000000038 0000005c FDE cie=00000030 pc=0000000000001170..00000000000011ef</span><br><span class="line">   LOC           CFA      rbx   r12   r14   r15   ra    </span><br><span class="line">0000000000001170 rsp+8    u     u     u     u     c-8   </span><br><span class="line">0000000000001172 rsp+16   u     u     u     u     c-8   </span><br><span class="line">0000000000001174 rsp+24   u     u     u     u     c-8   </span><br><span class="line">0000000000001176 rsp+32   u     u     u     u     c-8   </span><br><span class="line">0000000000001177 rsp+40   u     u     u     u     c-8   </span><br><span class="line">000000000000117e rsp+1648 c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000011e7 rsp+40   c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000011e8 rsp+32   c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000011ea rsp+24   c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000011ec rsp+16   c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000011ee rsp+8    c-40  c-32  c-24  c-16  c-8   </span><br><span class="line"></span><br><span class="line">000000c4 000000000000001c 00000098 FDE cie=00000030 pc=00000000000011f0..0000000000001208</span><br><span class="line">   LOC           CFA      ra    </span><br><span class="line">00000000000011f0 rsp+8    c-8   </span><br><span class="line">00000000000011f1 rsp+16   c-8   </span><br><span class="line">00000000000011fe rsp+8    c-8   </span><br><span class="line">00000000000011ff rsp+16   c-8   </span><br><span class="line">0000000000001207 rsp+8    c-8   </span><br><span class="line"></span><br><span class="line">000000e4 0000000000000010 000000b8 FDE cie=00000030 pc=0000000000001210..0000000000001215</span><br><span class="line"></span><br><span class="line">000000f8 0000000000000010 000000cc FDE cie=00000030 pc=0000000000001220..0000000000001225</span><br><span class="line"></span><br><span class="line">0000010c 0000000000000010 000000e0 FDE cie=00000030 pc=0000000000001230..0000000000001235</span><br><span class="line"></span><br><span class="line">00000120 000000000000001c 000000f4 FDE cie=00000030 pc=0000000000001240..0000000000001256</span><br><span class="line">   LOC           CFA      rbp   ra    </span><br><span class="line">0000000000001240 rsp+8    u     c-8   </span><br><span class="line">0000000000001241 rsp+16   c-16  c-8   </span><br><span class="line">0000000000001244 rbp+16   c-16  c-8   </span><br><span class="line">0000000000001255 rsp+8    c-16  c-8   </span><br><span class="line"></span><br><span class="line">00000140 0000000000000010 00000114 FDE cie=00000030 pc=0000000000001260..0000000000001265</span><br><span class="line"></span><br><span class="line">00000154 0000000000000018 00000128 FDE cie=00000030 pc=0000000000001270..000000000000127d</span><br><span class="line">   LOC           CFA      ra    </span><br><span class="line">0000000000001270 rsp+8    c-8   </span><br><span class="line">0000000000001271 rsp+16   c-8   </span><br><span class="line">000000000000127c rsp+8    c-8   </span><br><span class="line"></span><br><span class="line">00000170 0000000000000044 00000144 FDE cie=00000030 pc=0000000000001280..00000000000012dd</span><br><span class="line">   LOC           CFA      rbx   rbp   r12   r13   r14   r15   ra    </span><br><span class="line">0000000000001280 rsp+8    u     u     u     u     u     u     c-8   </span><br><span class="line">0000000000001282 rsp+16   u     u     u     u     u     c-16  c-8   </span><br><span class="line">0000000000001287 rsp+24   u     u     u     u     c-24  c-16  c-8   </span><br><span class="line">000000000000128c rsp+32   u     u     u     c-32  c-24  c-16  c-8   </span><br><span class="line">0000000000001291 rsp+40   u     u     c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">0000000000001299 rsp+48   u     c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012a1 rsp+56   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012a8 rsp+64   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012d2 rsp+56   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012d3 rsp+48   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012d4 rsp+40   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012d6 rsp+32   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012d8 rsp+24   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012da rsp+16   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">00000000000012dc rsp+8    c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line"></span><br><span class="line">000001b8 0000000000000010 0000018c FDE cie=00000030 pc=00000000000012e0..00000000000012e1</span><br><span class="line"></span><br><span class="line">000001cc ZERO terminator</span><br><span class="line"></span><br><span class="line">&gt; readelf -wF /usr/lib64/libc.so.6 </span><br><span class="line"></span><br><span class="line">000000ac 0000000000000018 000000b0 FDE cie=00000000 pc=000000000003fe30..000000000003fedc</span><br><span class="line">   LOC           CFA      ra    </span><br><span class="line">000000000003fe30 rsp+8    c-8   </span><br><span class="line">000000000003fe31 rsp+16   c-8   </span><br><span class="line">000000000003fe32 rsp+8    c-8   </span><br><span class="line">000000000003fe39 rsp+160  c-8   </span><br><span class="line"></span><br><span class="line">000000c8 0000000000000030 000000cc FDE cie=00000000 pc=000000000003fee0..0000000000040028</span><br><span class="line">   LOC           CFA      rbx   rbp   r12   r13   r14   r15   ra    </span><br><span class="line">000000000003fee0 rsp+8    u     u     u     u     u     u     c-8   </span><br><span class="line">000000000003fee6 rsp+16   u     u     u     u     u     c-16  c-8   </span><br><span class="line">000000000003feeb rsp+24   u     u     u     u     c-24  c-16  c-8   </span><br><span class="line">000000000003feed rsp+32   u     u     u     c-32  c-24  c-16  c-8   </span><br><span class="line">000000000003fef2 rsp+40   u     u     c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">000000000003fef6 rsp+48   u     c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">000000000003fef9 rsp+56   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line">000000000003fefd rsp+80   c-56  c-48  c-40  c-32  c-24  c-16  c-8   </span><br><span class="line"></span><br><span class="line">000000fc 0000000000000010 00000100 FDE cie=00000000 pc=0000000000040030..000000000004004a</span><br></pre></td></tr></table></figure>

<p>分析可知 <code>backtrace()</code> 的调用栈展开过程为：</p>
<ul>
<li><code>dump_traceback()+0x1e</code><ul>
<li><code>118e</code>:<ul>
<li>ref <code>000000000000117e rsp+1648 c-40  c-32  c-24  c-16  c-8</code></li>
<li><code>1640(%rsp)</code> 得到返回地址 <code>1276</code></li>
</ul>
</li>
</ul>
</li>
<li><code>void* f3&lt;0&gt;()+0x6</code><ul>
<li><code>1276</code>:<ul>
<li>ref <code>0000000000001271 rsp+16   c-8</code></li>
<li><code>8(%rsp)</code> 得到返回地址 <code>1204</code></li>
</ul>
</li>
</ul>
</li>
<li><code>main()+0x14</code><ul>
<li><code>1204</code>:<ul>
<li>ref <code>00000000000011ff rsp+16   c-8</code></li>
<li><code>8(%rsp)</code> 得到 <code>/usr/lib64/libc.so.6</code> 中地址 <code>3feb0</code></li>
</ul>
</li>
</ul>
</li>
<li><code>/usr/lib64/libc.so.6(+0x3feb0)</code><ul>
<li>ref <code>000000000003fe39 rsp+160  c-8</code></li>
<li><code>152(%rsp)</code> 得到 <code>/usr/lib64/libc.so.6</code> 中地址 <code>3ff60</code></li>
</ul>
</li>
<li><code>/usr/lib64/libc.so.6(__libc_start_main+0x80)</code><ul>
<li>ref <code>000000000003fefd rsp+80   c-56  c-48  c-40  c-32  c-24  c-16  c-8</code></li>
<li><code>72(%rsp)</code> 得到返回地址 <code>10a5</code></li>
</ul>
</li>
<li><code>_start+0x25</code><ul>
<li>ref <code>0000000000000000 rsp+8    u</code></li>
</ul>
</li>
</ul>
<h2 id="libunwind-Stack-Unwinding"><a href="#libunwind-Stack-Unwinding" class="headerlink" title="libunwind Stack Unwinding"></a><code>libunwind</code> Stack Unwinding</h2><p><a target="_blank" rel="noopener" href="https://github.com/libunwind/libunwind">libunwind</a> 提供了可移植的、高效的 API 来确定程序的调用链。API 支持本地（同进程）和远程（跨进程）操作。API 可操作每个调用帧的保存状态（被调用方保存），可在调用链的任何点恢复执行。典型的 libunwind 使用场景有：异常处理，debug 调试，调用链监控，<code>setjmp() / longjmp()</code>。</p>
<p>libunwind 的相关接口函数如下</p>
<ul>
<li><code>unw_init_local</code> 主要用于当前进程的栈展开</li>
<li><code>unw_init_remote</code> 则通常作用于其他进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; nm -CD libunwind.so | grep <span class="string">&#x27;unw_&#x27;</span> | less</span><br><span class="line"></span><br><span class="line">0000000000007d84 W unw_getcontext</span><br><span class="line">0000000000001d80 W unw_get_fpreg</span><br><span class="line">0000000000001f30 W unw_get_proc_info</span><br><span class="line">0000000000002030 W unw_get_proc_name</span><br><span class="line">0000000000001bc0 W unw_get_reg</span><br><span class="line">0000000000001ab0 W unw_init_local</span><br><span class="line">00000000000020d0 W unw_is_fpreg</span><br><span class="line">00000000000021d0 W unw_is_signal_frame</span><br><span class="line">0000000000002240 W unw_iterate_dwarf_unwind_cache</span><br><span class="line">000000000000e0c8 D unw_local_addr_space</span><br><span class="line">0000000000002150 W unw_regname</span><br><span class="line">0000000000001fc0 W unw_resume</span><br><span class="line">0000000000001e20 W unw_set_fpreg</span><br><span class="line">0000000000001c60 W unw_set_reg</span><br><span class="line">0000000000001ec0 W unw_step</span><br></pre></td></tr></table></figure>

<h3 id="test2"><a href="#test2" class="headerlink" title="test2"></a>test2</h3><p>test2 测试基于 libunwind 进行本地调用栈回溯。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test2.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cxxabi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNW_LOCAL_ONLY</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libunwind.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NO_INLINE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NO_INLINE __attribute__((__noinline__))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NO_INLINE <span class="type">void</span> <span class="title">dump_backtrace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buff[<span class="number">1024</span>];</span><br><span class="line">  <span class="type">size_t</span> demangle_buff_size = <span class="number">0</span>;</span><br><span class="line">  <span class="type">char</span> *demangle_buff = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">unw_cursor_t</span> cursor;</span><br><span class="line">  <span class="type">unw_context_t</span> uc;</span><br><span class="line"></span><br><span class="line">  <span class="type">unw_word_t</span> offset&#123;&#125;;</span><br><span class="line">  <span class="built_in">unw_getcontext</span>(&amp;uc);</span><br><span class="line">  <span class="built_in">unw_init_local</span>(&amp;cursor, &amp;uc);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">unw_step</span>(&amp;cursor) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">unw_word_t</span> ip, sp;</span><br><span class="line">    <span class="built_in">unw_get_reg</span>(&amp;cursor, UNW_REG_IP, &amp;ip);</span><br><span class="line">    <span class="built_in">unw_get_reg</span>(&amp;cursor, UNW_REG_SP, &amp;sp);</span><br><span class="line">    <span class="keyword">auto</span> status = <span class="built_in">unw_get_proc_name</span>(&amp;cursor, buff, <span class="built_in">sizeof</span>(buff), &amp;offset);</span><br><span class="line">    <span class="built_in">assert</span>(!status);</span><br><span class="line">    <span class="keyword">auto</span> realname = buff;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="type">int</span> status = <span class="number">-1</span>;</span><br><span class="line">          demangle_buff = abi::__cxa_demangle(buff, demangle_buff,</span><br><span class="line">                                              &amp;demangle_buff_size, &amp;status),</span><br><span class="line">          status == <span class="number">0</span>) &#123;</span><br><span class="line">        realname = demangle_buff;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%016lx &lt;%s+0x%lx&gt;\n&quot;</span>, ip, realname, offset);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (demangle_buff) &#123;</span><br><span class="line">    <span class="built_in">free</span>(demangle_buff);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NO_INLINE <span class="type">void</span> *<span class="title">f3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">dump_backtrace</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NO_INLINE <span class="type">void</span> *<span class="title">f2</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">f3</span>(); &#125;</span><br><span class="line"><span class="function">NO_INLINE <span class="type">void</span> *<span class="title">f1</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">f2</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">f1</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang test2.cpp -O3 -L/usr/lib64 -lunwind -lc++ -lc++abi -stdlib=libc++ -std=gnu++20 -rdynamic &amp;&amp; ./a.out </span><br><span class="line"></span><br><span class="line">0x00005645e5d11306 &lt;f3()+0x6&gt;</span><br><span class="line">0x00005645e5d11316 &lt;f2()+0x6&gt;</span><br><span class="line">0x00005645e5d11326 &lt;f1()+0x6&gt;</span><br><span class="line">0x00005645e5d11336 &lt;main+0x6&gt;</span><br><span class="line">0x00007ff550c3feb0 &lt;__libc_start_call_main+0x80&gt;</span><br><span class="line">0x00007ff550c3ff60 &lt;__libc_start_main+0x80&gt;</span><br><span class="line">0x00005645e5d110f5 &lt;_start+0x25&gt;</span><br></pre></td></tr></table></figure>

<p>此处由于函数 <code>f1()</code> <code>f2()</code> <code>f3()</code> <code>dump_backtrace()</code> 默认符号对外可见，编译器优化 <code>optimize-sibling-calls</code> 便无法生效。如果函数声明为 <code>static</code> 或使用匿名空间，则可优化这种调用关系。</p>
<h2 id="C-Exception-Handling"><a href="#C-Exception-Handling" class="headerlink" title="C++ Exception Handling"></a>C++ Exception Handling</h2><p>C++ Exception Handling 是 Stack Unwinding 的典型应用。异常处理相关的 ABI 有多种，以 <a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html">Itanium C++ ABI: Exception Handling</a> 使用最广，其中 C++ 异常处理的 ABI 被分成 3 个级别：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html#base-abi">Base ABI</a>：语言无关的公共接口</li>
<li><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html#cxx-abi">C++ ABI</a>：C++ 实现的必要接口</li>
<li>特定运行时下的实现规范</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html#defs">Landing Pad 定义</a></p>
<ul>
<li>landing-pad 是指捕获异常或在异常后执行清理流程的用户代码</li>
<li>异常处理过程中的 <a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html#base-personality">Personality Routine</a> 流程会有选择地将代码的控制权移交给 landing-pad，执行相关逻辑后，或结束异常处理并回到正常用户代码，或继续处理异常，或抛出异常</li>
</ul>
<h3 id="test4"><a href="#test4" class="headerlink" title="test4"></a>test4</h3><p>test4 以简单的代码实例介绍异常从被抛出到捕获的过程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test4.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> v = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">N</span> &#123;</span><br><span class="line">  __attribute__((__noinline__)) <span class="built_in">N</span>() &#123; v = <span class="number">0x1</span>; &#125;</span><br><span class="line">  __attribute__((__noinline__)) ~<span class="built_in">N</span>() &#123; v = <span class="number">0x2</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">(<span class="type">bool</span> x)</span> </span>&#123;</span><br><span class="line">  N n;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (x)</span><br><span class="line">      <span class="keyword">throw</span> v;</span><br><span class="line">    v = <span class="number">0x4</span>;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">int</span> &amp;e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(v);</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">double</span> &amp;e) &#123;</span><br><span class="line">    v = <span class="number">0x5</span>;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">    v = <span class="number">0x3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_noexcept</span><span class="params">(<span class="type">bool</span>)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">  N n;</span><br><span class="line">  <span class="keyword">throw</span> v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">(<span class="type">bool</span> x)</span> </span>&#123;</span><br><span class="line">  N n;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">test</span>(x);</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">float</span> &amp;e) &#123;</span><br><span class="line">    v = <span class="number">0x6</span>;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">double</span> &amp;e) &#123;</span><br><span class="line">    v = <span class="number">0x7</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v = <span class="number">0x8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang -c test4.cpp -O3 &amp;&amp; objdump -C -r -d ./test4.o</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;<span class="built_in">test</span>(bool)&gt;:</span><br><span class="line">   0:   53                      push   %rbx</span><br><span class="line">   1:   48 83 ec 10             sub    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">   5:   89 fb                   mov    %edi,%ebx</span><br><span class="line">   7:   48 8d 7c 24 08          lea    0x8(%rsp),%rdi</span><br><span class="line">   c:   e8 00 00 00 00          callq  11 &lt;<span class="built_in">test</span>(bool)+0x11&gt;</span><br><span class="line">                        d: R_X86_64_PLT32       N::N()-0x4</span><br><span class="line"><span class="comment"># test x</span></span><br><span class="line">  11:   85 db                   <span class="built_in">test</span>   %ebx,%ebx</span><br><span class="line">  13:   75 1a                   jne    2f &lt;<span class="built_in">test</span>(bool)+0x2f&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># x is 0</span></span><br><span class="line"><span class="comment"># 正常流程结束函数调用</span></span><br><span class="line">  15:   c7 05 00 00 00 00 04    movl   <span class="variable">$0x4</span>,0x0(%rip)        <span class="comment"># 1f &lt;test(bool)+0x1f&gt;</span></span><br><span class="line">  1c:   00 00 00 </span><br><span class="line">                        17: R_X86_64_PC32       v-0x8</span><br><span class="line">  1f:   48 8d 7c 24 08          lea    0x8(%rsp),%rdi</span><br><span class="line">  24:   e8 00 00 00 00          callq  29 &lt;<span class="built_in">test</span>(bool)+0x29&gt;</span><br><span class="line">                        25: R_X86_64_PLT32      N::~N()-0x4</span><br><span class="line">  29:   48 83 c4 10             add    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">  2d:   5b                      pop    %rbx</span><br><span class="line">  2e:   c3                      retq  </span><br><span class="line"></span><br><span class="line"><span class="comment"># x is NOT 0</span></span><br><span class="line"><span class="comment"># __cxa_allocate_exception 分配异常对象空间</span></span><br><span class="line">  2f:   bf 04 00 00 00          mov    <span class="variable">$0x4</span>,%edi</span><br><span class="line">  34:   e8 00 00 00 00          callq  39 &lt;<span class="built_in">test</span>(bool)+0x39&gt;</span><br><span class="line">                        35: R_X86_64_PLT32      __cxa_allocate_exception-0x4</span><br><span class="line"><span class="comment"># 设置异常对象数据</span></span><br><span class="line">  39:   8b 0d 00 00 00 00       mov    0x0(%rip),%ecx        <span class="comment"># 3f &lt;test(bool)+0x3f&gt;</span></span><br><span class="line">                        3b: R_X86_64_PC32       v-0x4</span><br><span class="line">  3f:   89 08                   mov    %ecx,(%rax)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置异常对象类型</span></span><br><span class="line">  41:   48 8b 35 00 00 00 00    mov    0x0(%rip),%rsi        <span class="comment"># 48 &lt;test(bool)+0x48&gt;</span></span><br><span class="line">                        44: R_X86_64_REX_GOTPCRELX      typeinfo <span class="keyword">for</span> int-0x4</span><br><span class="line">  48:   48 89 c7                mov    %rax,%rdi</span><br><span class="line">  4b:   31 d2                   xor    %edx,%edx</span><br><span class="line"></span><br><span class="line"><span class="comment"># __cxa_throw 抛出异常</span></span><br><span class="line">  4d:   e8 00 00 00 00          callq  52 &lt;<span class="built_in">test</span>(bool)+0x52&gt;</span><br><span class="line">                        4e: R_X86_64_PLT32      __cxa_throw-0x4</span><br><span class="line"></span><br><span class="line"><span class="comment"># landing pad：清理</span></span><br><span class="line">  52:   eb 63                   jmp    b7 &lt;<span class="built_in">test</span>(bool)+0xb7&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># landing pad：异常捕获</span></span><br><span class="line">  54:   48 89 d3                mov    %rdx,%rbx</span><br><span class="line">  57:   48 89 c7                mov    %rax,%rdi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配 int 类型异常</span></span><br><span class="line">  5a:   83 fb 03                cmp    <span class="variable">$0x3</span>,%ebx</span><br><span class="line">  5d:   74 2c                   je     8b &lt;<span class="built_in">test</span>(bool)+0x8b&gt;</span><br><span class="line">  5f:   e8 00 00 00 00          callq  64 &lt;<span class="built_in">test</span>(bool)+0x64&gt;</span><br><span class="line">                        60: R_X86_64_PLT32      __cxa_begin_catch-0x4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配 double 类型异常</span></span><br><span class="line">  64:   83 fb 02                cmp    <span class="variable">$0x2</span>,%ebx</span><br><span class="line">  67:   75 11                   jne    7a &lt;<span class="built_in">test</span>(bool)+0x7a&gt;</span><br><span class="line">  69:   c7 05 00 00 00 00 88    movl   <span class="variable">$0x5</span>,0x0(%rip)        <span class="comment"># 73 &lt;test(bool)+0x73&gt;</span></span><br><span class="line">  70:   88 00 00 </span><br><span class="line">                        6b: R_X86_64_PC32       v-0x8</span><br><span class="line">  73:   e8 00 00 00 00          callq  78 &lt;<span class="built_in">test</span>(bool)+0x78&gt;</span><br><span class="line">                        74: R_X86_64_PLT32      __cxa_end_catch-0x4</span><br><span class="line">  78:   eb a5                   jmp    1f &lt;<span class="built_in">test</span>(bool)+0x1f&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配默认异常</span></span><br><span class="line">  7a:   c7 05 00 00 00 00 03    movl   <span class="variable">$0x3</span>,0x0(%rip)        <span class="comment"># 84 &lt;test(bool)+0x84&gt;</span></span><br><span class="line">  81:   00 00 00 </span><br><span class="line">                        7c: R_X86_64_PC32       v-0x8</span><br><span class="line">  84:   e8 00 00 00 00          callq  89 &lt;<span class="built_in">test</span>(bool)+0x89&gt;</span><br><span class="line">                        85: R_X86_64_PLT32      __cxa_end_catch-0x4</span><br><span class="line">  89:   eb 94                   jmp    1f &lt;<span class="built_in">test</span>(bool)+0x1f&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配 int 类型异常，新抛出 double 类型异常</span></span><br><span class="line">  8b:   e8 00 00 00 00          callq  90 &lt;<span class="built_in">test</span>(bool)+0x90&gt;</span><br><span class="line">                        8c: R_X86_64_PLT32      __cxa_begin_catch-0x4</span><br><span class="line">  90:   bf 08 00 00 00          mov    <span class="variable">$0x8</span>,%edi</span><br><span class="line">  95:   e8 00 00 00 00          callq  9a &lt;<span class="built_in">test</span>(bool)+0x9a&gt;</span><br><span class="line">                        96: R_X86_64_PLT32      __cxa_allocate_exception-0x4</span><br><span class="line">  9a:   f2 0f 2a 05 00 00 00    cvtsi2sdl 0x0(%rip),%xmm0        <span class="comment"># a2 &lt;test(bool)+0xa2&gt;</span></span><br><span class="line">  a1:   00 </span><br><span class="line">                        9e: R_X86_64_PC32       v-0x4</span><br><span class="line">  a2:   f2 0f 11 00             movsd  %xmm0,(%rax)</span><br><span class="line">  a6:   48 8b 35 00 00 00 00    mov    0x0(%rip),%rsi        <span class="comment"># ad &lt;test(bool)+0xad&gt;</span></span><br><span class="line">                        a9: R_X86_64_REX_GOTPCRELX      typeinfo <span class="keyword">for</span> double-0x4</span><br><span class="line">  ad:   48 89 c7                mov    %rax,%rdi</span><br><span class="line">  b0:   31 d2                   xor    %edx,%edx</span><br><span class="line">  b2:   e8 00 00 00 00          callq  b7 &lt;<span class="built_in">test</span>(bool)+0xb7&gt;</span><br><span class="line">                        b3: R_X86_64_PLT32      __cxa_throw-0x4</span><br><span class="line">  b7:   48 89 c3                mov    %rax,%rbx</span><br><span class="line">  ba:   eb 08                   jmp    c4 &lt;<span class="built_in">test</span>(bool)+0xc4&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># `b2:` 抛出异常对应 landing pad：清理</span></span><br><span class="line">  bc:   48 89 c3                mov    %rax,%rbx</span><br><span class="line">  bf:   e8 00 00 00 00          callq  c4 &lt;<span class="built_in">test</span>(bool)+0xc4&gt;</span><br><span class="line">                        c0: R_X86_64_PLT32      __cxa_end_catch-0x4</span><br><span class="line">  c4:   48 8d 7c 24 08          lea    0x8(%rsp),%rdi</span><br><span class="line">  c9:   e8 00 00 00 00          callq  ce &lt;<span class="built_in">test</span>(bool)+0xce&gt;</span><br><span class="line">                        ca: R_X86_64_PLT32      N::~N()-0x4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳转回到 cleanup 阶段</span></span><br><span class="line">  ce:   48 89 <span class="built_in">df</span>                mov    %rbx,%rdi</span><br><span class="line">  d1:   e8 00 00 00 00          callq  d6 &lt;<span class="built_in">test</span>(bool)+0xd6&gt;</span><br><span class="line">                        d2: R_X86_64_PLT32      _Unwind_Resume-0x4</span><br><span class="line">  d6:   66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  <span class="built_in">dd</span>:   00 00 00 </span><br><span class="line"></span><br><span class="line">00000000000000e0 &lt;test_noexcept(bool)&gt;:</span><br><span class="line">  e0:   50                      push   %rax</span><br><span class="line">  e1:   48 89 e7                mov    %rsp,%rdi</span><br><span class="line">  e4:   e8 00 00 00 00          callq  e9 &lt;test_noexcept(bool)+0x9&gt;</span><br><span class="line">                        e5: R_X86_64_PLT32      N::N()-0x4</span><br><span class="line">  e9:   bf 04 00 00 00          mov    <span class="variable">$0x4</span>,%edi</span><br><span class="line">  ee:   e8 00 00 00 00          callq  f3 &lt;test_noexcept(bool)+0x13&gt;</span><br><span class="line">                        ef: R_X86_64_PLT32      __cxa_allocate_exception-0x4</span><br><span class="line">  f3:   8b 0d 00 00 00 00       mov    0x0(%rip),%ecx        <span class="comment"># f9 &lt;test_noexcept(bool)+0x19&gt;</span></span><br><span class="line">                        f5: R_X86_64_PC32       v-0x4</span><br><span class="line">  f9:   89 08                   mov    %ecx,(%rax)</span><br><span class="line">  fb:   48 8b 35 00 00 00 00    mov    0x0(%rip),%rsi        <span class="comment"># 102 &lt;test_noexcept(bool)+0x22&gt;</span></span><br><span class="line">                        fe: R_X86_64_REX_GOTPCRELX      typeinfo <span class="keyword">for</span> int-0x4</span><br><span class="line"> 102:   48 89 c7                mov    %rax,%rdi</span><br><span class="line"> 105:   31 d2                   xor    %edx,%edx</span><br><span class="line"> 107:   e8 00 00 00 00          callq  10c &lt;test_noexcept(bool)+0x2c&gt;</span><br><span class="line">                        108: R_X86_64_PLT32     __cxa_throw-0x4</span><br><span class="line"></span><br><span class="line"><span class="comment"># landing pad：terminate 进程</span></span><br><span class="line"> 10c:   48 89 c7                mov    %rax,%rdi</span><br><span class="line"> 10f:   e8 00 00 00 00          callq  114 &lt;test_noexcept(bool)+0x34&gt;</span><br><span class="line">                        110: R_X86_64_PLT32     __clang_call_terminate-0x4</span><br><span class="line"> 114:   66 66 66 2e 0f 1f 84    data16 data16 nopw %cs:0x0(%rax,%rax,1)</span><br><span class="line"> 11b:   00 00 00 00 00 </span><br><span class="line"></span><br><span class="line">0000000000000120 &lt;test2(bool)&gt;:</span><br><span class="line"> 120:   55                      push   %rbp</span><br><span class="line"> 121:   53                      push   %rbx</span><br><span class="line"> 122:   50                      push   %rax</span><br><span class="line"> 123:   89 fb                   mov    %edi,%ebx</span><br><span class="line"> 125:   48 89 e7                mov    %rsp,%rdi</span><br><span class="line"> 128:   e8 00 00 00 00          callq  12d &lt;test2(bool)+0xd&gt;</span><br><span class="line">                        129: R_X86_64_PLT32     N::N()-0x4</span><br><span class="line"> 12d:   89 <span class="built_in">df</span>                   mov    %ebx,%edi</span><br><span class="line"> 12f:   e8 00 00 00 00          callq  134 &lt;test2(bool)+0x14&gt;</span><br><span class="line">                        130: R_X86_64_PLT32     <span class="built_in">test</span>(bool)-0x4</span><br><span class="line"> 134:   c7 05 00 00 00 00 08    movl   <span class="variable">$0x8</span>,0x0(%rip)        <span class="comment"># 13e &lt;test2(bool)+0x1e&gt;</span></span><br><span class="line"> 13b:   00 00 00 </span><br><span class="line">                        136: R_X86_64_PC32      v-0x8</span><br><span class="line"> 13e:   48 89 e7                mov    %rsp,%rdi</span><br><span class="line"> 141:   e8 00 00 00 00          callq  146 &lt;test2(bool)+0x26&gt;</span><br><span class="line">                        142: R_X86_64_PLT32     N::~N()-0x4</span><br><span class="line"> 146:   48 83 c4 08             add    <span class="variable">$0x8</span>,%rsp</span><br><span class="line"> 14a:   5b                      pop    %rbx</span><br><span class="line"> 14b:   5d                      pop    %rbp</span><br><span class="line"> 14c:   c3                      retq   </span><br><span class="line"></span><br><span class="line"><span class="comment"># landing pad：异常捕获</span></span><br><span class="line"> 14d:   48 89 c3                mov    %rax,%rbx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配 float 类型异常</span></span><br><span class="line"> 150:   bd 06 00 00 00          mov    <span class="variable">$0x6</span>,%ebp</span><br><span class="line"> 155:   83 fa 02                cmp    <span class="variable">$0x2</span>,%edx</span><br><span class="line"> 158:   74 0a                   je     164 &lt;test2(bool)+0x44&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配 double 类型异常</span></span><br><span class="line"> 15a:   bd 07 00 00 00          mov    <span class="variable">$0x7</span>,%ebp</span><br><span class="line"> 15f:   83 fa 01                cmp    <span class="variable">$0x1</span>,%edx</span><br><span class="line"> 162:   75 15                   jne    179 &lt;test2(bool)+0x59&gt;</span><br><span class="line"> 164:   48 89 <span class="built_in">df</span>                mov    %rbx,%rdi</span><br><span class="line"> 167:   e8 00 00 00 00          callq  16c &lt;test2(bool)+0x4c&gt;</span><br><span class="line">                        168: R_X86_64_PLT32     __cxa_begin_catch-0x4</span><br><span class="line"> 16c:   89 2d 00 00 00 00       mov    %ebp,0x0(%rip)        <span class="comment"># 172 &lt;test2(bool)+0x52&gt;</span></span><br><span class="line">                        16e: R_X86_64_PC32      v-0x4</span><br><span class="line"> 172:   e8 00 00 00 00          callq  177 &lt;test2(bool)+0x57&gt;</span><br><span class="line">                        173: R_X86_64_PLT32     __cxa_end_catch-0x4</span><br><span class="line"> 177:   eb bb                   jmp    134 &lt;test2(bool)+0x14&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无匹配异常</span></span><br><span class="line"><span class="comment"># landing pad：清理并继续 unwind</span></span><br><span class="line"> 179:   48 89 e7                mov    %rsp,%rdi</span><br><span class="line"> 17c:   e8 00 00 00 00          callq  181 &lt;test2(bool)+0x61&gt;</span><br><span class="line">                        17d: R_X86_64_PLT32     N::~N()-0x4</span><br><span class="line"> 181:   48 89 <span class="built_in">df</span>                mov    %rbx,%rdi</span><br><span class="line"> 184:   e8 00 00 00 00          callq  189 &lt;test2(bool)+0x69&gt;</span><br><span class="line">                        185: R_X86_64_PLT32     _Unwind_Resume-0x4</span><br><span class="line"></span><br><span class="line">Disassembly of section .text._ZN1NC2Ev:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;N::N()&gt;:</span><br><span class="line">   0:   c7 05 00 00 00 00 01    movl   <span class="variable">$0x1</span>,0x0(%rip)        <span class="comment"># a &lt;N::N()+0xa&gt;</span></span><br><span class="line">   7:   00 00 00 </span><br><span class="line">                        2: R_X86_64_PC32        v-0x8</span><br><span class="line">   a:   c3                      retq   </span><br><span class="line"></span><br><span class="line">Disassembly of section .text._ZN1ND2Ev:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;N::~N()&gt;:</span><br><span class="line">   0:   c7 05 00 00 00 00 02    movl   <span class="variable">$0x2</span>,0x0(%rip)        <span class="comment"># a &lt;N::~N()+0xa&gt;</span></span><br><span class="line">   7:   00 00 00 </span><br><span class="line">                        2: R_X86_64_PC32        v-0x8</span><br><span class="line">   a:   c3                      retq   </span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__clang_call_terminate:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;__clang_call_terminate&gt;:</span><br><span class="line">   0:   50                      push   %rax</span><br><span class="line">   1:   e8 00 00 00 00          callq  6 &lt;__clang_call_terminate+0x6&gt;</span><br><span class="line">                        2: R_X86_64_PLT32       __cxa_begin_catch-0x4</span><br><span class="line">   6:   e8 00 00 00 00          callq  b &lt;__clang_call_terminate+0xb&gt;</span><br><span class="line">                        7: R_X86_64_PLT32       std::terminate()-0x4</span><br></pre></td></tr></table></figure>

<h3 id="test4-分析"><a href="#test4-分析" class="headerlink" title="test4 分析"></a>test4 分析</h3><p>异常抛出逻辑主要步骤：</p>
<ul>
<li>异常对象构造：<code>__cxa_allocate_exception</code> 分配堆上空间并构造对象，设置异常类型 <code>RTTI（Run-Time Type Information）</code></li>
<li>异常抛出：<code>__cxa_throw</code> 设置当前异常，执行 <code>_Unwind_RaiseException</code>（主要分为 2 个阶段 search 和 cleanup）：<ul>
<li>search 阶段：通过 <code>Personality Routine</code> 机制（ELF 下主要根据 <code>.gcc_except_table</code> 段，由 <code>__gxx_personality_v0</code> 和 <code>__gcc_personality_v0</code> 解析）逐级展开栈帧，查找 <code>try&#123;&#125;catch&#123;&#125;</code> 与当前异常类型匹配的模块，如果没有找到就 terminate 进程，否则进入 cleanup 阶段</li>
<li>cleanup 阶段：重新通过 <code>Personality Routine</code> 机制逐级展开栈帧<ul>
<li>找到需要清理变量的栈帧后，恢复寄存器状态，跳转到该帧相关的 landing-pad。该 landing-pad 最后会调用 <code>_Unwind_Resume</code> 跳转回到 cleanup 阶段。</li>
<li>找到需要执行异常捕获的栈帧后，恢复寄存器状态，跳转到该帧相关的 landing-pad。如果异常匹配成功后，调用 <code>__cxa_begin_catch</code>，执行相关 catch 代码逻辑，最后调用 <code>__cxa_end_catch</code> 结束异常处理流程，回归正常代码；如果无异常匹配，则清理残留变量并通过 <code>_Unwind_Resume</code> 跳转回 cleanup 阶段；</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>__cxa_*</code> 为 C++ 内部实现的异常处理接口，clang 下的具体行为可参考 <a target="_blank" rel="noopener" href="https://releases.llvm.org/15.0.0/docs/ExceptionHandling.html">Exception Handling in LLVM</a></p>
<ul>
<li><code>__cxa_begin_catch</code> 返回异常对象的指针</li>
<li><code>__cxa_end_catch</code> 减少当前捕获异常的引用计数，或清除异常对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; nm -CD libstdc++.so</span><br><span class="line"></span><br><span class="line">00000000000917a0 T __cxa_allocate_exception</span><br><span class="line">00000000000919f0 T __cxa_begin_catch</span><br><span class="line">000000000009e0b0 T __cxa_demangle</span><br><span class="line">0000000000091a60 T __cxa_end_catch</span><br><span class="line">0000000000092b40 T __cxa_rethrow</span><br><span class="line">0000000000092af0 T __cxa_throw</span><br><span class="line"></span><br><span class="line">&gt; objdump -C -r -d libstdc++.so.6</span><br><span class="line"></span><br><span class="line">0000000000092af0 &lt;__cxa_throw@@CXXABI_1.3&gt;:</span><br><span class="line">...</span><br><span class="line">   92b22:       e8 b9 7a ff ff          callq  8a5e0 &lt;_Unwind_RaiseException@plt&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>异常抛出的行为依赖 unwind 库接口 <code>_Unwind_*</code>。gcc 自带默认 unwind 库 <code>libgcc_s.[so.*]</code> 和 <code>libgcc_eh.a</code>，此外还有以 <a target="_blank" rel="noopener" href="https://www.nongnu.org/libunwind/">nongnu.org&#x2F;libunwind</a> 和 <a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project.git">llvm-project&#x2F;libunwind</a> 为典型代表的 libunwind 库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; nm -CD libunwind.so | grep <span class="string">&#x27;_Unwind_&#x27;</span> | less</span><br><span class="line">0000000000007760 T _Unwind_Backtrace</span><br><span class="line">0000000000007350 T _Unwind_DeleteException</span><br><span class="line">00000000000076a0 T _Unwind_FindEnclosingFunction</span><br><span class="line">00000000000078f0 T _Unwind_Find_FDE</span><br><span class="line">0000000000007170 T _Unwind_ForcedUnwind</span><br><span class="line">00000000000079d0 T _Unwind_GetCFA</span><br><span class="line">00000000000075c0 T _Unwind_GetDataRelBase</span><br><span class="line">00000000000073a0 T _Unwind_GetGR</span><br><span class="line">0000000000007470 T _Unwind_GetIP</span><br><span class="line">0000000000007a40 T _Unwind_GetIPInfo</span><br><span class="line">0000000000007220 T _Unwind_GetLanguageSpecificData</span><br><span class="line">00000000000072d0 T _Unwind_GetRegionStart</span><br><span class="line">0000000000007630 T _Unwind_GetTextRelBase</span><br><span class="line">0000000000006780 T _Unwind_RaiseException</span><br><span class="line">0000000000006de0 T _Unwind_Resume</span><br><span class="line">0000000000007530 T _Unwind_Resume_or_Rethrow</span><br><span class="line">0000000000007420 T _Unwind_SetGR</span><br><span class="line">00000000000074e0 T _Unwind_SetIP</span><br></pre></td></tr></table></figure>

<p>通常 C++ 编译器默认函数会抛出异常（禁止使用异常则需加上编译参数 <code>-fno-exceptions</code>）。被关键字 <code>noexcept</code> 修饰的函数表示其不会对外抛出异常，主要影响体现在 2 个层面：</p>
<ul>
<li>函数定义：<code>f(...) noexcept &#123; ... f?(); ... &#125;</code> 定义近似于 <code>f(...) &#123; ... try &#123; f?(); &#125; catch (...) &#123;std::terminate();&#125; &#125;</code>，即函数内部调用其他函数时捕获任何异常均会进入 terminate 流程。</li>
<li>函数声明：声明为 <code>noexcept</code> 的函数被调用时，编译器无需为该调用路径设置 landing-pad，以便于优化调用方行为。常见的 <code>C</code> 或 <code>extern &quot;C&quot;</code> 基础库函数通常会包含 <code>throw()</code> &#x2F; <code>noexcept(true)</code> &#x2F; <code>noexcept</code> 之类的无异常声明。</li>
</ul>
<h2 id="C-异常的影响"><a href="#C-异常的影响" class="headerlink" title="C++ 异常的影响"></a>C++ 异常的影响</h2><p>鉴于 C++ 抛出异常和处理异常时的糟糕性能已是公认的问题，此处不再累述。然而，面向基本无异常抛出的场景，用异常来代替返回值检查可以进一步优化最短链路。</p>
<p>test5 中 <code>f1()</code> 会在出现错误时抛出异常，<code>f2()</code> 则是以返回值表示状态，<code>test1()</code> 和 <code>test2()</code> 实现近似功能。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test5.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int64_t</span> <span class="title">f1</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> N = std::optional&lt;<span class="type">int64_t</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="function">N <span class="title">f2</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int64_t</span> <span class="title">test1</span><span class="params">(<span class="type">size_t</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="type">int64_t</span> res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">    res += <span class="built_in">f1</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">N <span class="title">test2</span><span class="params">(<span class="type">size_t</span> n)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">  <span class="type">int64_t</span> res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">    <span class="keyword">auto</span> &amp;&amp;x = <span class="built_in">f2</span>();</span><br><span class="line">    <span class="keyword">if</span> (!x) &#123;</span><br><span class="line">      <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    res += *x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从反汇编结果来看，<code>test1()</code> 函数的代码更精练紧凑，使用的寄存器更少。极少出现错误时，整个调用链路可以节省状态检查的相关逻辑，进一步压榨性能。</p>
<p><code>f2()</code> 将返回状态和返回结果分别存储在 8 字节整型结构中返回，可以通过 RAX 和 RDX 寄存器传回调用方，<code>test2()</code>中则检测 RDX 并跳转分支。如果返回状态错误较少，则 CPU 分支预测成功率较高情况下，这种状态检查造成的开销微乎其微。如果状态检查的逻辑较为复杂时，则需要具体评估使用场景并优化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang -c test5.cpp -O3 -std=gnu++17 &amp;&amp; objdump -C -r -d test5.o</span><br><span class="line"></span><br><span class="line">test5.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;test1(unsigned long)&gt;:</span><br><span class="line">   0:   41 56                   push   %r14</span><br><span class="line">   2:   53                      push   %rbx</span><br><span class="line">   3:   50                      push   %rax</span><br><span class="line">   4:   48 85 ff                <span class="built_in">test</span>   %rdi,%rdi</span><br><span class="line">   7:   74 16                   je     1f &lt;test1(unsigned long)+0x1f&gt;</span><br><span class="line">   9:   48 89 fb                mov    %rdi,%rbx</span><br><span class="line">   c:   45 31 f6                xor    %r14d,%r14d</span><br><span class="line">   f:   90                      nop</span><br><span class="line">  10:   e8 00 00 00 00          callq  15 &lt;test1(unsigned long)+0x15&gt;</span><br><span class="line">                        11: R_X86_64_PLT32      f1()-0x4</span><br><span class="line">  15:   49 01 c6                add    %rax,%r14</span><br><span class="line">  18:   48 ff cb                dec    %rbx</span><br><span class="line">  1b:   75 f3                   jne    10 &lt;test1(unsigned long)+0x10&gt;</span><br><span class="line">  1d:   eb 03                   jmp    22 &lt;test1(unsigned long)+0x22&gt;</span><br><span class="line">  1f:   45 31 f6                xor    %r14d,%r14d</span><br><span class="line">  22:   4c 89 f0                mov    %r14,%rax</span><br><span class="line">  25:   48 83 c4 08             add    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">  29:   5b                      pop    %rbx</span><br><span class="line">  2a:   41 5e                   pop    %r14</span><br><span class="line">  2c:   c3                      retq   </span><br><span class="line">  2d:   0f 1f 00                nopl   (%rax)</span><br><span class="line"></span><br><span class="line">0000000000000030 &lt;test2(unsigned long)&gt;:</span><br><span class="line">  30:   55                      push   %rbp</span><br><span class="line">  31:   41 56                   push   %r14</span><br><span class="line">  33:   53                      push   %rbx</span><br><span class="line">  34:   41 b6 01                mov    <span class="variable">$0x1</span>,%r14b</span><br><span class="line">  37:   48 85 ff                <span class="built_in">test</span>   %rdi,%rdi</span><br><span class="line">  3a:   74 27                   je     63 &lt;test2(unsigned long)+0x33&gt;</span><br><span class="line">  3c:   48 89 fd                mov    %rdi,%rbp</span><br><span class="line">  3f:   31 db                   xor    %ebx,%ebx</span><br><span class="line">  41:   66 66 66 66 66 66 2e    data16 data16 data16 data16 data16 nopw %cs:0x0(%rax,%rax,1)</span><br><span class="line">  48:   0f 1f 84 00 00 00 00 </span><br><span class="line">  4f:   00 </span><br><span class="line">  50:   e8 00 00 00 00          callq  55 &lt;test2(unsigned long)+0x25&gt;</span><br><span class="line">                        51: R_X86_64_PLT32      f2()-0x4</span><br><span class="line">  55:   84 d2                   <span class="built_in">test</span>   %dl,%dl</span><br><span class="line">  57:   74 0e                   je     67 &lt;test2(unsigned long)+0x37&gt;</span><br><span class="line">  59:   48 01 c3                add    %rax,%rbx</span><br><span class="line">  5c:   48 ff <span class="built_in">cd</span>                dec    %rbp</span><br><span class="line">  5f:   75 ef                   jne    50 &lt;test2(unsigned long)+0x20&gt;</span><br><span class="line">  61:   eb 0a                   jmp    6d &lt;test2(unsigned long)+0x3d&gt;</span><br><span class="line">  63:   31 db                   xor    %ebx,%ebx</span><br><span class="line">  65:   eb 06                   jmp    6d &lt;test2(unsigned long)+0x3d&gt;</span><br><span class="line">  67:   45 31 f6                xor    %r14d,%r14d</span><br><span class="line">  6a:   48 89 c3                mov    %rax,%rbx</span><br><span class="line">  6d:   48 89 d8                mov    %rbx,%rax</span><br><span class="line">  70:   44 89 f2                mov    %r14d,%edx</span><br><span class="line">  73:   5b                      pop    %rbx</span><br><span class="line">  74:   41 5e                   pop    %r14</span><br><span class="line">  76:   5d                      pop    %rbp</span><br><span class="line">  77:   c3                      retq   </span><br><span class="line"></span><br><span class="line">&gt; <span class="built_in">ls</span> -l test5.o</span><br><span class="line">-rw-r--r-- 1 root root 1480 Oct 10 14:14 test5.o</span><br><span class="line"></span><br><span class="line">&gt; clang -c test5.cpp -O3 -std=gnu++17 -fno-exceptions</span><br><span class="line">&gt; <span class="built_in">ls</span> -l test5.o</span><br><span class="line">-rw-r--r-- 1 root root 1432 Oct 10 14:14 test5.o</span><br></pre></td></tr></table></figure>

<p>异常影响代码体积：</p>
<ul>
<li>启用异常后，每处可能抛出异常的函数调用，每处 <code>try&#123;&#125;catch&#123;&#125;</code> 异常捕获逻辑，编译器均会生成相关的 landing-pad 代码。编译器在 <code>.gcc_except_table</code> 段存储函数的异常表，包含在函数代码的特定部分中引发异常时要执行的相关操作。</li>
<li>相对于禁用异常，启用异常后二进制文件体积会增大约 10% ~ 20%。这也是 <a target="_blank" rel="noopener" href="https://llvm.org/docs/CodingStandards.html#do-not-use-rtti-or-exceptions">LLVM Coding Standards</a> 中禁用异常的原因。</li>
</ul>
<p>异常影响编译优化：</p>
<ul>
<li>理论上而言，编译器越先进，所生成的代码性能上（无异常抛出时）越是能接近禁用异常的场景。早期编译器这方面的能力不强，现代主流编译器已有较大改善。</li>
<li>编译器分析推导上下文时，越简单明确的分支｜行为可以令其做出更好的优化，同时也可提升编译速度。因此，明确不会抛出异常的函数，建议在函数定义和声明处均加上 <code>noexcept</code>。</li>
</ul>
<h2 id="C-语言异常"><a href="#C-语言异常" class="headerlink" title="C 语言异常"></a>C 语言异常</h2><p>C 语言没有原生的异常机制，可通过 <code>setjmp</code> &#x2F; <code>longjmp</code> 模拟实现类似的效果。</p>
<p>ref: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Setjmp.h">https://en.wikipedia.org/wiki/Setjmp.h</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test6.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">first</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">second</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Use a file scoped static variable for the exception stack so we can access</span></span><br><span class="line"><span class="comment"> * it anywhere within this translation unit. */</span></span><br><span class="line"><span class="type">static</span> jmp_buf exception_env;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> exception_type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TestFlag</span> &#123;</span><br><span class="line">  <span class="built_in">TestFlag</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;construct %s \n&quot;</span>, __func__); &#125;</span><br><span class="line">  ~<span class="built_in">TestFlag</span>() &#123;</span><br><span class="line">    <span class="comment">// no reachable</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;destruct %s. SHOULD NOT HAPPEN\n&quot;</span>, __func__);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> *<span class="keyword">volatile</span> mem_buffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">setjmp</span>(exception_env)) &#123;</span><br><span class="line">    <span class="comment">// if we get here there was an exception</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;first failed, exception type: %d\n&quot;</span>, exception_type);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Run code that may signal failure via longjmp.</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;calling first&quot;</span>);</span><br><span class="line">    <span class="built_in">first</span>();</span><br><span class="line"></span><br><span class="line">    mem_buffer = (<span class="type">char</span> *)(<span class="built_in">malloc</span>(<span class="number">300</span>)); <span class="comment">// allocate a resource</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="built_in">strcpy</span>(mem_buffer, <span class="string">&quot;first succeeded&quot;</span>)); <span class="comment">// not reached</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(mem_buffer); <span class="comment">// NULL can be passed to free, no operation is performed</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">first</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  jmp_buf my_env;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;entering first&quot;</span>); <span class="comment">// reached</span></span><br><span class="line"></span><br><span class="line">  TestFlag n;</span><br><span class="line"></span><br><span class="line">  std::<span class="built_in">memcpy</span>(my_env, exception_env, <span class="keyword">sizeof</span> my_env);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (<span class="built_in">setjmp</span>(exception_env)) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">// if we get here there was an exception.</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;second failed, exception type: 3; remapping to type 1&quot;</span>);</span><br><span class="line">    exception_type = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>: <span class="comment">// fall through</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(exception_env, my_env,</span><br><span class="line">                <span class="keyword">sizeof</span> exception_env);      <span class="comment">// restore exception stack</span></span><br><span class="line">    <span class="built_in">longjmp</span>(exception_env, exception_type); <span class="comment">// continue handling the exception</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:                   <span class="comment">// normal, desired operation</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;calling second&quot;</span>); <span class="comment">// reached</span></span><br><span class="line">    <span class="built_in">second</span>();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;second succeeded&quot;</span>); <span class="comment">// not reached</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::<span class="built_in">memcpy</span>(exception_env, my_env,</span><br><span class="line">              <span class="keyword">sizeof</span> exception_env); <span class="comment">// restore exception stack</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;leaving first&quot;</span>); <span class="comment">// never reached</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">second</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;entering second&quot;</span>); <span class="comment">// reached</span></span><br><span class="line"></span><br><span class="line">  exception_type = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">longjmp</span>(exception_env, exception_type); <span class="comment">// declare that the program has failed</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;leaving second&quot;</span>); <span class="comment">// not reached</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; clang test6.cpp -O3 -std=gnu++17 &amp;&amp; ./a.out</span><br><span class="line"></span><br><span class="line">calling first</span><br><span class="line">entering first</span><br><span class="line">construct TestFlag </span><br><span class="line">calling second</span><br><span class="line">entering second</span><br><span class="line">second failed, exception <span class="built_in">type</span>: 3; remapping to <span class="built_in">type</span> 1</span><br><span class="line">first failed, exception <span class="built_in">type</span>: 1</span><br></pre></td></tr></table></figure>

<p>这种方式比较灵活可控，异常链路下的性能可能优于 C++，但缺点也很明显：</p>
<ul>
<li>需要自建资源管控机制：longjmp 跳转后，无法逐级展开栈帧并清理残留数据；setjmp 仅保存寄存器相关数据，栈上对象无保护；</li>
<li>代码复杂度急剧增加</li>
</ul>
<h2 id="C-异常总结"><a href="#C-异常总结" class="headerlink" title="C++ 异常总结"></a>C++ 异常总结</h2><p>广义上说异常机制是牺牲异常链路性能来优化正常链路</p>
<ul>
<li>使用异常的代价是生成的二进制文件更大，编译速度更慢，异常捕获处理链路上性能极其糟糕（多线程环境下更甚）。切忌把异常用于普通的逻辑控制，建议在出现概率小于 0.1% 的错误中使用异常。<ul>
<li>如果出现错误后需要结束整个调用链路，可以抛出异常，并且建议在异常对象中包含函数调用链之类的关键信息。如果错误本身就是可预期的，则不建议用异常。</li>
<li>简而言之，不用分析调用栈的错误，多半无需使用异常</li>
</ul>
</li>
<li>相较于禁用异常，现代主流的 C++ 编译器已经能生成性能近似的代码（无异常抛出时），甚至于更进一步提升最短链路下的性能。<ul>
<li>建议评估代码逻辑是否需要用异常代替返回状态来压榨性能。这点比较适用于低延迟场景。<ul>
<li>或可根据业务场景，通过 <code>setjmp</code> &#x2F; <code>longjmp</code> 半手动构建更灵活的错误处理机制</li>
</ul>
</li>
<li>如果使用返回状态，理想情况下建议 <code>std::optional&lt; (1 ~ 8 byte) &gt;</code> &#x2F; <code>std::pair&lt;long, (1 ~ 8 byte) &gt;</code> &#x2F; <code>long</code> 这类返回值，以便于通过寄存器快速传值，调用方快速判断结果。</li>
</ul>
</li>
</ul>
<p>明确不会抛出异常的函数（例如 memcmp &#x2F; memcpy 等基础函数），建议在函数定义和声明处均加上 <code>noexcept</code>，以便于编译器做出更好的调用方优化。</p>
<ul>
<li>对于内联函数或定义可见的函数，编译器会自动识别</li>
</ul>
<p>异常机制对于 OOP 编程模式较为友好，可以增强代码的表达性和兼容性。当需要在大型项目代码中干脏活时，异常无疑是最快的选择。</p>
<ul>
<li>构造函数失败可抛出异常至上层，否则需引入二段式构造</li>
<li>重载运算符之类的标准接口或不易改造的历史接口</li>
<li>快速在繁杂逻辑中新开辟错误处理路径</li>
</ul>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="汇编基础"><a href="#汇编基础" class="headerlink" title="汇编基础"></a>汇编基础</h3><ul>
<li><code>push %?</code> 等价于 <code>sub $0x8,%rsp</code> + <code>mov %?,0x0(%rsp)</code></li>
<li><code>pop %?</code> 等价于 <code>mov 0x0(%rsp),%?</code> + <code>add $0x8,%rsp</code></li>
<li><code>callq ? &lt;?()&gt;</code> 等价于 <code>push %rip</code> + <code>jmpq ? &lt;?()&gt;</code></li>
<li><code>retq</code> 等价于 <code>push %rip</code> + <code>jmpq ? &lt;?()&gt;</code></li>
<li><code>callq ? &lt;?()&gt;</code> 执行前，必须保证 rsp 中的栈顶地址按照 16 对齐</li>
</ul>
<h3 id="x86-64-calling-conventions"><a href="#x86-64-calling-conventions" class="headerlink" title="x86_64 calling conventions"></a>x86_64 calling conventions</h3><p><a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf">x86_64-abi</a>：</p>
<blockquote>
<p>An Application Binary Interface (ABI) is the interface between two binary program modules that work together. An ABI is a contract between pieces of binary code defining the mechanisms by which functions are invoked and how parameters are passed between the caller and callee.</p>
</blockquote>
<hr>
<p><code>x86_64</code> 寄存器分类</p>
<ul>
<li><p>volatile (caller-saved) 寄存器：RAX, RCX, RDX, RDI, RSI, R8, R9, R10, R11, XMM*, YMM*</p>
<ul>
<li>通常用于存储临时数据，函数返回值，函数参数等</li>
</ul>
</li>
<li><p>nonvolatile (callee-saved) 寄存器：RBX, RBP, RSP, R12, R13, R14, R15</p>
<ul>
<li>寄存器数据在函数调用前后必须保持一致<ul>
<li>如果函数内需要改动寄存器数据，通用的做法是在栈上保存原始数据并还原</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p><a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf">System V Application Binary Interface AMD64 Architecture Processor Supplement: 3.2.3 Parameter Passing</a></p>
<p>函数参数传递规范：</p>
<ul>
<li>当函数非浮点数参数少于 7 个时，参数从左到右放入寄存器: RDI, RSI, RDX, RCX, R8, R9；当参数为 7 个及以上时，第 7 个参数开始依次从 <code>右向左</code> 放入栈中（栈地址自高到低）；</li>
<li>XMM0 ~ XMM7 传递前 8 个浮点数参数，其他通过内存传递</li>
<li>结构体参数传递规则相对复杂，详见文档</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">F</span>(a, b, c, d, e, f, g, h, <span class="type">double</span> x0 ... <span class="type">double</span> x7, <span class="type">double</span> x8)</span><br><span class="line">a: %rdi</span><br><span class="line">b: %rsi</span><br><span class="line">c: %rdx</span><br><span class="line">d: %rcx</span><br><span class="line">e: %r8</span><br><span class="line">f: %r9</span><br><span class="line">g: <span class="number">0x8</span>(%rsp)</span><br><span class="line">h: <span class="number">0x16</span>(%rsp)</span><br><span class="line">x0 ~ x7: xmm0 ~ xmm7</span><br><span class="line">x8: <span class="number">0x24</span>(%rsp)</span><br></pre></td></tr></table></figure>

<p>函数返回值规范：</p>
<ul>
<li>返回值小于等于 2 个：RAX 用于保存第 1 个返回值，RDX 用于保存第 2 个返回值； XMM0 和 XMM1 存储前 2 个浮点数返回值；</li>
<li>返回值大于 2 个：由调用方开辟内存空间，并将地址作为第 1 个参数传入 RDI。被调用方将所有返回值依次保存到相关内存空间后，保存起始地址到 RAX。</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://releases.llvm.org/15.0.0/docs/ExceptionHandling.html">https://releases.llvm.org/15.0.0/docs/ExceptionHandling.html</a></li>
<li><a target="_blank" rel="noopener" href="https://maskray.me/blog/2020-11-08-stack-unwinding">https://maskray.me/blog/2020-11-08-stack-unwinding</a></li>
<li><a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf">https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html">https://itanium-cxx-abi.github.io/cxx-abi/abi-eh.html</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10787766/when-should-i-really-use-noexcept">https://stackoverflow.com/questions/10787766/when-should-i-really-use-noexcept</a></li>
<li><a target="_blank" rel="noopener" href="https://monkeywritescode.blogspot.com/p/c-exceptions-under-hood.html">https://monkeywritescode.blogspot.com/p/c-exceptions-under-hood.html</a></li>
<li><a target="_blank" rel="noopener" href="https://isocpp.org/wiki/faq/exceptions">https://isocpp.org/wiki/faq/exceptions</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Call_stack">https://en.wikipedia.org/wiki/Call_stack</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/Exception/" rel="tag"># Exception</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/07/18/pingcap/materialized-view-demo/" rel="prev" title="Materialized View Simple Demo | TiDB">
                  <i class="fa fa-chevron-left"></i> Materialized View Simple Demo | TiDB
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TONG, Zhigao</span>
</div>

    </div>
  </footer>

  
  <script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/lib/hexo-generator-searchdb/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>

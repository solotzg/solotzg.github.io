<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="/lib/animate.css/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"solotzg.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"manual","top_n_per_article":5,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="面向 C艹（aka C++ or CPP）的开发规范一直都比较松散，各个组织包括个体总能在不轻易间把项目堆成 xxxx xxxxxxxx。  随着工程规模增大，TiFlash 项目也逐渐开始暴露出这类问题：  头文件凌乱 模板滥用 编译缓慢 工程质量愈发难以控制  本文旨在提供量化指标和参考方法用以优化 C++ 工程项目的编译流程。希望动员社区的力量，一起来优化 TiFlash 的工程质量。">
<meta property="og:type" content="article">
<meta property="og:title" content="C++ 项目编译优化 —— TiFlash">
<meta property="og:url" content="https://solotzg.github.io/2022/06/01/system/cpp-compile-optimize/index.html">
<meta property="og:site_name" content="SOLOTZG">
<meta property="og:description" content="面向 C艹（aka C++ or CPP）的开发规范一直都比较松散，各个组织包括个体总能在不轻易间把项目堆成 xxxx xxxxxxxx。  随着工程规模增大，TiFlash 项目也逐渐开始暴露出这类问题：  头文件凌乱 模板滥用 编译缓慢 工程质量愈发难以控制  本文旨在提供量化指标和参考方法用以优化 C++ 工程项目的编译流程。希望动员社区的力量，一起来优化 TiFlash 的工程质量。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://solotzg.github.io/images/speedscope.app-example.gif">
<meta property="article:published_time" content="2022-06-01T04:09:08.000Z">
<meta property="article:modified_time" content="2023-09-14T13:50:11.696Z">
<meta property="article:author" content="TONG, Zhigao">
<meta property="article:tag" content="TiFlash">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Compiler">
<meta property="article:tag" content="CompilerFrontend">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://solotzg.github.io/images/speedscope.app-example.gif">


<link rel="canonical" href="https://solotzg.github.io/2022/06/01/system/cpp-compile-optimize/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://solotzg.github.io/2022/06/01/system/cpp-compile-optimize/","path":"2022/06/01/system/cpp-compile-optimize/","title":"C++ 项目编译优化 —— TiFlash"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>C++ 项目编译优化 —— TiFlash | SOLOTZG</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">SOLOTZG</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">基础概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">编译流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ClangBuildAnalyzer-%E5%88%86%E6%9E%90%E7%BB%93%E6%9E%9C%EF%BC%88%E6%9C%AA%E4%BC%98%E5%8C%96%EF%BC%89"><span class="nav-number">2.1.</span> <span class="nav-text">ClangBuildAnalyzer 分析结果（未优化）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">编译优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF"><span class="nav-number">3.1.</span> <span class="nav-text">模板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="nav-number">3.1.1.</span> <span class="nav-text">模板实例化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%881-0%EF%BC%89"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">案例（1.0）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%EF%BC%881-0%EF%BC%89"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">分析（1.0）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%881-0-1%EF%BC%89"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">案例（1.0.1）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%881-0-2%EF%BC%89"><span class="nav-number">3.1.1.4.</span> <span class="nav-text">案例（1.0.2）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%881-1%EF%BC%89"><span class="nav-number">3.1.1.5.</span> <span class="nav-text">案例（1.1）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%881-2%EF%BC%89"><span class="nav-number">3.1.1.6.</span> <span class="nav-text">案例（1.2）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E5%87%8F%E9%87%8D%E5%A4%8D%E6%A8%A1%E6%9D%BF%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="nav-number">3.1.2.</span> <span class="nav-text">删减重复模板实例化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%882-0%EF%BC%89"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">案例（2.0）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%EF%BC%882%EF%BC%89"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">分析（2）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%86%E5%88%86%EF%BD%9C%E5%90%88%E5%B9%B6%E7%BC%96%E8%AF%91%E5%8D%95%E5%85%83"><span class="nav-number">3.1.3.</span> <span class="nav-text">拆分｜合并编译单元</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%98%BE%E5%BC%8F%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="nav-number">3.1.4.</span> <span class="nav-text">显式实例化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%883-0%EF%BC%89"><span class="nav-number">3.1.4.1.</span> <span class="nav-text">案例（3.0）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%BD%E8%B1%A1%E5%87%BA-ABI-%E7%A8%B3%E5%AE%9A%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.1.5.</span> <span class="nav-text">抽象出 ABI 稳定接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%883-1%EF%BC%89"><span class="nav-number">3.1.5.1.</span> <span class="nav-text">案例（3.1）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%B4%E6%96%87%E4%BB%B6%E4%BC%98%E5%8C%96"><span class="nav-number">3.2.</span> <span class="nav-text">头文件优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%B4%E6%96%87%E4%BB%B6%E4%BE%9D%E8%B5%96"><span class="nav-number">3.2.1.</span> <span class="nav-text">头文件依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%90%91%E5%A3%B0%E6%98%8E"><span class="nav-number">3.2.2.</span> <span class="nav-text">前向声明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%884-0%EF%BC%89"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">案例（4.0）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%EF%BC%884%EF%BC%89"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">分析（4）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%884-1%EF%BC%89"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">案例（4.1）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E7%BC%96%E8%AF%91%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88PCH%EF%BC%89"><span class="nav-number">3.2.3.</span> <span class="nav-text">预编译头文件（PCH）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%884-2%EF%BC%89"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">案例（4.2）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PImpl"><span class="nav-number">3.2.4.</span> <span class="nav-text">PImpl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%885-0%EF%BC%89"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">案例（5.0）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LTO%EF%BC%88Link-Time-Optimization%EF%BC%89"><span class="nav-number">3.3.</span> <span class="nav-text">LTO（Link Time Optimization）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%886-0%EF%BC%89"><span class="nav-number">3.3.1.</span> <span class="nav-text">案例（6.0）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PGO%EF%BC%88Profile-Guided-Optimization%EF%BC%89"><span class="nav-number">3.4.</span> <span class="nav-text">PGO（Profile-Guided Optimization）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%887-0%EF%BC%89"><span class="nav-number">3.4.1.</span> <span class="nav-text">案例（7.0）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%887-1%EF%BC%89"><span class="nav-number">3.4.2.</span> <span class="nav-text">案例（7.1）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Post-link-Optimizer"><span class="nav-number">3.5.</span> <span class="nav-text">Post-link Optimizer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E7%BC%93%E5%AD%98"><span class="nav-number">3.6.</span> <span class="nav-text">编译缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A4%BE%E5%8C%BA%EF%BD%9C%E6%96%B0%E5%BC%80%E5%8F%91%E8%80%85%E5%A6%82%E4%BD%95%E5%8F%82%E4%B8%8E%E4%BC%98%E5%8C%96-TiFlash-%E9%A1%B9%E7%9B%AE"><span class="nav-number">4.</span> <span class="nav-text">社区｜新开发者如何参与优化 TiFlash 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E7%9B%AE%E6%A0%87"><span class="nav-number">4.1.</span> <span class="nav-text">优化目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="nav-number">4.2.</span> <span class="nav-text">参考文档</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="TONG, Zhigao"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">TONG, Zhigao</p>
  <div class="site-description" itemprop="description">Blogs</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/solotzg" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;solotzg" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:solotzg@gmail.com" title="E-Mail → mailto:solotzg@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://solotzg.github.io/2022/06/01/system/cpp-compile-optimize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="TONG, Zhigao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SOLOTZG">
      <meta itemprop="description" content="Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="C++ 项目编译优化 —— TiFlash | SOLOTZG">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C++ 项目编译优化 —— TiFlash
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-01 12:09:08" itemprop="dateCreated datePublished" datetime="2022-06-01T12:09:08+08:00">2022-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-14 21:50:11" itemprop="dateModified" datetime="2023-09-14T21:50:11+08:00">2023-09-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/System/" itemprop="url" rel="index"><span itemprop="name">System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>面向 <code>C艹</code>（aka <code>C++</code> or <code>CPP</code>）的开发规范一直都比较松散，各个组织包括个体总能在不轻易间把项目堆成 xxxx xxxxxxxx。</p>
</blockquote>
<p>随着工程规模增大，<a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash">TiFlash</a> 项目也逐渐开始暴露出这类问题：</p>
<ul>
<li>头文件凌乱</li>
<li>模板滥用</li>
<li>编译缓慢</li>
<li>工程质量愈发难以控制</li>
</ul>
<p>本文旨在提供量化指标和参考方法用以优化 C++ 工程项目的编译流程。希望动员社区的力量，一起来优化 TiFlash 的工程质量。</p>
<span id="more"></span>
<h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><p>普遍定义上，完整的编译流程分为以下几个流程：预处理（Prepressing），编译（Compilation）&amp; 汇编（Assembly），链接（Linking）。相比于 GCC，LLVM 则有明显的前端（Frontend）后端（Backend）之分：</p>
<ul>
<li>前端包括：处理头文件（Source），类&#x2F;模板类解析（ParseClass），模版类实例化（InstantiateClass），模版函数解析（ParseTemplate），模版函数实例化（InstantiateFunction），代码生成（CodeGen Function）等。</li>
<li>后端则主要是以 <a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">Pass 框架</a> 为基础的流程，可在 <a target="_blank" rel="noopener" href="https://llvm.org/doxygen/namespacellvm.html">llvm-project&#x2F;namespaces</a> 中查看细节的实现。</li>
</ul>
<p>C++ 编译器以源文件为编译单元，基本流程可参考 <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/translation_phases">Phases of translation</a>。<a href="https://solotzg.github.io/2022/03/30/system/linux-dynamic-library/#Linux-%E5%8A%A8%E6%80%81%E5%BA%93">Linux 动态链接库相关整理#Linux-动态库</a> 这篇文章介绍过相关的几个案例（主要偏后端和链接器），可供参考。</p>
<p><strong>以下所有的内容均默认编译器为 clang。</strong></p>
<h1 id="编译流程分析"><a href="#编译流程分析" class="headerlink" title="编译流程分析"></a>编译流程分析</h1><p>编译 TiFlash 时加上 cmake 项 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/CMakeLists.txt#L106-L112">-DENABLE_TIME_TRACES&#x3D;ON</a>，即增加 clang 编译参数 <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/ClangCommandLineReference.html#cmdoption-clang-ftime-trace">-ftime-trace</a>，令编译每个目标文件时以 <code>json</code> 格式输出相关分析追踪数据。可通过 <a href="chrome://tracing">chrome:&#x2F;&#x2F;tracing</a> 或网站 <a target="_blank" rel="noopener" href="https://www.speedscope.app/">Speedscope App</a> 查看火焰图。<img src="/images/speedscope.app-example.gif" alt="FlameGraphsExample"></p>
<p>以这个 commit 的 TiFlash 代码为例 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/commit/2d234262eb551b04b0ce304c7c6bacac847ca264">2d234262eb551b04b0ce304c7c6bacac847ca264</a>。编译完成后，可以在编译路径 <code>$&#123;TIFLASH_BUILD_DIR&#125;</code> 下找到各个目标文件对应的 json 文件，例如 <code>$&#123;TIFLASH_BUILD_DIR&#125;/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/FunctionsTiDBConversion.cpp.json</code>。根据文章 <a target="_blank" rel="noopener" href="https://aras-p.info/blog/2019/09/28/Clang-Build-Analyzer">Aras Pranckevičius - Clang Build Analyzer</a>，通过工具 <a target="_blank" rel="noopener" href="https://github.com/aras-p/ClangBuildAnalyzer.git">ClangBuildAnalyzer</a> 分析 TiFlash 编译过程的各项属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/aras-p/ClangBuildAnalyzer.git</span><br><span class="line"><span class="built_in">cd</span> ClangBuildAnalyzer</span><br><span class="line">make -f projects/make/Makefile</span><br><span class="line">tmpfile=$(<span class="built_in">mktemp</span> /tmp/ClangBuildAnalyzer-capture_file.XXXXXX)</span><br><span class="line">./build/ClangBuildAnalyzer --all <span class="variable">$&#123;TIFLASH_BUILD_DIR&#125;</span> <span class="variable">$&#123;tmpfile&#125;</span> </span><br><span class="line">./build/ClangBuildAnalyzer --analyze <span class="variable">$&#123;tmpfile&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果如下，前端居然比后端的总耗时还大，这非常 <strong>不合理</strong>。以下各个章节将针对此进行分析并简述优化过程。</p>
<h2 id="ClangBuildAnalyzer-分析结果（未优化）"><a href="#ClangBuildAnalyzer-分析结果（未优化）" class="headerlink" title="ClangBuildAnalyzer 分析结果（未优化）"></a>ClangBuildAnalyzer 分析结果（未优化）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">**** Time summary:</span><br><span class="line">Compilation (5485 times):</span><br><span class="line">  Parsing (frontend):         7181.8 s</span><br><span class="line">  Codegen &amp; opts (backend):   6224.5 s</span><br><span class="line"></span><br><span class="line">**** Files that took longest to parse (compiler frontend):</span><br><span class="line">185258 ms: /data2/work/build-llvm-tiflash/dbms/src/Flash/CMakeFiles/flash_service.dir/Coprocessor/DAGExpressionAnalyzerHelper.cpp.o</span><br><span class="line">182847 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/FunctionsTiDBConversion.cpp.o</span><br><span class="line">181468 ms: /data2/work/build-llvm-tiflash/dbms/src/Flash/CMakeFiles/flash_service.dir/Coprocessor/DAGExpressionAnalyzer.cpp.o</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">**** Files that took longest to codegen (compiler backend):</span><br><span class="line">406975 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/divide.cpp.o</span><br><span class="line">205837 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/FunctionsComparison.cpp.o</span><br><span class="line">205416 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/FunctionsTiDBConversion.cpp.o</span><br><span class="line">179111 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/modulo.cpp.o</span><br><span class="line">142676 ms: /data2/work/build-llvm-tiflash/dbms/CMakeFiles/dbms.dir/src/Dictionaries/CacheDictionary.cpp.o</span><br><span class="line">133467 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/least.cpp.o</span><br><span class="line">131571 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/greatest.cpp.o</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">**** Templates that took longest to instantiate:</span><br><span class="line">247991 ms: DB::FunctionTiDBCast::createWrapper&lt;false&gt; (3 times, avg 82663 ms)</span><br><span class="line">240476 ms: DB::FunctionTiDBCast::createWrapper&lt;true&gt; (3 times, avg 80158 ms)</span><br><span class="line">228596 ms: std::__function::__func&lt;(lambda at /root/work/tiflash/dbms/src/Functions/FunctionsTiDBC... (7200 times, avg 31 ms)</span><br><span class="line">227424 ms: std::__function::__func&lt;(lambda at /root/work/tiflash/dbms/src/Functions/FunctionsTiDBC... (7200 times, avg 31 ms)</span><br><span class="line">194991 ms: std::function&lt;void (DB::Block &amp;, const std::vector&lt;unsigned long&gt; &amp;, unsigned long, bool, const ti... (2400 times, avg 81 ms)</span><br><span class="line">194077 ms: std::function&lt;void (DB::Block &amp;, const std::vector&lt;unsigned long&gt; &amp;, unsigned long, bool, const ti... (2400 times, avg 80 ms)</span><br><span class="line">193740 ms: std::__function::__value_func&lt;void (DB::Block &amp;, const std::vector&lt;unsigned long&gt; &amp;, unsigned long... (2400 times, avg 80 ms)</span><br><span class="line">192884 ms: std::__function::__value_func&lt;void (DB::Block &amp;, const std::vector&lt;unsigned long&gt; &amp;, unsigned long... (2400 times, avg 80 ms)</span><br><span class="line">191873 ms: std::__function::__value_func&lt;void (DB::Block &amp;, const std::vector&lt;unsigned long&gt; &amp;, unsigned long... (2400 times, avg 79 ms)</span><br><span class="line">191093 ms: std::__function::__value_func&lt;void (DB::Block &amp;, const std::vector&lt;unsigned long&gt; &amp;, unsigned long... (2400 times, avg 79 ms)</span><br><span class="line">132499 ms: DB::castTypeToEither&lt;DB::DataTypeNumber&lt;unsigned char&gt;, DB::DataTypeNumber&lt;unsigned short&gt;, DB::Da... (20 times, avg 6624 ms)</span><br><span class="line">132198 ms: DB::castTypeToEither&lt;DB::DataTypeNumber&lt;unsigned char&gt;, DB::DataTypeNumber&lt;unsigned short&gt;, DB::Da... (320 times, avg 413 ms)</span><br><span class="line">131016 ms: std::__function::__alloc_func&lt;(lambda at /root/work/tiflash/dbms/src/Functions/Function... (7200 times, avg 18 ms)</span><br><span class="line">130531 ms: std::__function::__alloc_func&lt;(lambda at /root/work/tiflash/dbms/src/Functions/Function... (7200 times, avg 18 ms)</span><br><span class="line">128066 ms: DB::castTypeToEither&lt;DB::DataTypeNumber&lt;unsigned char&gt;, DB::DataTypeNumber&lt;unsigned short&gt;, DB::Da... (5120 times, avg 25 ms)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">**** Template sets that took longest to instantiate:</span><br><span class="line">734148 ms: std::function&lt;$&gt;::function&lt;$&gt; (9422 times, avg 77 ms)</span><br><span class="line">729456 ms: std::__function::__value_func&lt;$&gt;::__value_func&lt;$&gt; (9422 times, avg 77 ms)</span><br><span class="line">598582 ms: std::__function::__func&lt;$&gt;::__func (9422 times, avg 63 ms)</span><br><span class="line">494799 ms: std::__function::__alloc_func&lt;$&gt;::__alloc_func (28266 times, avg 17 ms)</span><br><span class="line">488467 ms: DB::FunctionTiDBCast::createWrapper&lt;$&gt; (6 times, avg 81411 ms)</span><br><span class="line">419445 ms: DB::FunctionTiDBCast::createWrapperForDecimal&lt;$&gt; (480 times, avg 873 ms)</span><br><span class="line">381118 ms: std::forward_as_tuple&lt;$&gt; (39069 times, avg 9 ms)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">**** Function sets that took longest to compile / optimize:</span><br><span class="line">31177 ms: DB::IAggregateFunctionHelper&lt;$&gt;::addBatchLookupTable8(unsigned long, char**, unsigned long, std::__1::function&lt;$&gt;, unsigned char const*, DB::IColumn const**, DB::Arena*) const (1250 times, avg 24 ms)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">*** Expensive headers:</span><br><span class="line">1091837 ms: /root/work/tiflash/dbms/src/Common/FmtUtils.h (included 750 times, avg 1455 ms), included via:</span><br><span class="line">1022467 ms: /root/work/tiflash/libs/libcommon/include/common/StringRef.h (included 754 times, avg 1356 ms), included via:</span><br><span class="line">985876 ms: /root/work/tiflash/dbms/src/Common/Exception.h (included 748 times, avg 1318 ms), included via:</span><br><span class="line">974680 ms: /root/work/tiflash/dbms/src/Common/StackTrace.h (included 749 times, avg 1301 ms), included via:</span><br><span class="line">681167 ms: /data2/tiflash-env/sysroot/include/c++/v1/string (included 1903 times, avg 357 ms), included via:</span><br><span class="line">501559 ms: /data2/tiflash-env/sysroot/include/c++/v1/algorithm (included 1969 times, avg 254 ms), included via:</span><br><span class="line">498058 ms: /root/work/tiflash/dbms/src/Columns/IColumn.h (included 516 times, avg 965 ms), included via:</span><br><span class="line">422329 ms: /root/work/tiflash/dbms/src/Core/Types.h (included 706 times, avg 598 ms), included via:</span><br><span class="line">405688 ms: /data2/tiflash-env/sysroot/include/c++/v1/functional (included 1971 times, avg 205 ms), included via:</span><br></pre></td></tr></table></figure>

<h1 id="编译优化"><a href="#编译优化" class="headerlink" title="编译优化"></a>编译优化</h1><p>目前使用的工具链是 LLVM-13，链接器 <a target="_blank" rel="noopener" href="https://lld.llvm.org/">LLD</a> 性能已经足够好，所以链接过程的速度暂时构不成瓶颈（理论上还有更快的 <a target="_blank" rel="noopener" href="https://github.com/rui314/mold">mold</a>）。为获得更好的编译优化效果，较为推荐的是 <a href="#LTO%EF%BC%88Link-Time-Optimization%EF%BC%89">LTO</a>，不过代价就是更大的链接耗时和内存消耗。对于成熟的项目，利用 <a href="#PGO%EF%BC%88Profile-Guided-Optimization%EF%BC%89">PGO</a> 或 <a href="#Post-link-Optimizer">Post-link Optimizer</a> 也可获得可观的收益。</p>
<p>就绝大部分实际场景而言（尤其是滥用模板的场景），少生成重复代码，便足以有效减轻后端的负担。</p>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><blockquote>
<p>对于大多数 C++ 工程项目而言，<strong>滥用</strong> 模板是万恶之源。</p>
</blockquote>
<h3 id="模板实例化"><a href="#模板实例化" class="headerlink" title="模板实例化"></a>模板实例化</h3><p><strong>模板在什么时候会被实例化？</strong></p>
<h4 id="案例（1-0）"><a href="#案例（1-0）" class="headerlink" title="案例（1.0）"></a>案例（1.0）</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test1.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line">  std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; d_;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// test1.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test1.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang++ -c test1.cpp -o test1.o -ftime-trace -std=gnu++17</span><br><span class="line">// get test1.json</span><br></pre></td></tr></table></figure>

<p>用浏览器打开 test1.json 查看火焰图可知 <code>std::unordered_map&lt;int, int&gt;</code> 已经被实例化，且属于前端行为 ParseClass。意味着编译包含 test1.h 的源文件时均会产生这一重复行为。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">InstantiateClass &#123;&quot;detail&quot;:&quot;std::__1::unordered_map&lt;int, int, std::__1::hash&lt;int&gt;, std::__1::equal_to&lt;int&gt;, std::__1::allocator&lt;std::__1::pair&lt;const int, int&gt; &gt; &gt;&quot;&#125;</span><br><span class="line">&gt; ParseClass &#123;&quot;detail&quot;:&quot;Test1&quot;&#125;</span><br><span class="line">&gt; Frontend</span><br><span class="line">&gt; ExecuteCompiler</span><br></pre></td></tr></table></figure>

<p>对于 test4 和 test5 也是同样效果。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test4.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test4</span> &#123;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function">std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; <span class="title">test4</span><span class="params">(T)</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test5.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">int</span> <span class="title">test5</span><span class="params">(T)</span> </span>&#123; std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; s; &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test6.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">struct</span> <span class="title class_">Test1</span> &#123; std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; d_; &#125;;</span><br></pre></td></tr></table></figure>

<hr>
<p>然而，对于下面的 test2，火焰图中却看不到 <code>std::unordered_map&lt;int, int&gt;</code> 被实例化的过程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test2.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test2</span> &#123;</span><br><span class="line">  <span class="function">std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; <span class="title">test2</span><span class="params">(std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;)</span></span>;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="function">std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; <span class="title">test2_1</span><span class="params">(std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; <span class="title">test2_2</span><span class="params">(std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="分析（1-0）"><a href="#分析（1-0）" class="headerlink" title="分析（1.0）"></a>分析（1.0）</h4><p>对于编译过程来说 <strong>函数</strong> 和 <strong>变量</strong> 本身就是符号，编译器前端推导基于一定的规则。对于上述案例：</p>
<ul>
<li>test2 中虽然声明了 <code>std::unordered_map&lt;int, int&gt;</code> 类型，但没有被实际的结构体定义或者函数实现依赖，编译器也就不需要实例化模板。</li>
<li>对于 test1&#x2F;test4&#x2F;test5&#x2F;test6，编译器解析类或模板时识别出类模板 <code>std::unordered_map</code> 在结构体或函数实现中被完整定义为 <code>std::unordered_map&lt;int, int&gt;</code> 类型，然后实例化该模板类。<ul>
<li>test1：普通类成员函数</li>
<li>test4：模板函数返回值</li>
<li>test5：模板函数实现过程</li>
<li>test6：模板类成员函数</li>
</ul>
</li>
</ul>
<p><strong>需要重点关注的是</strong>：模板虽然在使用时可以看作是高级的宏命令，但如 test4&#x2F;test5&#x2F;test6 结果所示，即便编译单元最终生成的目标文件是空的（没有实际代码用到模板），编译器还是会推导并实例化模板。这个行为不符合常理，估计得看 C++20 的 <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/modules">Modules</a> 能否完善。目前而言，只能靠优化模板定义和头文件依赖，或者参考 <a href="#PImpl">PImpl</a>，<a href="#%E9%A2%84%E7%BC%96%E8%AF%91%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88PCH%EF%BC%89">PCH</a> 技术。</p>
<h4 id="案例（1-0-1）"><a href="#案例（1-0-1）" class="headerlink" title="案例（1.0.1）"></a>案例（1.0.1）</h4><p>类似于 test1.cpp 的场景理论上比较容易用 PImpl 改造。倘若是性能攸关的代码，无法忍受 PImpl 带来的局部性损失，可参考下面的方式，代价就是牺牲代码可读性以及使用模板的便利性。</p>
<ul>
<li><code>std::unordered_map&lt;int, int&gt;</code> aka <code>Data</code></li>
<li>令 <code>Test7::Inner</code> 的内存大小和对齐方式适配不同编译平台<ul>
<li>内存对齐方式（8 Bytes）与 <code>Data</code> 相同（暂不考虑非 64 位平台或其他小众平台）。</li>
<li><code>Data</code> 在 MacOS 下是 40 Bytes，而 Linux 下则是 56 Bytes，本例子中直接取最大值（或可通过宏定义判断编译平台再设置大小）。</li>
</ul>
</li>
<li>在源文件中加上 <code>static_assert</code> 以防止其他改动破坏基本假设。</li>
<li><code>Test7</code> 内部封装构造&#x2F;析构、以及转换相关接口。</li>
<li>当头文件 test7.h 被其他不相干的源文件所包含，编译器前端解析 <code>struct Test7</code> 时则不需要再实例化 <code>std::unordered_map&lt;int, int&gt;</code>。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test7.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> Data = std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test7</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Inner</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">      <span class="built_in">alignas</span>(<span class="number">8</span>) <span class="type">char</span> _;</span><br><span class="line">    &#125; _[<span class="number">7</span>];</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function">Data &amp;<span class="title">data</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">const</span> Data &amp;<span class="title">data</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="built_in">Test7</span>();</span><br><span class="line">  ~<span class="built_in">Test7</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  Inner data_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test7.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test7.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(Test7::Inner) &gt;= <span class="built_in">sizeof</span>(Data));</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">alignof</span>(Test7::Inner) == <span class="built_in">alignof</span>(Data));</span><br><span class="line"><span class="function">Data &amp;<span class="title">Test7::data</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;Data *&gt;(&amp;data_); &#125;</span><br><span class="line"><span class="function"><span class="type">const</span> Data &amp;<span class="title">Test7::data</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> Data *&gt;(&amp;data_);</span><br><span class="line">&#125;</span><br><span class="line">Test7::<span class="built_in">Test7</span>() &#123; <span class="keyword">new</span> (&amp;<span class="built_in">data</span>()) <span class="built_in">Data</span>(); &#125;</span><br><span class="line">Test7::~<span class="built_in">Test7</span>() &#123;</span><br><span class="line">  <span class="built_in">static_assert</span>(std::is_destructible_v&lt;Data&gt;);</span><br><span class="line">  <span class="built_in">data</span>().~<span class="built_in">Data</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="案例（1-0-2）"><a href="#案例（1-0-2）" class="headerlink" title="案例（1.0.2）"></a>案例（1.0.2）</h4><p>类似 test4、test5、test6 的场景，可以将 <code>std::unordered_map&lt;int, int&gt;</code> 从模板实现之处消去，由调用方通过模板参数传入类型。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test8.h</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test4</span> &#123;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> MAP&gt; <span class="function">MAP <span class="title">test4</span><span class="params">(T)</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> MAP&gt; <span class="function"><span class="type">int</span> <span class="title">test5</span><span class="params">(T)</span> </span>&#123; MAP s; &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> MAP&gt; <span class="keyword">struct</span> <span class="title class_">Test1</span> &#123; MAP d_; &#125;;</span><br><span class="line"><span class="comment">// test8.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test8.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; Test1&lt;<span class="type">void</span>, std::unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&gt;(); &#125;</span><br></pre></td></tr></table></figure>

<h4 id="案例（1-1）"><a href="#案例（1-1）" class="headerlink" title="案例（1.1）"></a>案例（1.1）</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test9.cpp</span></span><br><span class="line"><span class="comment">// test9.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> V&gt; <span class="keyword">struct</span> <span class="title class_">Test9_2</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; b ? <span class="built_in">goo</span>&lt;<span class="type">float</span>&gt;() : <span class="built_in">goo</span>&lt;<span class="type">double</span>&gt;(); &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">goo</span><span class="params">()</span> </span>&#123; std::optional&lt;T&gt;&#123;&#125;; &#125;</span><br><span class="line">  std::optional&lt;V&gt; v_;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test9_1</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">bool</span> b)</span> </span>&#123; b ? <span class="built_in">goo</span>&lt;<span class="type">int</span>&gt;() : <span class="built_in">goo</span>&lt;<span class="type">bool</span>&gt;(); &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">koo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">goo</span>&lt;<span class="type">int64_t</span>&gt;();</span><br><span class="line">    Test9_2&lt;<span class="type">char</span>&gt;&#123;&#125;.<span class="built_in">foo</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">goo</span><span class="params">()</span> </span>&#123; std::optional&lt;T&gt;&#123;&#125;; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// template struct Test9_2&lt;&gt;; // InstantiateFunction&#123;&quot;detail&quot;:&quot;Test9_2&lt;&gt;::goo&lt;float&gt;&quot;&#125; and InstantiateFunction&#123;&quot;detail&quot;:&quot;Test9_2&lt;&gt;::goo&lt;double&gt;&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<p>test9 中可以看到编译器前端在 PerformPendingInstantiations 阶段，实例化了模板函数 <code>Test9_1::goo&lt;int&gt;</code>，<code>Test9_1::goo&lt;bool&gt;</code>。因为编译器解析普通类成员函数 <code>Test9_1::foo</code> 的实现，至少要推导出这 2 个依赖函数的完整上下文，否则就会失败报错。<br>模板函数 <code>Test9_1::koo</code> 中调用了其他模板函数 <code>Test9_1::goo&lt;int64_t&gt;</code> 和 <code>Test9_2&lt;char&gt;::foo</code>。但这种仅仅在函数模板内调用其他模板函数的行为，编译器则默认不会实例化模板函数。同理，对于类模板 <code>Test9_2</code>，当显式声明实例化（<code>template struct Test9_2&lt;&gt;;</code>）后才能看到被实例化的模板函数 <code>Test9_2&lt;&gt;::goo&lt;float&gt;</code> 和 <code>Test9_2&lt;&gt;::goo&lt;double&gt;</code>。</p>
<h4 id="案例（1-2）"><a href="#案例（1-2）" class="headerlink" title="案例（1.2）"></a>案例（1.2）</h4><p>test10 中的 <code>struct Test10</code> 同时定义了 3 个成员函数，并 <strong>显式</strong> 地实现了 <code>Test10::goo</code>，最终只有 <code>Test10::goo</code> 生成了对应的符号和汇编。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test10.cpp</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test10</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span>...&gt; <span class="function"><span class="type">int</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">3</span>; &#125;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">goo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Test10::goo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ clang++ -c test10.cpp -o test10.o -ftime-trace -std=gnu++17</span><br><span class="line">➜ nm -C test10.o </span><br><span class="line">0000000000000000 T Test10::goo()</span><br></pre></td></tr></table></figure>

<p>当编译单元存在其他函数实现依赖 <code>Test10::foo</code> 和 <code>Test10::foo2&lt;&gt;</code> 时，才会生成相关的符号和汇编。对于这种 <strong>非显式</strong> 定义的函数，符号类型被设为 <code>W / w（弱态）</code>，待链接时去重（<strong>即便不同源文件使用了相同头文件（例如各种 STL），最后也不会产生冲突</strong>）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test10.cpp</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test10</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span>...&gt; <span class="function"><span class="type">int</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">3</span>; &#125;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">goo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Test10::goo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">koo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Test10&#123;&#125;.<span class="built_in">foo</span>() + Test10&#123;&#125;.<span class="built_in">foo2</span>(); &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜ clang++ -c test10.cpp -o test10.o -ftime-trace -std=gnu++17</span><br><span class="line">➜ nm -C test10.o </span><br><span class="line">0000000000000010 T koo()</span><br><span class="line">0000000000000000 W Test10::foo()</span><br><span class="line">0000000000000000 T Test10::goo()</span><br><span class="line">0000000000000000 W int Test10::foo2&lt;&gt;()</span><br></pre></td></tr></table></figure>

<h3 id="删减重复模板实例化"><a href="#删减重复模板实例化" class="headerlink" title="删减重复模板实例化"></a>删减重复模板实例化</h3><h4 id="案例（2-0）"><a href="#案例（2-0）" class="headerlink" title="案例（2.0）"></a>案例（2.0）</h4><p>根据 <a href="#ClangBuildAnalyzer-%E5%88%86%E6%9E%90%E7%BB%93%E6%9E%9C%EF%BC%88%E6%9C%AA%E4%BC%98%E5%8C%96%EF%BC%89">ClangBuildAnalyzer 分析结果</a>，排名靠前的 FunctionsTiDBConversion.cpp，DAGExpressionAnalyzer.cpp，DAGExpressionAnalyzerHelper.cpp 都是重度模板使用者。而且 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L2177-L2178"><code>template &lt;bool return_nullable&gt; WrapperType createWrapper</code></a> 是实例化耗时最久的模板函数。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">InstantiateFunction &#123;&quot;detail&quot;:&quot;DB::FunctionTiDBCast::createWrapper&lt;true&gt;&quot;&#125;</span><br><span class="line">&gt; PerformPendingInstantiations</span><br><span class="line">&gt; Frontend</span><br><span class="line">&gt; ExecuteCompiler</span><br><span class="line"></span><br><span class="line">InstantiateFunction &#123;&quot;detail&quot;:&quot;DB::FunctionTiDBCast::createWrapper&lt;false&gt;&quot;&#125;</span><br><span class="line">&gt; PerformPendingInstantiations</span><br><span class="line">&gt; Frontend</span><br><span class="line">&gt; ExecuteCompiler</span><br></pre></td></tr></table></figure>

<hr>
<p>函数的模板参数是一个 <code>bool</code> 类型，全部枚举一遍也就是 2 种情况，共被实例化了 6 次显得很不合理。WHY ？</p>
<ul>
<li>该模板函数作为普通类 <code>class FunctionTiDBCast</code> 的成员函数，且直接在头文件 FunctionsTiDBConversion.h 中被另一个成员函数 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L2332-L2338">WrapperType createWrapper(const DataTypePtr &amp;, const DataTypePtr &amp;, bool) const</a> 调用。</li>
<li>包含 FunctionsTiDBConversion.h 的源文件（FunctionsTiDBConversion.cpp，DAGExpressionAnalyzer.cpp，DAGExpressionAnalyzerHelper.cpp）均会解析并实例化被用到的模板函数 <code>DB::FunctionTiDBCast::createWrapper&lt;false&gt;</code>、<code>DB::FunctionTiDBCast::createWrapper&lt;true&gt;</code>。按照调用逻辑，编译器会逐步实例化上百个相关的模板函数，例如 <code>DB::FunctionTiDBCast::createWrapperForDecimal&lt;$&gt;</code></li>
<li>DAGExpressionAnalyzer.cpp 和 DAGExpressionAnalyzerHelper.cpp 对 FunctionTiDBCast 没有逻辑依赖，所以目标文件中不会生成相关符号和汇编。</li>
<li>FunctionsTiDBConversion.cpp 中则从 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.cpp#L44-L47">void registerFunctionsTiDBConversion(FunctionFactory &amp;)</a> 开始向上依赖 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L2341">class FunctionBuilderTiDBCast</a> -&gt; <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L2369-L2381">buildImpl</a> -&gt; <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L1787">class FunctionTiDBCast</a> -&gt; 虚函数 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L1806-L1814">ExecutableFunctionPtr prepare(const Block &amp;) const</a> -&gt; <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L2238">WrapperType prepare(const DataTypePtr &amp;, const DataTypePtr &amp;) const</a> -&gt; <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L2332">WrapperType createWrapper(const DataTypePtr &amp;, const DataTypePtr &amp;, bool) const</a> -&gt; …</li>
</ul>
<h4 id="分析（2）"><a href="#分析（2）" class="headerlink" title="分析（2）"></a>分析（2）</h4><p>class FunctionTiDBCast 本身也就只在 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/FunctionsTiDBConversion.h#L2369-L2381">DB::FunctionBuilderTiDBCast::buildImpl</a> 函数中被创建使用。为了删除多余的模板实例化，一种简单的改动就如 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/pull/4978">tiflash&#x2F;pull&#x2F;4978</a></p>
<ul>
<li>将 class FunctionTiDBCast 变成一个模板类 <code>template &lt;typename...&gt; class FunctionTiDBCast</code></li>
<li>把 DB::FunctionBuilderTiDBCast::buildImpl 的实现挪到源文件 FunctionsTiDBConversion.cpp 中。如此一来，即便其他源文件包含 FunctionsTiDBConversion.h，因为没有实际使用关系也就不会实例化该模板类及其成员函数。</li>
</ul>
<p>改动效果如下，DAGExpressionAnalyzerHelper.cpp 的前端耗时从 185258 ms 下降到 20012 ms（降幅 89.2%），DAGExpressionAnalyzer.cpp 则是 181468 ms 降到 19898 ms（降幅 89.0%）。模板函数被实例化的次数也符合预期。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">**** Files that took longest to parse (compiler frontend):</span><br><span class="line">188112 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/FunctionsTiDBConversion.cpp.o</span><br><span class="line">...</span><br><span class="line"> 20012 ms: /data2/work/build-llvm-tiflash/dbms/src/Flash/CMakeFiles/flash_service.dir/Coprocessor/DAGExpressionAnalyzerHelper.cpp.o</span><br><span class="line"> 19898 ms: /data2/work/build-llvm-tiflash/dbms/src/Flash/CMakeFiles/flash_service.dir/Coprocessor/DAGExpressionAnalyzer.cpp.o</span><br><span class="line"></span><br><span class="line">**** Files that took longest to codegen (compiler backend):</span><br><span class="line">...</span><br><span class="line">210576 ms: /data2/work/build-llvm-tiflash/dbms/src/Functions/CMakeFiles/clickhouse_functions.dir/FunctionsTiDBConversion.cpp.o</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">**** Files that took longest to parse (compiler frontend):</span><br><span class="line">...</span><br><span class="line"> 85109 ms: DB::FunctionTiDBCast&lt;&gt;::createWrapper&lt;false&gt; (1 times, avg 85109 ms)</span><br><span class="line"> 84390 ms: DB::FunctionTiDBCast&lt;&gt;::createWrapper&lt;true&gt; (1 times, avg 84390 ms)</span><br><span class="line">...</span><br><span class="line"> 144093 ms: DB::FunctionTiDBCast&lt;$&gt;::createWrapperForDecimal&lt;$&gt; (160 times, avg 900 ms)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>PS：理论上把头文件里非模板的实现都挪到源文件中（例如 <a href="#%E6%A1%88%E4%BE%8B%EF%BC%883-1%EF%BC%89">案例（3.1）</a>），可以达到相同的效果，现在这种方式无非是代码改动比较小而已。</strong></p>
<h3 id="拆分｜合并编译单元"><a href="#拆分｜合并编译单元" class="headerlink" title="拆分｜合并编译单元"></a>拆分｜合并编译单元</h3><p>删减重复模板实例化之后，可以发现 divide.cpp 是最大的编译单元，编译器前端耗时 30783 ms，后端 416467 ms。后端耗时主要是编译这 4 个模板类 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/dbms/src/Functions/divide.cpp#L308-L333">dbms&#x2F;src&#x2F;Functions&#x2F;divide.cpp#L308-L333</a> 以及其衍生出的<br><code>template &lt;typename... Ts, typename F&gt; static bool castTypeToEither</code>。巨大的编译单元令每次修改代码均陷入漫长的等待。为了充分利用多核资源，避免单核瓶颈，一种简单的方法就是把这 4 个函数及其相关的模板实例拆分到 4 个源文件中。</p>
<ul>
<li>事实上之前 TiFlash 代码中注册这类 Function 函数的风格也是继承 Clickhouse，按功能独立拆分成：registerFunctionDivideFloating.cpp、registerFunctionDivideIntegral.cpp、registerFunctionDivideIntegralOrZero.cpp、registerFunctionTiDBDivideFloating.cpp 这 4 个源文件。</li>
<li>是在 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/commit/92e668158c87893535d812773e4bfa501f0a2dc8">92e668158c87893535d812773e4bfa501f0a2dc8</a> 中这些源文件被合并成现在这样巨大的编译单元。</li>
</ul>
<hr>
<p>合并源文件所带来的好处包括以下几点：</p>
<ul>
<li>减少头文件前端处理开销：例如某个头文件被多个源文件包含，每个编译单元都需独立解析一遍。<ul>
<li>实际工程项目中也可通过 <a href="#%E9%A2%84%E7%BC%96%E8%AF%91%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88PCH%EF%BC%89">预编译头文件</a> 来优化</li>
</ul>
</li>
<li>减少重复编译：与 <a href="#%E6%A1%88%E4%BE%8B%EF%BC%881-2%EF%BC%89">案例（1.2）</a> 类似，头文件中有函数实现，每个编译单元用到该函数时均会生成相关的符号和汇编。但最终链接器只会为符号绑定一种实现。</li>
<li>利于编译器优化：普通编译优化无法跨编译单元</li>
</ul>
<p>更有甚者，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Unity_build">Unity build</a> 通过把所有源文件合并成一个来避免上述开销。cmake 参数 <a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/v3.21/variable/CMAKE_UNITY_BUILD.html#variable:CMAKE_UNITY_BUILD">CMAKE_UNITY_BUILD</a> 也提供了这一支持。由于代码集中在单个编译单元内，有利于编译器全量分析上下文实现优化（比起 <a href="#LTO%EF%BC%88Link-Time-Optimization%EF%BC%89">LTO</a> 更加彻底）。但代价就是：</p>
<ul>
<li>无法并行编译和增量编译</li>
<li>需解决静态变量或本地定义重名冲突</li>
<li>编译单元资源内存消耗峰值较大</li>
</ul>
<hr>
<p>就工程实践而言，为了兼顾开发效率，对于编译单元可以适度地拆分&#x2F;合并。可参考的标准为：</p>
<ul>
<li>根据 ClangBuildAnalyzer 分析结果中后端编译耗时的前几项，找出明显偏高的单元。</li>
<li>对于前端编译耗时相比于后端较低（例如小于 15%）的编译单元，则可根据逻辑模块进行拆分</li>
<li>对于前端耗时相比于后端较高的模块，则可以按需合并</li>
<li>理想情况下，期望所有编译单元的耗时接近平均值</li>
</ul>
<h3 id="显式实例化"><a href="#显式实例化" class="headerlink" title="显式实例化"></a>显式实例化</h3><p>基本概念参考 <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/class_template">Explicit instantiation</a>，核心语法为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> <span class="keyword">class</span>-key <span class="keyword">template</span>-name &lt; argument-list &gt; ;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="keyword">class</span>-key <span class="keyword">template</span>-name &lt; argument-list &gt; ;</span><br></pre></td></tr></table></figure>

<h4 id="案例（3-0）"><a href="#案例（3-0）" class="headerlink" title="案例（3.0）"></a>案例（3.0）</h4><p>对于类&#x2F;模板类的成员函数，即便声明了 <code>extern template void Test11&lt;&gt;::foo_1&lt;int64_t&gt;();</code> 和 <code>extern template void Test11&lt;&gt;::doo_1&lt;int64_t&gt;();</code>，但火焰图仍显示了函数 <code>Test11&lt;&gt;::foo_1&lt;long long&gt;</code>，<code>Test11&lt;&gt;::doo_1&lt;long long&gt;</code> 被实例化的过程，和预期不符。只有函数模板声明了 <code>extern template void foo_2&lt;float&gt;();</code> 后，火焰图中才没有任何相关的实例化过程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test11.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>...&gt; <span class="keyword">struct</span> <span class="title class_">Test11</span> &#123;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">foo_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::optional&lt;T&gt;&#123;&#125;;</span><br><span class="line">    <span class="built_in">doo_1</span>&lt;T&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">doo_1</span><span class="params">()</span> </span>&#123; std::map&lt;T, T&gt;&#123;&#125;; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">doo_2</span><span class="params">()</span> </span>&#123; std::map&lt;T, T&gt;&#123;&#125;; &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">foo_2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::optional&lt;T&gt;&#123;&#125;;</span><br><span class="line">  <span class="built_in">doo_2</span>&lt;T&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">goo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Test11&#123;&#125;.<span class="built_in">foo_1</span>&lt;<span class="type">int64_t</span>&gt;();</span><br><span class="line">  <span class="built_in">foo_2</span>&lt;<span class="type">float</span>&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="type">void</span> Test11&lt;&gt;::<span class="built_in">foo_1</span>&lt;<span class="type">int64_t</span>&gt;();</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="type">void</span> Test11&lt;&gt;::<span class="built_in">doo_1</span>&lt;<span class="type">int64_t</span>&gt;();</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="type">void</span> <span class="built_in">foo_2</span>&lt;<span class="type">float</span>&gt;();</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ clang++ -c test11.cpp -o test11.o -ftime-trace -std=gnu++17</span><br><span class="line">➜ nm -C test11.o</span><br><span class="line">0000000000000000 T goo()</span><br><span class="line">                 U void foo_2&lt;<span class="built_in">float</span>&gt;()</span><br><span class="line">                 U void Test11&lt;&gt;::foo_1&lt;long long&gt;()</span><br></pre></td></tr></table></figure>

<p>类可采用定义实现分离的方式来达到类似的效果，不过需要注意的是：如果模板函数有被实际用到（例如 <code>test12_2.cpp</code>），需要像 <code>(1)</code> 处在模板函数实现的源文件内显式实例化，否则会出现找不到相关符号的链接错误。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test12_1.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>...&gt; <span class="keyword">struct</span> <span class="title class_">Test12</span> &#123;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">foo_1</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">doo_1</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test12_2.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test12_1.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; Test12&lt;&gt;&#123;&#125;.<span class="built_in">foo_1</span>&lt;<span class="type">int64_t</span>&gt;(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test12_1.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test12_1.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> Test12&lt;Args...&gt;::<span class="built_in">foo_1</span>() &#123;</span><br><span class="line">  std::optional&lt;T&gt;&#123;&#125;;</span><br><span class="line">  <span class="built_in">doo_1</span>&lt;T&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> Test12&lt;Args...&gt;::<span class="built_in">doo_1</span>() &#123;</span><br><span class="line">  std::map&lt;T, T&gt;&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> <span class="type">void</span> Test12&lt;&gt;::<span class="built_in">foo_1</span>&lt;<span class="type">int64_t</span>&gt;(); <span class="comment">// (1)</span></span><br></pre></td></tr></table></figure>

<h3 id="抽象出-ABI-稳定接口"><a href="#抽象出-ABI-稳定接口" class="headerlink" title="抽象出 ABI 稳定接口"></a>抽象出 ABI 稳定接口</h3><p>如果类模板中实现了普通函数，则可将涉及到非模板的实现封装成独立的接口，以免每次模板实例化时生成重复代码。</p>
<h4 id="案例（3-1）"><a href="#案例（3-1）" class="headerlink" title="案例（3.1）"></a>案例（3.1）</h4><p>每次实例化类模板，编译器均会生成函数 <code>Node&lt;xxx&gt;::foo</code>。如果采用定义实现分离的方式，则需要像 <a href="#%E6%A1%88%E4%BE%8B%EF%BC%883-0%EF%BC%89">案例（3.0）</a> 显式实例化每个被用到的模板类。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test15.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; std::optional&lt;<span class="type">float</span>&gt; _; &#125;</span><br><span class="line">  T v_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>将函数分离到抽象类中，并通过类继承的方式封装，则最后只存在函数 <code>NodeBase::foo</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test15_base.h</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NodeBase</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// test15_2.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test15_base.h&quot;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">struct</span> <span class="title class_">Node</span> : NodeBase &#123; T v_; &#125;;</span><br><span class="line"><span class="comment">// test15_base.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test15_base.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NodeBase::foo</span><span class="params">()</span> </span>&#123; std::optional&lt;<span class="type">float</span>&gt; _; &#125;</span><br></pre></td></tr></table></figure>

<h2 id="头文件优化"><a href="#头文件优化" class="headerlink" title="头文件优化"></a>头文件优化</h2><h3 id="头文件依赖"><a href="#头文件依赖" class="headerlink" title="头文件依赖"></a>头文件依赖</h3><p>现有工具：</p>
<ul>
<li>头文件分析工具 <a target="_blank" rel="noopener" href="https://github.com/include-what-you-use/include-what-you-use">include-what-you-use</a> 相对细致，但结果需要人工排查确认，成本较高。例如 TiFlash 的 cmake 编译选项 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/CMakeLists.txt#L311-L321">USE_INCLUDE_WHAT_YOU_USE</a>。</li>
<li>ClangBuildAnalyzer 工具输出项 <code>Expensive headers</code> 比较简单清晰，展示头文件被包含的路径。需要人工分析依赖关系，找出瓶颈并优化（模板相关可参考上文）。</li>
</ul>
<p><strong>头文件依赖解耦，可列出说明使用文档和标准，让社区参与。</strong></p>
<h3 id="前向声明"><a href="#前向声明" class="headerlink" title="前向声明"></a>前向声明</h3><p>前向声明（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Forward_declaration">Forward declaration</a>）是尚未给出完整定义的标识符（例如类型、变量、常量、函数）声明。编译器需要知道标识符的部分属性（内存大小和对齐方式，数据类型），但不用知道其他实现细节。</p>
<hr>
<p>前向声明对于解耦头文件依赖有较大帮助。然而 <a target="_blank" rel="noopener" href="https://google.github.io/styleguide/cppguide.html#Forward_Declarations">Google C++ Style Guide</a> 中却提出 <code>Avoid using forward declarations where possible</code>。比较关键的原因是在某些场景下，前向声明会导致代码静默行为产生变化，例如 <a href="#%E6%A1%88%E4%BE%8B%EF%BC%884-1%EF%BC%89">案例（4.1）</a>。</p>
<h4 id="案例（4-0）"><a href="#案例（4-0）" class="headerlink" title="案例（4.0）"></a>案例（4.0）</h4><p>test13_2.cpp 中声明了前向定义 <code>struct Test13_1;</code>，并在 <code>struct Test13_2</code> 的成员函数和成员变量中引用。该源文件可以正常编译。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test13_2.cpp</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test13_1</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test13_2</span> &#123;</span><br><span class="line">  Test13_1 &amp;data;</span><br><span class="line">  <span class="function">Test13_1 <span class="title">foo</span><span class="params">(Test13_1)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">sizeof</span>(Test13_2) == <span class="built_in">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line"><span class="built_in">static_assert</span>(<span class="built_in">alignof</span>(Test13_2) == <span class="built_in">alignof</span>(<span class="type">void</span> *));</span><br></pre></td></tr></table></figure>

<h4 id="分析（4）"><a href="#分析（4）" class="headerlink" title="分析（4）"></a>分析（4）</h4><ul>
<li>成员变量 <code>Test13_2::data</code> 的类型实际是 <code>引用</code>，其内存大小和对齐方式和 <code>指针</code> 相同，编译器解析时并不需要知道 <code>Test13_1</code> 的具体实现。</li>
<li>成员函数 <code>Test13_2::foo</code> 引用了 <code>Test13_1</code>，但编译单元内没有实现该函数，编译器则将其作为一个函数声明（本身也是种前向声明）。</li>
</ul>
<h4 id="案例（4-1）"><a href="#案例（4-1）" class="headerlink" title="案例（4.1）"></a>案例（4.1）</h4><p><code>class B</code> 继承了 <code>class A</code>，如果隐藏类定义，则编译单元 <code>test14.cpp</code> 中 <code>void test_14(B *)</code> 最后会调用 <code>f(void *)</code>，如果包含具体定义，在 <code>test14_1.cpp</code> 中则调用 <code>f(A *)</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test14.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>;</span><br><span class="line"><span class="comment">// struct A &#123;&#125;;</span></span><br><span class="line"><span class="comment">// struct B : A &#123;&#125;;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(A *)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_14</span><span class="params">(B *x)</span> </span>&#123; <span class="built_in">f</span>(x); &#125; <span class="comment">// call f(void *);</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test14_1.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> : <span class="keyword">public</span> A &#123;&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(A *)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_14</span><span class="params">(B *x)</span> </span>&#123; <span class="built_in">f</span>(x); &#125; <span class="comment">// call f(A *);</span></span><br></pre></td></tr></table></figure>

<p>这个案例中引起不确定性行为的是 C++ 特有的函数重载和类继承方式：</p>
<ul>
<li><code>void *</code> 指针可以匹配任意其他指针。</li>
<li><code>test14_1.cpp</code> 中编译器优先按照继承关系匹配，由于不存在 <code>f(B *)</code>，则查找顺序为从 <code>f(A *)</code> 到 <code>f(void *)</code>。</li>
<li><code>test14.cpp</code> 中不存在继承关系，且不存在 <code>f(B *)</code>，则直接匹配到 <code>f(void *)</code>。</li>
</ul>
<p>解决这个案例中的问题，可参考以下途径：</p>
<ul>
<li>去掉 <code>f(void *)</code> 函数，令编译时直接报错，由开发者排查并补上继承关系。<ul>
<li>绝大部份实际应用中，比较常见的是子类继承并重写基类的虚函数，用 <code>void *</code> 兜底很难说有什么实际意义。</li>
</ul>
</li>
<li>在 <code>f(void *)</code> 的逻辑实现中直接抛异常或手动 panic。</li>
</ul>
<p><strong>在代码设计和审查环节应当注意避开这类问题而非一味禁止使用前向声明。</strong></p>
<h3 id="预编译头文件（PCH）"><a href="#预编译头文件（PCH）" class="headerlink" title="预编译头文件（PCH）"></a>预编译头文件（PCH）</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Precompiled_header">Precompiled header</a>（aka <code>PCH</code>）：预编译（C 或 C++）头文件，使之被编译成编译器可以更快处理的中间形式，使用预编译头文件可以显着减少编译时间（主要是前端）。cmake 中支持 PCH 的语法为 <a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/v3.22/command/target_precompile_headers.html">target_precompile_headers</a>。</p>
<ul>
<li>在 Windows 系统下用 Visual Studio 开发桌面软件时经常能看到头文件 <code>stdafx.h</code>，里面基本会包含开发所用的重型 API。</li>
<li>参考 <a href="#%E6%A8%A1%E6%9D%BF%E5%AE%9E%E4%BE%8B%E5%8C%96">模板实例化</a> 章节中的几个案例，编译器解析头文件会有不小的开销（尤其涉及到模板实例化），对于 TiFlash 这种 C++ 项目也是个不可忽略的问题。</li>
</ul>
<h4 id="案例（4-2）"><a href="#案例（4-2）" class="headerlink" title="案例（4.2）"></a>案例（4.2）</h4><p>根据 <a href="#ClangBuildAnalyzer-%E5%88%86%E6%9E%90%E7%BB%93%E6%9E%9C%EF%BC%88%E6%9C%AA%E4%BC%98%E5%8C%96%EF%BC%89">ClangBuildAnalyzer 分析结果</a>，<code>Expensive headers</code> 中包含不少公共模块和 STL 库的头文件。<a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/5847f1c235b996eb6fb970029da926909e1819fd/dbms/CMakeLists.txt#L262-L270-R270">5847f1c235b996eb6fb970029da926909e1819fd</a> 为相关库编译选项加上 PCH：</p>
<ul>
<li><code>pch-common.h</code> 包含 Exception.h，FmtUtils.h，StackTrace.h 之类的公共模块头文件</li>
<li><code>pch-stl.h</code> 包含常用的 STL 库头文件，例如 algorithm，string，vector，functional 等</li>
<li><code>pch-kvpb.h</code> 包含比较重型的 grpc 相关头文件</li>
</ul>
<p>优化后，分析结果显示前端总耗时和重型头文件解析耗时显著下降。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">**** Time summary:</span><br><span class="line">Compilation (5487 times):</span><br><span class="line">  Parsing (frontend):         4167.5 s</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">*** Expensive headers:</span><br><span class="line">188125 ms: /data2/work/tiflash/dbms/src/Columns/IColumn.h (included 515 times, avg 365 ms), included via:</span><br><span class="line">...</span><br><span class="line">178572 ms: /data2/work/tiflash/dbms/src/Common/Decimal.h (included 657 times, avg 271 ms), included via:</span><br><span class="line">...</span><br><span class="line">122002 ms: /data2/work/tiflash/dbms/src/Core/Block.h (included 416 times, avg 293 ms), included via:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="PImpl"><a href="#PImpl" class="headerlink" title="PImpl"></a>PImpl</h3><p>PImpl（<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/pimpl">Pointer to implementation</a>）又称编译防火墙（<code>Compilation firewall</code>）。在类定义中隐藏数据结构的实现细节，只对外暴露不透明的指针&#x2F;引用&#x2F;其他固定类型作为访问入口。</p>
<ul>
<li>例如发布二进制库给第三方，除了代码混淆，通常也需要用 PImpl 提供稳定的 ABI 并保护私有数据结构安全。</li>
<li>PImpl 的劣势包括以下几点，如有必要可参考 <a href="#%E6%A1%88%E4%BE%8B%EF%BC%881-0-1%EF%BC%89">案例（1.0.1）</a> 来优化<ul>
<li>需要分配额外的内存空间</li>
<li>存取变量时需要额外的内存寻址，对于看重 CPU Cache 和代码局部性的场景不利</li>
</ul>
</li>
</ul>
<h4 id="案例（5-0）"><a href="#案例（5-0）" class="headerlink" title="案例（5.0）"></a>案例（5.0）</h4><p>根据 ClangBuildAnalyzer 结果，有关 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/eaf1a4cf886d1d5a86d04ef14eff956778ab4911/dbms/src/Common/TiFlashException.h#L162-L172">struct TiFlashError</a> 的几个模板实例化总开销不小。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">**** Templates that took longest to instantiate:</span><br><span class="line">...</span><br><span class="line"> 53692 ms: std::optional&lt;DB::TiFlashError&gt; (663 times, avg 80 ms)</span><br><span class="line">... </span><br><span class="line"> 47327 ms: std::map&lt;std::pair&lt;std::string, std::string&gt;, DB::TiFlashError&gt; (663 times, avg 71 ms)</span><br><span class="line"> 24149 ms: std::__rebind_alloc_helper&lt;std::allocator_traits&lt;std::allocator&lt;std::pair&lt;const std::pair&lt;std::string, std::string&gt;, DB::TiFlashError&gt;&gt;&gt;, std::__value_type&lt;std::pair&lt;std::string, std::string&gt;, DB::TiFlashError&gt;&gt; (663 times, avg 36 ms)</span><br><span class="line"> 23596 ms: std::allocator_traits&lt;std::allocator&lt;std::pair&lt;const std::pair&lt;std::string, std::string&gt;, DB::TiFlashError&gt;&gt;&gt; (663 times, avg 35 ms)</span><br><span class="line"> 22289 ms: std::__value_type&lt;std::pair&lt;std::string, std::string&gt;, DB::TiFlashError&gt; (663 times, avg 33 ms)</span><br></pre></td></tr></table></figure>

<p>使用这些模板的地方主要在 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/eaf1a4cf886d1d5a86d04ef14eff956778ab4911/dbms/src/Common/TiFlashException.h#L192-L257">class TiFlashErrorRegistry</a>。这种把成员函数实现直接放在头文件里的做法 <strong>不值得提倡</strong>，因为包含其的源文件均会解析并实例化涉及到的模板，建议分离定义和实现。<br>但是对于使用了 STL 模板的成员变量 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/eaf1a4cf886d1d5a86d04ef14eff956778ab4911/dbms/src/Common/TiFlashException.h#L256">std::map&lt;std::pair&lt;std::string, std::string&gt;, TiFlashError&gt; all_errors</a> 则需要多加考量。</p>
<ul>
<li>头文件中分离函数实现后，只要编译单元内没有其他符号对函数有依赖关系，编译器就可以不实例化函数涉及到的模板</li>
<li>对于类定义，编译器会解析其成员变量和依赖以确定大小和对齐方式。</li>
</ul>
<p>分析上下文信息可知这个类主要以 <code>单例</code> 的形式用来维护&#x2F;查找预设数据，可以使用 PImpl 改造以降低前端开销（对于该类的使用场景几乎不会有性能影响）。本案例中类重构效果如<br><a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/commit/5847f1c235b996eb6fb970029da926909e1819fd#diff-8188b262b79652a91ca17d4ba1329730b9dc1a8a2527ad21798eadf3a483db0d">TiFlashException.h#L192-L225</a>。改造完成后，上面提到的模板实例化开销均被消除。<br>除了裸指针，用 <code>std::unique_ptr</code> 也是同样原理，例如 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/commit/5847f1c235b996eb6fb970029da926909e1819fd#diff-30095d1da019568697a7bf369f28b2b440e2da783bf4cfdd7938bb839ddbf9cdL232-R229">KVStore.h</a> 的改动。</p>
<h2 id="LTO（Link-Time-Optimization）"><a href="#LTO（Link-Time-Optimization）" class="headerlink" title="LTO（Link Time Optimization）"></a>LTO（Link Time Optimization）</h2><p>链接时优化（<a target="_blank" rel="noopener" href="https://llvm.org/docs/LinkTimeOptimization.html">Link Time Optimization</a>）是比较典型的后端优化，属于 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Interprocedural_optimization">Interprocedural optimization</a>。LLVM 提供了强大的链接时跨模块优化功能，以获取更好的运行时性能。</p>
<p><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/ThinLTO.html">ThinLTO</a> 是一种新型的 LTO 技术。默认 <code>full</code> 模式的 LTO 会将所有目标文件整合成一个大模块，比较耗费资源且不可并行化扩展，同时这种方式也无法进行快速增量编译。ThinLTO 模式下，编译器生成的 bitcode 格式文件会额外包含模块的摘要（<code>compact summary</code>），链接器将这些摘要合并为索引，便于后期跨模块导入。链接器进行全局分析和优化也是基于该索引。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/pull/4890">tiflash&#x2F;pull&#x2F;4890</a> 中加入了 cmake 选项 <code>ENABLE_THINLTO</code> 并在 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/pull/4924">release build</a> 流程中启用。跨模块优化的好处有以下几点：</p>
<ul>
<li>全局优化：去虚拟化（<code>whole-program devirtualization</code>），跨模块函数内联</li>
<li>删减无用代码</li>
</ul>
<p><strong>出于性能考虑，有人会放弃 <a href="#%E5%89%8D%E5%90%91%E5%A3%B0%E6%98%8E">前向声明</a> 将函数直接实现在头文件中，这样有利于跨模块函数调用时编译器自动内联。有了 LTO 的支持，就无需担心这个问题（例如 <a href="#%E6%A1%88%E4%BE%8B%EF%BC%886-0%EF%BC%89">案例（6.0）</a>），将实现和定义分离有利于优化工程架构。</strong></p>
<h3 id="案例（6-0）"><a href="#案例（6-0）" class="headerlink" title="案例（6.0）"></a>案例（6.0）</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t1.cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">goo</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> x * <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> x / <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> &amp;<span class="title">get</span><span class="params">(<span class="type">int</span> *data, <span class="type">int</span> idx)</span> </span>&#123; <span class="keyword">return</span> data[idx]; &#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span> </span>&#123; <span class="keyword">return</span> i &lt; len; &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">joo</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> x)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Base::joo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Base::foo</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123; <span class="keyword">return</span> x + <span class="number">1</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">doo</span><span class="params">(<span class="type">int</span> x, Base &amp;d)</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span> + d.<span class="built_in">foo</span>(x); &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t2.cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">goo</span><span class="params">(<span class="type">int</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">goo</span>(x) * <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">goo</span>(x) / <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> &amp;<span class="title">get</span><span class="params">(<span class="type">int</span> *data, <span class="type">int</span> idx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sum</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> *b, <span class="type">int</span> *c, <span class="type">int</span> len)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; <span class="built_in">check</span>(i, len); ++i)</span><br><span class="line">    <span class="built_in">get</span>(c, i) = <span class="built_in">get</span>(a, i) + <span class="built_in">get</span>(b, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">joo</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> x)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">doo</span><span class="params">(<span class="type">int</span> x, Base &amp;d)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Impl</span> : Base &#123;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> x)</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> x + <span class="number">4</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">koo</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">  Impl tt&#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">doo</span>(x, tt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t3.cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sum</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> *b, <span class="type">int</span> *c, <span class="type">int</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">koo</span><span class="params">(<span class="type">int</span> x)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">foo</span>(<span class="number">123</span>);</span><br><span class="line">  <span class="built_in">sum</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">koo</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>未启用 LTO，编译器优化无法跨模块。<code>foo</code>，<code>sum</code>，<code>koo</code> 函数的汇编实现无任何优化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">clang++  -O3 -DNDEBUG -std=gnu++17 -o t1.o -c t1.cpp</span><br><span class="line">clang++  -O3 -DNDEBUG -std=gnu++17 -o t2.o -c t2.cpp</span><br><span class="line">clang++  -O3 -DNDEBUG -std=gnu++17 -o t3.o -c t3.cpp</span><br><span class="line">clang++  -O3 -DNDEBUG -fuse-ld=lld t1.o t2.o t3.o -o <span class="built_in">test</span></span><br><span class="line">objdump -d <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00000000002019e0 &lt;_Z3dooiR4Base&gt;:</span><br><span class="line">  2019e0: 50                    push   %rax</span><br><span class="line">  2019e1: 89 f8                 mov    %edi,%eax</span><br><span class="line">  2019e3: 48 8b 0e              mov    (%rsi),%rcx</span><br><span class="line">  2019e6: 48 89 f7              mov    %rsi,%rdi</span><br><span class="line">  2019e9: 89 c6                 mov    %eax,%esi</span><br><span class="line">  2019eb: ff 51 08              callq  *0x8(%rcx)</span><br><span class="line">  2019ee: 83 c0 02              add    <span class="variable">$0x2</span>,%eax</span><br><span class="line">  2019f1: 59                    pop    %rcx</span><br><span class="line">  2019f2: c3                    retq   </span><br><span class="line"></span><br><span class="line">0000000000201a00 &lt;_Z3fooi&gt;:</span><br><span class="line">  201a00: 53                    push   %rbx</span><br><span class="line">  201a01: 89 fb                 mov    %edi,%ebx</span><br><span class="line">  201a03: e8 78 ff ff ff        callq  201980 &lt;_Z3gooi&gt;</span><br><span class="line">  201a08: 85 db                 <span class="built_in">test</span>   %ebx,%ebx</span><br><span class="line">  201a0a: 7e 07                 jle    201a13 &lt;_Z3fooi+0x13&gt;</span><br><span class="line">  201a0c: 01 c0                 add    %eax,%eax</span><br><span class="line">  201a0e: 8d 04 80              lea    (%rax,%rax,4),%eax</span><br><span class="line">  201a11: 5b                    pop    %rbx</span><br><span class="line">  201a12: c3                    retq   </span><br><span class="line">  201a13: 48 98                 cltq   </span><br><span class="line">  201a15: 48 69 c0 67 66 66 66  imul   <span class="variable">$0x66666667</span>,%rax,%rax</span><br><span class="line">  201a1c: 48 89 c1              mov    %rax,%rcx</span><br><span class="line">  201a1f: 48 c1 e9 3f           shr    <span class="variable">$0x3f</span>,%rcx</span><br><span class="line">  201a23: 48 c1 f8 22           sar    <span class="variable">$0x22</span>,%rax</span><br><span class="line">  201a27: 01 c8                 add    %ecx,%eax</span><br><span class="line">  201a29: 5b                    pop    %rbx</span><br><span class="line">  201a2a: c3                    retq   </span><br><span class="line">  201a2b: 0f 1f 44 00 00        nopl   0x0(%rax,%rax,1)</span><br><span class="line"></span><br><span class="line">0000000000201a30 &lt;_Z3sumPiS_S_i&gt;:</span><br><span class="line">  201a30: 55                    push   %rbp</span><br><span class="line">  201a31: 41 57                 push   %r15</span><br><span class="line">  201a33: 41 56                 push   %r14</span><br><span class="line">  201a35: 41 55                 push   %r13</span><br><span class="line">  201a37: 41 54                 push   %r12</span><br><span class="line">  201a39: 53                    push   %rbx</span><br><span class="line">  201a3a: 50                    push   %rax</span><br><span class="line">  201a3b: 41 89 <span class="built_in">cd</span>              mov    %ecx,%r13d</span><br><span class="line">  201a3e: 49 89 d6              mov    %rdx,%r14</span><br><span class="line">  201a41: 49 89 f7              mov    %rsi,%r15</span><br><span class="line">  201a44: 49 89 <span class="built_in">fc</span>              mov    %rdi,%r12</span><br><span class="line">  201a47: 31 ed                 xor    %ebp,%ebp</span><br><span class="line">  201a49: 31 ff                 xor    %edi,%edi</span><br><span class="line">  201a4b: 89 ce                 mov    %ecx,%esi</span><br><span class="line">  201a4d: e8 5e ff ff ff        callq  2019b0 &lt;_Z5checkii&gt;</span><br><span class="line">  201a52: 84 c0                 <span class="built_in">test</span>   %al,%al</span><br><span class="line">  201a54: 74 3f                 je     201a95 &lt;_Z3sumPiS_S_i+0x65&gt;</span><br><span class="line">  201a56: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  201a5d: 00 00 00 </span><br><span class="line">  201a60: 4c 89 e7              mov    %r12,%rdi</span><br><span class="line">  201a63: 89 ee                 mov    %ebp,%esi</span><br><span class="line">  201a65: e8 36 ff ff ff        callq  2019a0 &lt;_Z3getPii&gt;</span><br><span class="line">  201a6a: 8b 18                 mov    (%rax),%ebx</span><br><span class="line">  201a6c: 4c 89 ff              mov    %r15,%rdi</span><br><span class="line">  201a6f: 89 ee                 mov    %ebp,%esi</span><br><span class="line">  201a71: e8 2a ff ff ff        callq  2019a0 &lt;_Z3getPii&gt;</span><br><span class="line">  201a76: 03 18                 add    (%rax),%ebx</span><br><span class="line">  201a78: 4c 89 f7              mov    %r14,%rdi</span><br><span class="line">  201a7b: 89 ee                 mov    %ebp,%esi</span><br><span class="line">  201a7d: e8 1e ff ff ff        callq  2019a0 &lt;_Z3getPii&gt;</span><br><span class="line">  201a82: 89 18                 mov    %ebx,(%rax)</span><br><span class="line">  201a84: 83 c5 01              add    <span class="variable">$0x1</span>,%ebp</span><br><span class="line">  201a87: 89 ef                 mov    %ebp,%edi</span><br><span class="line">  201a89: 44 89 ee              mov    %r13d,%esi</span><br><span class="line">  201a8c: e8 1f ff ff ff        callq  2019b0 &lt;_Z5checkii&gt;</span><br><span class="line">  201a91: 84 c0                 <span class="built_in">test</span>   %al,%al</span><br><span class="line">  201a93: 75 cb                 jne    201a60 &lt;_Z3sumPiS_S_i+0x30&gt;</span><br><span class="line">  201a95: 48 83 c4 08           add    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">  201a99: 5b                    pop    %rbx</span><br><span class="line">  201a9a: 41 5c                 pop    %r12</span><br><span class="line">  201a9c: 41 5d                 pop    %r13</span><br><span class="line">  201a9e: 41 5e                 pop    %r14</span><br><span class="line">  201aa0: 41 5f                 pop    %r15</span><br><span class="line">  201aa2: 5d                    pop    %rbp</span><br><span class="line">  201aa3: c3                    retq   </span><br><span class="line">  201aa4: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  201aab: 00 00 00 </span><br><span class="line">  201aae: 66 90                 xchg   %ax,%ax</span><br><span class="line"></span><br><span class="line">0000000000201ab0 &lt;_Z3kooi&gt;:</span><br><span class="line">  201ab0: 50                    push   %rax</span><br><span class="line">  201ab1: 48 c7 04 24 f8 05 20  movq   <span class="variable">$0x2005f8</span>,(%rsp)</span><br><span class="line">  201ab8: 00 </span><br><span class="line">  201ab9: 48 89 e6              mov    %rsp,%rsi</span><br><span class="line">  201abc: e8 1f ff ff ff        callq  2019e0 &lt;_Z3dooiR4Base&gt;</span><br><span class="line">  201ac1: 59                    pop    %rcx</span><br><span class="line">  201ac2: c3                    retq   </span><br></pre></td></tr></table></figure>

<p>启用 LTO 后</p>
<ul>
<li><code>foo</code> 函数逻辑直接被优化成等效于 <code>if (x &gt; 0) return x * 100; else return x / 100;</code> 的实现</li>
<li><code>sum</code> 中自动向量化生成 SIMD 指令</li>
<li><code>koo</code> 去虚拟化实现等效于 <code>x + 6</code> 的逻辑</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">clang++ -flto=thin -fvisibility=hidden -fvisibility-inlines-hidden -fwhole-program-vtables -fsplit-lto-unit -O3 -DNDEBUG -std=gnu++17 -o t1.o -c t1.cpp</span><br><span class="line">clang++ -flto=thin -fvisibility=hidden -fvisibility-inlines-hidden -fwhole-program-vtables -fsplit-lto-unit -O3 -DNDEBUG -std=gnu++17 -o t2.o -c t2.cpp</span><br><span class="line">clang++ -flto=thin -fvisibility=hidden -fvisibility-inlines-hidden -fwhole-program-vtables -fsplit-lto-unit -O3 -DNDEBUG -std=gnu++17 -o t3.o -c t3.cpp</span><br><span class="line">clang++ -flto=thin -fvisibility=hidden -fvisibility-inlines-hidden -fwhole-program-vtables -fsplit-lto-unit -O3 -DNDEBUG -fuse-ld=lld -pthread -flto=thin -flto-jobs=0 -fvisibility=hidden -fvisibility-inlines-hidden -fwhole-program-vtables -fsplit-lto-unit t1.o t2.o t3.o -o <span class="built_in">test</span></span><br><span class="line">objdump -d <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00000000002019f0 &lt;_Z3fooi&gt;:</span><br><span class="line">  2019f0: 85 ff                 <span class="built_in">test</span>   %edi,%edi</span><br><span class="line">  2019f2: 7e 04                 jle    2019f8 &lt;_Z3fooi+0x8&gt;</span><br><span class="line">  2019f4: 6b c7 64              imul   <span class="variable">$0x64</span>,%edi,%eax</span><br><span class="line">  2019f7: c3                    retq   </span><br><span class="line">  2019f8: f7 <span class="built_in">df</span>                 neg    %edi</span><br><span class="line">  2019fa: 48 69 c7 1f 85 eb 51  imul   <span class="variable">$0x51eb851f</span>,%rdi,%rax</span><br><span class="line">  201a01: 48 c1 e8 25           shr    <span class="variable">$0x25</span>,%rax</span><br><span class="line">  201a05: f7 d8                 neg    %eax</span><br><span class="line">  201a07: c3                    retq   </span><br><span class="line"></span><br><span class="line">0000000000201a10 &lt;_Z3sumPiS_S_i&gt;:</span><br><span class="line">  201a10: 85 c9                 <span class="built_in">test</span>   %ecx,%ecx</span><br><span class="line">  201a12: 0f 8e 7f 01 00 00     jle    201b97 &lt;_Z3sumPiS_S_i+0x187&gt;</span><br><span class="line">  201a18: 41 89 c8              mov    %ecx,%r8d</span><br><span class="line">  201a1b: 83 f9 08              cmp    <span class="variable">$0x8</span>,%ecx</span><br><span class="line">  201a1e: 73 7b                 jae    201a9b &lt;_Z3sumPiS_S_i+0x8b&gt;</span><br><span class="line">  201a20: 31 c9                 xor    %ecx,%ecx</span><br><span class="line">  201a22: 49 89 c9              mov    %rcx,%r9</span><br><span class="line">  201a25: 49 f7 d1              not    %r9</span><br><span class="line">  201a28: 4d 01 c1              add    %r8,%r9</span><br><span class="line">  201a2b: 4d 89 c2              mov    %r8,%r10</span><br><span class="line">  201a2e: 49 83 e2 03           and    <span class="variable">$0x3</span>,%r10</span><br><span class="line">  201a32: 74 1f                 je     201a53 &lt;_Z3sumPiS_S_i+0x43&gt;</span><br><span class="line">  201a34: 66 2e 0f 1f 84 00 00  nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  201a3b: 00 00 00 </span><br><span class="line">  201a3e: 66 90                 xchg   %ax,%ax</span><br><span class="line">  201a40: 8b 04 8e              mov    (%rsi,%rcx,4),%eax</span><br><span class="line">  201a43: 03 04 8f              add    (%rdi,%rcx,4),%eax</span><br><span class="line">  201a46: 89 04 8a              mov    %eax,(%rdx,%rcx,4)</span><br><span class="line">  201a49: 48 83 c1 01           add    <span class="variable">$0x1</span>,%rcx</span><br><span class="line">  201a4d: 49 83 c2 ff           add    <span class="variable">$0xffffffffffffffff</span>,%r10</span><br><span class="line">  201a51: 75 ed                 jne    201a40 &lt;_Z3sumPiS_S_i+0x30&gt;</span><br><span class="line">  201a53: 49 83 f9 03           cmp    <span class="variable">$0x3</span>,%r9</span><br><span class="line">  201a57: 0f 82 3a 01 00 00     jb     201b97 &lt;_Z3sumPiS_S_i+0x187&gt;</span><br><span class="line">  201a5d: 0f 1f 00              nopl   (%rax)</span><br><span class="line">  201a60: 8b 04 8e              mov    (%rsi,%rcx,4),%eax</span><br><span class="line">  201a63: 03 04 8f              add    (%rdi,%rcx,4),%eax</span><br><span class="line">  201a66: 89 04 8a              mov    %eax,(%rdx,%rcx,4)</span><br><span class="line">  201a69: 8b 44 8e 04           mov    0x4(%rsi,%rcx,4),%eax</span><br><span class="line">  201a6d: 03 44 8f 04           add    0x4(%rdi,%rcx,4),%eax</span><br><span class="line">  201a71: 89 44 8a 04           mov    %eax,0x4(%rdx,%rcx,4)</span><br><span class="line">  201a75: 8b 44 8e 08           mov    0x8(%rsi,%rcx,4),%eax</span><br><span class="line">  201a79: 03 44 8f 08           add    0x8(%rdi,%rcx,4),%eax</span><br><span class="line">  201a7d: 89 44 8a 08           mov    %eax,0x8(%rdx,%rcx,4)</span><br><span class="line">  201a81: 8b 44 8e 0c           mov    0xc(%rsi,%rcx,4),%eax</span><br><span class="line">  201a85: 03 44 8f 0c           add    0xc(%rdi,%rcx,4),%eax</span><br><span class="line">  201a89: 89 44 8a 0c           mov    %eax,0xc(%rdx,%rcx,4)</span><br><span class="line">  201a8d: 48 83 c1 04           add    <span class="variable">$0x4</span>,%rcx</span><br><span class="line">  201a91: 49 39 c8              cmp    %rcx,%r8</span><br><span class="line">  201a94: 75 ca                 jne    201a60 &lt;_Z3sumPiS_S_i+0x50&gt;</span><br><span class="line">  201a96: e9 <span class="built_in">fc</span> 00 00 00        jmpq   201b97 &lt;_Z3sumPiS_S_i+0x187&gt;</span><br><span class="line">  201a9b: 4a 8d 0c 82           lea    (%rdx,%r8,4),%rcx</span><br><span class="line">  201a9f: 4a 8d 04 87           lea    (%rdi,%r8,4),%rax</span><br><span class="line">  201aa3: 48 39 d0              cmp    %rdx,%rax</span><br><span class="line">  201aa6: 41 0f 97 c2           seta   %r10b</span><br><span class="line">  201aaa: 4a 8d 04 86           lea    (%rsi,%r8,4),%rax</span><br><span class="line">  201aae: 48 39 f9              cmp    %rdi,%rcx</span><br><span class="line">  201ab1: 41 0f 97 c3           seta   %r11b</span><br><span class="line">  201ab5: 48 39 d0              cmp    %rdx,%rax</span><br><span class="line">  201ab8: 0f 97 c0              seta   %al</span><br><span class="line">  201abb: 48 39 f1              cmp    %rsi,%rcx</span><br><span class="line">  201abe: 41 0f 97 c1           seta   %r9b</span><br><span class="line">  201ac2: 31 c9                 xor    %ecx,%ecx</span><br><span class="line">  201ac4: 45 84 da              <span class="built_in">test</span>   %r11b,%r10b</span><br><span class="line">  201ac7: 0f 85 55 ff ff ff     jne    201a22 &lt;_Z3sumPiS_S_i+0x12&gt;</span><br><span class="line">  201acd: 44 20 c8              and    %r9b,%al</span><br><span class="line">  201ad0: 0f 85 4c ff ff ff     jne    201a22 &lt;_Z3sumPiS_S_i+0x12&gt;</span><br><span class="line">  201ad6: 44 89 c1              mov    %r8d,%ecx</span><br><span class="line">  201ad9: 83 e1 f8              and    <span class="variable">$0xfffffff8</span>,%ecx</span><br><span class="line">  201adc: 48 8d 41 f8           lea    -0x8(%rcx),%rax</span><br><span class="line">  201ae0: 49 89 c1              mov    %rax,%r9</span><br><span class="line">  201ae3: 49 c1 e9 03           shr    <span class="variable">$0x3</span>,%r9</span><br><span class="line">  201ae7: 49 83 c1 01           add    <span class="variable">$0x1</span>,%r9</span><br><span class="line">  201aeb: 48 85 c0              <span class="built_in">test</span>   %rax,%rax</span><br><span class="line">  201aee: 0f 84 a4 00 00 00     je     201b98 &lt;_Z3sumPiS_S_i+0x188&gt;</span><br><span class="line">  201af4: 4d 89 ca              mov    %r9,%r10</span><br><span class="line">  201af7: 49 83 e2 fe           and    <span class="variable">$0xfffffffffffffffe</span>,%r10</span><br><span class="line">  201afb: 49 f7 da              neg    %r10</span><br><span class="line">  201afe: 31 c0                 xor    %eax,%eax</span><br><span class="line">  201b00: f3 0f 6f 04 87        movdqu (%rdi,%rax,4),%xmm0</span><br><span class="line">  201b05: f3 0f 6f 4c 87 10     movdqu 0x10(%rdi,%rax,4),%xmm1</span><br><span class="line">  201b0b: f3 0f 6f 14 86        movdqu (%rsi,%rax,4),%xmm2</span><br><span class="line">  201b10: 66 0f fe d0           paddd  %xmm0,%xmm2</span><br><span class="line">  201b14: f3 0f 6f 44 86 10     movdqu 0x10(%rsi,%rax,4),%xmm0</span><br><span class="line">  201b1a: 66 0f fe c1           paddd  %xmm1,%xmm0</span><br><span class="line">  201b1e: f3 0f 7f 14 82        movdqu %xmm2,(%rdx,%rax,4)</span><br><span class="line">  201b23: f3 0f 7f 44 82 10     movdqu %xmm0,0x10(%rdx,%rax,4)</span><br><span class="line">  201b29: f3 0f 6f 44 87 20     movdqu 0x20(%rdi,%rax,4),%xmm0</span><br><span class="line">  201b2f: f3 0f 6f 4c 87 30     movdqu 0x30(%rdi,%rax,4),%xmm1</span><br><span class="line">  201b35: f3 0f 6f 54 86 20     movdqu 0x20(%rsi,%rax,4),%xmm2</span><br><span class="line">  201b3b: 66 0f fe d0           paddd  %xmm0,%xmm2</span><br><span class="line">  201b3f: f3 0f 6f 44 86 30     movdqu 0x30(%rsi,%rax,4),%xmm0</span><br><span class="line">  201b45: 66 0f fe c1           paddd  %xmm1,%xmm0</span><br><span class="line">  201b49: f3 0f 7f 54 82 20     movdqu %xmm2,0x20(%rdx,%rax,4)</span><br><span class="line">  201b4f: f3 0f 7f 44 82 30     movdqu %xmm0,0x30(%rdx,%rax,4)</span><br><span class="line">  201b55: 48 83 c0 10           add    <span class="variable">$0x10</span>,%rax</span><br><span class="line">  201b59: 49 83 c2 02           add    <span class="variable">$0x2</span>,%r10</span><br><span class="line">  201b5d: 75 a1                 jne    201b00 &lt;_Z3sumPiS_S_i+0xf0&gt;</span><br><span class="line">  201b5f: 41 f6 c1 01           <span class="built_in">test</span>   <span class="variable">$0x1</span>,%r9b</span><br><span class="line">  201b63: 74 29                 je     201b8e &lt;_Z3sumPiS_S_i+0x17e&gt;</span><br><span class="line">  201b65: f3 0f 6f 04 87        movdqu (%rdi,%rax,4),%xmm0</span><br><span class="line">  201b6a: f3 0f 6f 4c 87 10     movdqu 0x10(%rdi,%rax,4),%xmm1</span><br><span class="line">  201b70: f3 0f 6f 14 86        movdqu (%rsi,%rax,4),%xmm2</span><br><span class="line">  201b75: 66 0f fe d0           paddd  %xmm0,%xmm2</span><br><span class="line">  201b79: f3 0f 6f 44 86 10     movdqu 0x10(%rsi,%rax,4),%xmm0</span><br><span class="line">  201b7f: 66 0f fe c1           paddd  %xmm1,%xmm0</span><br><span class="line">  201b83: f3 0f 7f 14 82        movdqu %xmm2,(%rdx,%rax,4)</span><br><span class="line">  201b88: f3 0f 7f 44 82 10     movdqu %xmm0,0x10(%rdx,%rax,4)</span><br><span class="line">  201b8e: 4c 39 c1              cmp    %r8,%rcx</span><br><span class="line">  201b91: 0f 85 8b fe ff ff     jne    201a22 &lt;_Z3sumPiS_S_i+0x12&gt;</span><br><span class="line">  201b97: c3                    retq   </span><br><span class="line">  201b98: 31 c0                 xor    %eax,%eax</span><br><span class="line">  201b9a: 41 f6 c1 01           <span class="built_in">test</span>   <span class="variable">$0x1</span>,%r9b</span><br><span class="line">  201b9e: 75 c5                 jne    201b65 &lt;_Z3sumPiS_S_i+0x155&gt;</span><br><span class="line">  201ba0: eb ec                 jmp    201b8e &lt;_Z3sumPiS_S_i+0x17e&gt;</span><br><span class="line">  201ba2: cc                    int3   </span><br><span class="line"></span><br><span class="line">0000000000201bb0 &lt;_Z3kooi&gt;:</span><br><span class="line">  201bb0: 8d 47 06              lea    0x6(%rdi),%eax</span><br><span class="line">  201bb3: c3                    retq   </span><br></pre></td></tr></table></figure>

<h2 id="PGO（Profile-Guided-Optimization）"><a href="#PGO（Profile-Guided-Optimization）" class="headerlink" title="PGO（Profile-Guided Optimization）"></a>PGO（Profile-Guided Optimization）</h2><p>PGO（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Profile-guided_optimization">Profile-Guided Optimization</a>）也称 FDO（Feedback Directed Optimization），指通过工具采集程序运行时的 profile 数据，用以在重新编译流程中优化程序。</p>
<ul>
<li>FDO 的方案普遍被大厂用于优化数据中心的应用</li>
<li>TiFlash 中支持 PGO：<a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/pull/5160">PR#5160</a></li>
</ul>
<p>根据 <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/UsersManual.html#profile-guided-optimization">llvm&#x2F;docs&#x2F;profile-guided-optimization</a>，LLVM 的 PGO 主要分为 2 种：</p>
<ul>
<li>代码插桩（<a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/UsersManual.html#profiling-with-instrumentation">Profiling with Instrumentation</a>）<ul>
<li>增加编译参数 <code>-fprofile-instr-generate</code></li>
<li>运行特定的 benchmark 负载，令程序自动采集 profile 数据（缺点是程序运行较慢）</li>
<li>重新编译时指定 profile 数据 <code>-fprofile-instr-use=&lt;xxx.profdata&gt;</code></li>
</ul>
</li>
<li>运行时采样（<a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/UsersManual.html#using-sampling-profilers">Using Sampling Profilers</a>）<ul>
<li>增加编译参数 <code>-gline-tables-only -fdebug-info-for-profiling -funique-internal-linkage-names</code>，增加链接参数 <code>-Wl,--no-rosegment</code></li>
<li>正常部署运行程序，利用 <a target="_blank" rel="noopener" href="https://perf.wiki.kernel.org/index.php/Main_Page">Linux Perf profiler</a> 采集实际负载下的 perf 数据<ul>
<li>较为推荐在支持 LBR（Last Branch Record）的平台上使用 -b 参数令 Perf 记录调用链信息，从而提升 perf 数据的精度</li>
</ul>
</li>
<li>利用 <a target="_blank" rel="noopener" href="https://github.com/google/autofdo">AutoFDO</a> 将 perf 数据转换为 LLVM 格式的 profile 数据</li>
<li>重新编译时指定 profile 数据 <code>-fprofile-sample-use=&lt;profile.prof&gt;</code></li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">perf record -p &lt;pid&gt; -e cycles:up -j any,u -a -o &lt;perf.data&gt; -- <span class="built_in">sleep</span> 180</span><br><span class="line">perf record -e cycles:u -j any,u -o &lt;perf.data&gt; -- &lt;executable&gt; &lt;args&gt; ...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create_llvm_prof --profile &lt;perf.data&gt; --binary &lt;binary&gt; --out=&lt;profile.prof&gt;</span><br></pre></td></tr></table></figure>

<p><strong>采用代码插桩的方式对程序性能有较大影响，且无法采集真实环境数据，所以在实践中较为推荐运行时采样，即程序发布后采集线上真实 profile 数据并依此迭代更新（类似 Java 的运行时优化）。</strong></p>
<h3 id="案例（7-0）"><a href="#案例（7-0）" class="headerlink" title="案例（7.0）"></a>案例（7.0）</h3><p>该案例中虚函数 <code>Extend::foo</code> 被调用的频率明显高于 <code>Base::foo</code>，正常的 O3 优化可以按照一定的步长展开循环，但无法在运行时预测分支。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fdo-test.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> &amp; x)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        x += <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Extend</span> : Base</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> &amp; x)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        x += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;Base&gt; a;</span><br><span class="line">    std::vector&lt;Extend&gt; b;</span><br><span class="line">    std::vector&lt;Base *&gt; c;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            a.<span class="built_in">emplace_back</span>(Base&#123;&#125;);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">100</span>; ++j)</span><br><span class="line">            &#123;</span><br><span class="line">                b.<span class="built_in">emplace_back</span>(Extend&#123;&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; x : a)</span><br><span class="line">            c.<span class="built_in">emplace_back</span>(&amp;x);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; x : b)</span><br><span class="line">            c.<span class="built_in">emplace_back</span>(&amp;x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> start = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; ++i)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; x : c)</span><br><span class="line">            &#123;</span><br><span class="line">                x-&gt;<span class="built_in">foo</span>(res);</span><br><span class="line">            &#125;</span><br><span class="line">        std::<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, res);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> end = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    std::<span class="built_in">printf</span>(<span class="string">&quot;time cost %lld ms\n&quot;</span>, std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(end - start).<span class="built_in">count</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clang ./fdo-test.cpp -O3 -lstdc++ -Wl,--no-rosegment -gline-tables-only -fdebug-info-for-profiling -funique-internal-linkage-names -o ori.out -flto=thin -fvisibility=hidden -fvisibility-inlines-hidden -fwhole-program-vtables -fsplit-lto-unit -DNDEBUG -fuse-ld=lld -Rpass &gt;pass.ori 2&gt;&amp;1</span><br><span class="line">perf record -e cycles:up -j any,u -a -o test-perf.data -- ./ori.out</span><br><span class="line">create_llvm_prof --profile test-perf.data --binary ./ori.out --out=test.prof</span><br><span class="line">clang ./fdo-test.cpp -O3 -lstdc++ -Wl,--no-rosegment -gline-tables-only -fdebug-info-for-profiling -funique-internal-linkage-names -flto=thin -fvisibility=hidden -fvisibility-inlines-hidden -fwhole-program-vtables -fsplit-lto-unit -DNDEBUG -o fdo.out -fprofile-sample-use=./test.prof -fuse-ld=lld -Rpass &gt;pass.new 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>FDO 优化效果：编译器根据虚函数调用频率执行 <code>Promote indirect call</code> 优化，实现去虚拟化。</p>
<ul>
<li>2012d8: 对比虚函数地址和 <code>&lt;_ZN6Extend3fooERi&gt;</code> 函数地址是否相同</li>
<li>2012de: 如果比较相同则直接跳转到 <code>2012c0</code></li>
<li>2012c0: 内联实现 <code>&lt;_ZN6Extend3fooERi&gt;</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./ori.out</span><br><span class="line">990000000</span><br><span class="line">time cost 2688 ms</span><br><span class="line"></span><br><span class="line">./fdo.out</span><br><span class="line">990000000</span><br><span class="line">time cost 2581 ms</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pass.new</span></span><br><span class="line">./fdo-test.cpp:48:20: Promote indirect call to _ZN6Extend3fooERi with count 63471 out of 64151</span><br><span class="line"></span><br><span class="line"><span class="comment"># objdump -d fdo.out</span></span><br><span class="line">...</span><br><span class="line">  201293:       e8 48 08 00 00          callq  201ae0 &lt;_ZNSt3__16chrono12steady_clock3nowEv@plt&gt;</span><br><span class="line">  201298:       49 89 c6                mov    %rax,%r14</span><br><span class="line">  20129b:       c7 44 24 20 00 00 00    movl   <span class="variable">$0x0</span>,0x20(%rsp)</span><br><span class="line">  2012a2:       00 </span><br><span class="line">  2012a3:       48 8b 2c 24             mov    (%rsp),%rbp</span><br><span class="line">  2012a7:       48 8b 5c 24 08          mov    0x8(%rsp),%rbx</span><br><span class="line">  2012ac:       48 39 <span class="built_in">dd</span>                cmp    %rbx,%rbp</span><br><span class="line">  2012af:       0f 84 ec 00 00 00       je     2013a1 &lt;main+0x471&gt;</span><br><span class="line">  2012b5:       45 31 ff                xor    %r15d,%r15d</span><br><span class="line">  2012b8:       4c 8d 64 24 20          lea    0x20(%rsp),%r12</span><br><span class="line">  2012bd:       eb 0a                   jmp    2012c9 &lt;main+0x399&gt;</span><br><span class="line">  2012bf:       90                      nop</span><br><span class="line">  2012c0:       83 44 24 20 01          addl   <span class="variable">$0x1</span>,0x20(%rsp)</span><br><span class="line">  2012c5:       48 83 c5 08             add    <span class="variable">$0x8</span>,%rbp</span><br><span class="line">  2012c9:       48 39 <span class="built_in">dd</span>                cmp    %rbx,%rbp</span><br><span class="line">  2012cc:       74 1d                   je     2012eb &lt;main+0x3bb&gt;</span><br><span class="line">  2012ce:       48 8b 7d 00             mov    0x0(%rbp),%rdi</span><br><span class="line">  2012d2:       48 8b 07                mov    (%rdi),%rax</span><br><span class="line">  2012d5:       48 8b 00                mov    (%rax),%rax</span><br><span class="line">  2012d8:       48 3d 10 1a 20 00       cmp    <span class="variable">$0x201a10</span>,%rax</span><br><span class="line">  2012de:       74 e0                   je     2012c0 &lt;main+0x390&gt;</span><br><span class="line">  2012e0:       4c 89 e6                mov    %r12,%rsi</span><br><span class="line">  2012e3:       ff d0                   callq  *%rax</span><br><span class="line">  2012e5:       48 83 c5 08             add    <span class="variable">$0x8</span>,%rbp</span><br><span class="line">  2012e9:       eb de                   jmp    2012c9 &lt;main+0x399&gt;</span><br><span class="line">  2012eb:       41 83 c7 01             add    <span class="variable">$0x1</span>,%r15d</span><br><span class="line">  2012ef:       41 81 ff a0 86 01 00    cmp    <span class="variable">$0x186a0</span>,%r15d</span><br><span class="line">  2012f6:       74 0b                   je     201303 &lt;main+0x3d3&gt;</span><br><span class="line">  2012f8:       48 8b 2c 24             mov    (%rsp),%rbp</span><br><span class="line">  2012fc:       48 8b 5c 24 08          mov    0x8(%rsp),%rbx</span><br><span class="line">  201301:       eb c6                   jmp    2012c9 &lt;main+0x399&gt;</span><br><span class="line">  201303:       8b 74 24 20             mov    0x20(%rsp),%esi</span><br><span class="line">  201307:       bf af 0a 20 00          mov    <span class="variable">$0x200aaf</span>,%edi</span><br><span class="line">  20130c:       31 c0                   xor    %eax,%eax</span><br><span class="line">  20130e:       e8 <span class="built_in">dd</span> 07 00 00          callq  201af0 &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">  201313:       e8 c8 07 00 00          callq  201ae0 &lt;_ZNSt3__16chrono12steady_clock3nowEv@plt&gt;</span><br><span class="line">...</span><br><span class="line">0000000000201a10 &lt;_ZN6Extend3fooERi&gt;:</span><br><span class="line">  201a10:       ff 06                   incl   (%rsi)</span><br><span class="line">  201a12:       c3                      retq   </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="案例（7-1）"><a href="#案例（7-1）" class="headerlink" title="案例（7.1）"></a>案例（7.1）</h3><blockquote>
<p>详见 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/pull/5160">tiflash#5160</a></p>
</blockquote>
<p>TiFlash 以 commit <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/commit/5b61ae70550624d3bf0b5ca6bac89013ed5a6a4b">5b61ae70550624d3bf0b5ca6bac89013ed5a6a4b</a> 为例</p>
<ul>
<li>测试工具为 <a target="_blank" rel="noopener" href="https://github.com/pingcap/go-tpc/blob/69c6de2bd5157131427f6a31e083a1767a59002f/tpch/query.go">go-tpc</a>，并以 tpch 负载用于 perf 采样和优化验证</li>
<li><strong>单节点</strong> tpch 10G 数据</li>
<li>通过 cgroup 限制程序最多使用 5 核</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /sys/fs/cgroup/cpu/pgo_test</span><br><span class="line">lsof -i:9000 | grep <span class="string">&#x27;TiFlash&#x27;</span> | grep -v <span class="string">&#x27;grep&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> &gt; /sys/fs/cgroup/cpu/pgo_test/cgroup.procs</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;500000&quot;</span> &gt; /sys/fs/cgroup/cpu/pgo_test/cpu.cfs_quota_us</span><br></pre></td></tr></table></figure>

<p>测试结果显示，对于重计算的场景例如 Q1，FDO+LTO 比起 LTO 的性能提升为 8.98%，相对于未做任何优化的版本提升 13.46%。Q13、Q18 之类的查询也因为聚合&#x2F;过滤等计算占比较大获得一定的收益。而其他查询受计算模式中资源调度、数据瓶颈等因素影响存在一定的波动，优化效果不如 Q1 那么明显。</p>
<table>
<thead>
<tr>
<th>Time Cost(s)</th>
<th>original</th>
<th>LTO</th>
<th>FDO+LTO</th>
<th></th>
<th>FDO+LTO : LTO</th>
<th>FDO+LTO : original</th>
</tr>
</thead>
<tbody><tr>
<td>Q1</td>
<td>6.32</td>
<td>6.07</td>
<td>5.57</td>
<td></td>
<td>8.98%</td>
<td>13.46%</td>
</tr>
<tr>
<td>Q2</td>
<td>2.99</td>
<td>2.99</td>
<td>2.92</td>
<td></td>
<td>2.40%</td>
<td>2.40%</td>
</tr>
<tr>
<td>Q3</td>
<td>2.79</td>
<td>2.65</td>
<td>2.65</td>
<td></td>
<td>0.00%</td>
<td>5.28%</td>
</tr>
<tr>
<td>Q4</td>
<td>1.91</td>
<td>2.05</td>
<td>1.85</td>
<td></td>
<td>10.81%</td>
<td>3.24%</td>
</tr>
<tr>
<td>Q6</td>
<td>0.91</td>
<td>0.91</td>
<td>0.84</td>
<td></td>
<td>8.33%</td>
<td>8.33%</td>
</tr>
<tr>
<td>Q7</td>
<td>2.38</td>
<td>2.32</td>
<td>2.32</td>
<td></td>
<td>0.00%</td>
<td>2.59%</td>
</tr>
<tr>
<td>Q8</td>
<td>4.8</td>
<td>4.73</td>
<td>4.73</td>
<td></td>
<td>0.00%</td>
<td>1.48%</td>
</tr>
<tr>
<td>Q9</td>
<td>16.81</td>
<td>16.54</td>
<td>16.48</td>
<td></td>
<td>0.36%</td>
<td>2.00%</td>
</tr>
<tr>
<td>Q10</td>
<td>3.72</td>
<td>3.72</td>
<td>3.66</td>
<td></td>
<td>1.64%</td>
<td>1.64%</td>
</tr>
<tr>
<td>Q11</td>
<td>0.5</td>
<td>0.5</td>
<td>0.5</td>
<td></td>
<td>0.00%</td>
<td>0.00%</td>
</tr>
<tr>
<td>Q12</td>
<td>1.98</td>
<td>1.91</td>
<td>1.85</td>
<td></td>
<td>3.24%</td>
<td>7.03%</td>
</tr>
<tr>
<td>Q13</td>
<td>4.66</td>
<td>4.6</td>
<td>4.33</td>
<td></td>
<td>6.24%</td>
<td>7.62%</td>
</tr>
<tr>
<td>Q14</td>
<td>1.04</td>
<td>1.11</td>
<td>0.97</td>
<td></td>
<td>14.43%</td>
<td>7.22%</td>
</tr>
<tr>
<td>Q15</td>
<td>2.05</td>
<td>1.98</td>
<td>2.11</td>
<td></td>
<td>-6.16%</td>
<td>-2.84%</td>
</tr>
<tr>
<td>Q16</td>
<td>1.04</td>
<td>1.04</td>
<td>0.97</td>
<td></td>
<td>7.22%</td>
<td>7.22%</td>
</tr>
<tr>
<td>Q17</td>
<td>5.67</td>
<td>5.8</td>
<td>5.67</td>
<td></td>
<td>2.29%</td>
<td>0.00%</td>
</tr>
<tr>
<td>Q18</td>
<td>8.62</td>
<td>8.41</td>
<td>7.99</td>
<td></td>
<td>5.26%</td>
<td>7.88%</td>
</tr>
<tr>
<td>Q19</td>
<td>3.12</td>
<td>3.05</td>
<td>3.05</td>
<td></td>
<td>0.00%</td>
<td>2.30%</td>
</tr>
<tr>
<td>Q20</td>
<td>1.58</td>
<td>1.58</td>
<td>1.64</td>
<td></td>
<td>-3.66%</td>
<td>-3.66%</td>
</tr>
<tr>
<td>Q21</td>
<td>2.99</td>
<td>2.85</td>
<td>2.89</td>
<td></td>
<td>-1.38%</td>
<td>3.46%</td>
</tr>
<tr>
<td>Q22</td>
<td>0.64</td>
<td>0.64</td>
<td>0.5</td>
<td></td>
<td>28.00%</td>
<td>28.00%</td>
</tr>
</tbody></table>
<hr>
<p>3 节点跑 TPCH-100，限制每个节点 CPU 使用上限 1000%，结果如下</p>
<table>
<thead>
<tr>
<th>Time Cost(s)</th>
<th>LTO</th>
<th>FDO+LTO</th>
<th>FDO+LTO : LTO</th>
</tr>
</thead>
<tbody><tr>
<td>Q1</td>
<td>12.08</td>
<td>11.04</td>
<td>9.42%</td>
</tr>
<tr>
<td>Q2</td>
<td>4.33</td>
<td>4.26</td>
<td>1.64%</td>
</tr>
<tr>
<td>Q3</td>
<td>8.22</td>
<td>8.09</td>
<td>1.61%</td>
</tr>
<tr>
<td>Q4</td>
<td>21.17</td>
<td>21.64</td>
<td>-2.17%</td>
</tr>
<tr>
<td>Q5</td>
<td>19.36</td>
<td>19.83</td>
<td>-2.37%</td>
</tr>
<tr>
<td>Q6</td>
<td>1.91</td>
<td>1.85</td>
<td>3.24%</td>
</tr>
<tr>
<td>Q7</td>
<td>9.83</td>
<td>9.97</td>
<td>-1.40%</td>
</tr>
<tr>
<td>Q8</td>
<td>11.98</td>
<td>11.58</td>
<td>3.45%</td>
</tr>
<tr>
<td>Q9</td>
<td>65.26</td>
<td>64.32</td>
<td>1.46%</td>
</tr>
<tr>
<td>Q10</td>
<td>10.57</td>
<td>10.37</td>
<td>1.93%</td>
</tr>
<tr>
<td>Q11</td>
<td>2.05</td>
<td>2.05</td>
<td>0.00%</td>
</tr>
<tr>
<td>Q12</td>
<td>5.2</td>
<td>5.27</td>
<td>-1.33%</td>
</tr>
<tr>
<td>Q13</td>
<td>12.72</td>
<td>12.11</td>
<td>5.04%</td>
</tr>
<tr>
<td>Q14</td>
<td>2.18</td>
<td>2.11</td>
<td>3.32%</td>
</tr>
<tr>
<td>Q15</td>
<td>4.13</td>
<td>4.06</td>
<td>1.72%</td>
</tr>
<tr>
<td>Q16</td>
<td>2.32</td>
<td>2.25</td>
<td>3.11%</td>
</tr>
<tr>
<td>Q17</td>
<td>18.29</td>
<td>18.22</td>
<td>0.38%</td>
</tr>
<tr>
<td>Q18</td>
<td>23.12</td>
<td>22.85</td>
<td>1.18%</td>
</tr>
<tr>
<td>Q19</td>
<td>5.87</td>
<td>5.74</td>
<td>2.26%</td>
</tr>
<tr>
<td>Q20</td>
<td>4.06</td>
<td>4.13</td>
<td>-1.69%</td>
</tr>
<tr>
<td>Q21</td>
<td>39.02</td>
<td>39.29</td>
<td>-0.69%</td>
</tr>
<tr>
<td>Q22</td>
<td>1.38</td>
<td>1.31</td>
<td>5.34%</td>
</tr>
</tbody></table>
<p>除了 Q1，其他查询或多或少涉及到资源调度和等待，测试过程中无法全程打满 CPU，提升效果不如 Q1 那么明显。</p>
<h2 id="Post-link-Optimizer"><a href="#Post-link-Optimizer" class="headerlink" title="Post-link Optimizer"></a>Post-link Optimizer</h2><p>TBD</p>
<h2 id="编译缓存"><a href="#编译缓存" class="headerlink" title="编译缓存"></a>编译缓存</h2><p><a target="_blank" rel="noopener" href="https://ccache.dev/">Ccache</a> 作为一种编译器缓存用于加速重编译过程。<a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/eaf1a4cf886d1d5a86d04ef14eff956778ab4911/cmake/find_ccache.cmake">tiflash&#x2F;cmake&#x2F;find_ccache.cmake</a> 也默认开启这一优化项来加速 CI 流程。C++ 的特性决定了头文件耦合程度会大幅影响编译缓存命中率，所以问题的核心又回到了 <a href="#%E5%A4%B4%E6%96%87%E4%BB%B6%E4%BC%98%E5%8C%96">头文件优化</a>。</p>
<p>根据文档 <a target="_blank" rel="noopener" href="https://ccache.dev/manual/3.2.4.html#_precompiled_headers">CCACHE - Precompiled headers</a>，ccache 配合 PCH 一起使用时，需要注意设置参数 <code>sloppiness=pch_defines,time_macros</code>。<br>在实践中，我们发现 ccache 默认处理 PCH 时会判断相关文件的修改时间，当 PCH 中包含编译期生成的代码时（例如 protobuf ）会导致相关目标文件缓存失败，对此需要进行更细粒度的划分和针对性调整。</p>
<p><strong>就目前而言，ccache 主要用于日常开发以及 Pull Request 的 CI 流程（增量编译），PCH 则主要用于 release 编译（全量编译）。</strong></p>
<h1 id="社区｜新开发者如何参与优化-TiFlash-项目"><a href="#社区｜新开发者如何参与优化-TiFlash-项目" class="headerlink" title="社区｜新开发者如何参与优化 TiFlash 项目"></a>社区｜新开发者如何参与优化 TiFlash 项目</h1><ul>
<li>根据 <a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/2e8d324e76a2c5a96c83fdab8e7e08f3a5424d61/README.md">tiflash&#x2F;README.md</a> 中的指示部署基本编译环境。</li>
<li>设置 cmake 项：<ul>
<li><code>-DENABLE_TIME_TRACES=ON</code> 开启编译分析追踪</li>
<li><code>-DUSE_CCACHE=OFF</code> 禁用 ccache</li>
<li><code>-DENABLE_PCH=OFF</code> 禁用 PCH（目前先专注于优化头文件相关的开销）</li>
<li><code>-DCMAKE_BUILD_TYPE=RELWITHDEBINFO</code> 或 <code>-DCMAKE_BUILD_TYPE=DEBUG</code> 需分别优化 2 种编译模式下的各项指标</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prepare environment: llvm, rust</span></span><br><span class="line"><span class="comment"># clone https://github.com/pingcap/tiflash.git to $&#123;TIFLASH_WORKSPACE&#125;</span></span><br><span class="line"><span class="comment"># mkdir $&#123;TIFLASH_BUILD&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TIFLASH_BUILD&#125;</span></span><br><span class="line">CC=clang CXX=clang cmake \</span><br><span class="line">    -S <span class="variable">$&#123;TIFLASH_WORKSPACE&#125;</span> \</span><br><span class="line">    -DCMAKE_BUILD_TYPE=RELWITHDEBINFO \</span><br><span class="line">    -DLINKER_NAME=lld \</span><br><span class="line">    -DUSE_CCACHE=0 \</span><br><span class="line">    -DENABLE_TIME_TRACES=ON \</span><br><span class="line">    -DENABLE_PCH=0 \</span><br><span class="line">    -Wno-dev \</span><br><span class="line">    -DNO_WERROR=ON \</span><br><span class="line">    -GNinja</span><br><span class="line"></span><br><span class="line">time cmake --build . --target tiflash --parallel 5</span><br></pre></td></tr></table></figure>

<ul>
<li>编译后在 ${TIFLASH_BUILD} 中可获取每个目标文件的编译期火焰图</li>
<li>参考 <a href="#%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">编译流程分析</a> 编译部署 <a target="_blank" rel="noopener" href="https://github.com/aras-p/ClangBuildAnalyzer">ClangBuildAnalyzer</a>，并用其分析 ${TIFLASH_BUILD}<ul>
<li>ClangBuildAnalyzer 的配置文件为 <a target="_blank" rel="noopener" href="https://github.com/aras-p/ClangBuildAnalyzer/blob/main/ClangBuildAnalyzer.ini">ClangBuildAnalyzer.ini</a>，可根据官方文档调整参数</li>
</ul>
</li>
<li>保存 ClangBuildAnalyzer 生成的中间文件和分析结果，作为对照组</li>
<li>根据 ClangBuildAnalyzer 分析结果，找出瓶颈点，参照上文进行优化</li>
<li><a target="_blank" rel="noopener" href="https://github.com/pingcap/tiflash/blob/0477f9658b83df75b8583d5ff3021634081775ce/CMakeLists.txt#L48">CMAKE_EXPORT_COMPILE_COMMANDS</a> 默认开启，可在文件 <code>$&#123;TIFLASH_BUILD&#125;/compile_commands.json</code> 中找到各个编译单元的执行命令。<ul>
<li>每次修改后，找到关联源文件的编译命令并手动执行，分析编译时的火焰图</li>
<li>可安装 <a target="_blank" rel="noopener" href="https://github.com/include-what-you-use/include-what-you-use">include-what-you-use</a> 后用 <a target="_blank" rel="noopener" href="https://github.com/include-what-you-use/include-what-you-use/blob/3ad4d9b058f33b858d74aaaa78b951005f82fec5/iwyu_tool.py">iwyu_tool.py</a> 辅助。其中存在误报，需人工排查。<ul>
<li>例如 <code>iwyu_tool.py -p $&#123;TIFLASH_BUILD&#125; $&#123;TIFLASH_WORKSPACE&#125;/dbms/src/Storages/Transaction/TMTContext.cpp</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="优化目标"><a href="#优化目标" class="headerlink" title="优化目标"></a>优化目标</h2><ul>
<li>编译前端耗时相对后端需尽可能小于 10%</li>
<li>令每个源文件编译耗时相对平均</li>
<li>降低总体编译耗时</li>
<li>优化 &amp; 规范代码质量</li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a target="_blank" rel="noopener" href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines">isocpp&#x2F;CppCoreGuidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://google.github.io/styleguide/cppguide.html#Forward_Declarations">Google C++ Style Guide</a></li>
<li>待补充</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/TiFlash/" rel="tag"># TiFlash</a>
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/Compiler/" rel="tag"># Compiler</a>
              <a href="/tags/CompilerFrontend/" rel="tag"># CompilerFrontend</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/04/01/ProjectManagement/tiflash-open-source/" rel="prev" title="TiFlash 项目开源历程">
                  <i class="fa fa-chevron-left"></i> TiFlash 项目开源历程
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/26/pingcap/database-collation-optimization/" rel="next" title="Database Collation Optimization In TiDB | TiFlash">
                  Database Collation Optimization In TiDB | TiFlash <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TONG, Zhigao</span>
</div>

    </div>
  </footer>

  
  <script src="/lib/animejs/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/lib/hexo-generator-searchdb/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
